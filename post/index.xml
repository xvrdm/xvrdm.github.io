<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on Invalid Input</title>
    <link>/post/index.xml</link>
    <description>Recent content in Posts on Invalid Input</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Mon, 23 Oct 2017 00:00:00 +0000</lastBuildDate>
    <atom:link href="/post/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Socialize your blogdown</title>
      <link>/2017/10/23/socialize-your-blogdown/</link>
      <pubDate>Mon, 23 Oct 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/10/23/socialize-your-blogdown/</guid>
      <description>&lt;div id=&#34;tldr&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;TL;DR&lt;/h2&gt;
&lt;p&gt;In this post, we show how to modify the default bookdown template so that rich cards are generated when links are shared on Twitter. We also try to learn a bit of Blogdown/Hugo templating along the way.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/socialize-blogdown-social.png&#34; /&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;tags-and-twitter-tags&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Tags and Twitter Tags&lt;/h2&gt;
&lt;p&gt;Social &lt;code&gt;&amp;lt;meta&amp;gt;&lt;/code&gt; tags are &lt;code&gt;HTML&lt;/code&gt; tags at the top of your pages that social network and search engine can parse to extract content and generate rich previews.&lt;/p&gt;
&lt;p&gt;When the &lt;a href=&#34;https://twitter.com/rweekly_live&#34;&gt;R Weekly twitter account&lt;/a&gt; share a link pointing to a site without tags for Twitter cards, it looks like a plain url.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/20171023-socialize-blogdown-plain-tweet.png&#34; /&gt;

&lt;/div&gt;
&lt;p&gt;However, when they share a link pointing to a site with compatible meta tags, like &lt;a href=&#34;&#34;&gt;Bob Rudis’s&lt;/a&gt; blog, it doesn’t look like a plain url, but rather like this:&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/20171023-socialize-blogdown-rich-tweet.png&#34; /&gt;

&lt;/div&gt;
&lt;p&gt;The two big families of social graph meta tags are &lt;a href=&#34;https://developer.twitter.com/en/docs/tweets/optimize-with-cards/guides/getting-started&#34;&gt;Twitter’s &lt;code&gt;name=twitter:&amp;lt;tag-name&amp;gt;&lt;/code&gt;&lt;/a&gt; and &lt;a href=&#34;http://ogp.me/&#34;&gt;Facebook Open Graph’s &lt;code&gt;property=og:&amp;lt;tag-name&amp;gt;&lt;/code&gt;&lt;/a&gt;. Luckily, when Twitter doesn’t find a tag, it can use the corresponding Open Graph tag in some cases, so we don’t need to define everything twice (see &lt;a href=&#34;(https://developer.twitter.com/en/docs/tweets/optimize-with-cards/guides/getting-started)&#34;&gt;“Twitter Cards and Open Graph” here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If we look at the tags used in the example above, we see that a mix of &lt;code&gt;og:&lt;/code&gt; and &lt;code&gt;twitter:&lt;/code&gt; tags were used.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/20171023-socialize-blogdown-source-rudis.png&#34; /&gt;

&lt;/div&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;code&gt;og:image&lt;/code&gt;: link to the image&lt;/li&gt;
&lt;li&gt;&lt;code&gt;og:description&lt;/code&gt;: short description text&lt;/li&gt;
&lt;li&gt;&lt;code&gt;og:url&lt;/code&gt;: actual reference url&lt;/li&gt;
&lt;li&gt;&lt;code&gt;og:title&lt;/code&gt;: title for the page&lt;/li&gt;
&lt;li&gt;&lt;code&gt;twitter:card&lt;/code&gt;: type of the card&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div id=&#34;social-graph-tags-and-blogdown&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Social graph tags and blogdown&lt;/h2&gt;
&lt;div id=&#34;vanilla-blogdown&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Vanilla blogdown&lt;/h3&gt;
&lt;p&gt;This site is generated using the excellent &lt;a href=&#34;https://github.com/yihui/&#34;&gt;Yihui Xie’s&lt;/a&gt; &lt;a href=&#34;https://github.com/rstudio/blogdown&#34;&gt;blogdown&lt;/a&gt; package. It also use the default theme, a &lt;a href=&#34;https://github.com/yihui/hugo-lithium-theme&#34;&gt;fork&lt;/a&gt; of &lt;a href=&#34;https://github.com/jrutheiser&#34;&gt;Jonathan Rutheiser’s&lt;/a&gt; &lt;a href=&#34;https://github.com/jrutheiser/hugo-lithium-theme&#34;&gt;lithium-theme&lt;/a&gt; for &lt;a href=&#34;https://gohugo.io/&#34;&gt;Hugo&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The theme doesn’t fully implement the &lt;code&gt;&amp;lt;meta&amp;gt;&lt;/code&gt; tags necessary for creating cards on twitter. To see what tags are currently generated, we can check the template file &lt;code&gt;head.html&lt;/code&gt; in &lt;code&gt;themes/hugo-lithium-theme/layouts/partials/&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;...
{{ if eq .URL &amp;quot;/&amp;quot; }}
&amp;lt;title&amp;gt;{{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Site.Title }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:type&amp;quot; content=&amp;quot;website&amp;quot;&amp;gt;
{{ else }}
&amp;lt;title&amp;gt;{{ .Title }}{{ with .Params.subtitle }} - {{ . }} {{ end }} - {{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Title }} - {{ .Site.Title }}&amp;quot;&amp;gt;
{{ end }}

{{ if eq .URL &amp;quot;/&amp;quot; }}
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Site.Params.description }}&amp;quot;&amp;gt;
{{ else }}
  {{ if .Description }}
  &amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Description }}&amp;quot;&amp;gt;
  {{ end }}
{{ end }}
...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In addition to normal HTML, the template uses Hugo templating syntax elements to get dynamic html output (everything between double curly brackets):&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;a href=&#34;https://gohugo.io/variables/&#34;&gt;Hugo variables&lt;/a&gt; to gather data about the site and the post, or to create your own reusable variables. There are different types of variables:&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;variables starting with &lt;code&gt;.&lt;/code&gt; are defined in the top metadata of the page&lt;/li&gt;
&lt;li&gt;variables starting with &lt;code&gt;.Site&lt;/code&gt; are defined in the &lt;code&gt;config.toml&lt;/code&gt; file&lt;/li&gt;
&lt;li&gt;variables starting with &lt;code&gt;$&lt;/code&gt; are defined in the template&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I don’t enough about the details but it looks like the most common variable like &lt;code&gt;Title&lt;/code&gt; and &lt;code&gt;Description&lt;/code&gt; have “shortcuts” (i.e you access them simply with &lt;code&gt;.Title&lt;/code&gt;/&lt;code&gt;.Site.Title&lt;/code&gt; and &lt;code&gt;.Description&lt;/code&gt;), whereas other variable need &lt;code&gt;.Params&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;&amp;lt;!-- insert the title of the site between a &amp;lt;title&amp;gt; tag --&amp;gt;
&amp;lt;title&amp;gt;{{ .Site.Title }}&amp;lt;/title&amp;gt;

&amp;lt;!-- insert the title of the post between a &amp;lt;title&amp;gt; tag --&amp;gt;
&amp;lt;title&amp;gt;{{ .Title }}&amp;lt;/title&amp;gt;

&amp;lt;!-- insert the title stored in variable mytitle --&amp;gt;
{{ $defaultTitle := &amp;quot;This is a title&amp;quot; }}
&amp;lt;title&amp;gt;{{ $defaultTitle }}&amp;lt;/title&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;ol start=&#34;2&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;&lt;a href=&#34;https://gohugo.io/templates/introduction/#conditionals&#34;&gt;if/else conditional&lt;/a&gt; to add different tags depending on a condition.&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;&amp;lt;!-- if the relative url of the page is &amp;quot;/&amp;quot;, insert title &amp;quot;coconut&amp;quot; --&amp;gt;
{{ if eq .URL &amp;quot;/&amp;quot; }}
  &amp;lt;title&amp;gt;coconut&amp;lt;/title&amp;gt;
{{ end }}

&amp;lt;!-- if there is a &amp;quot;description&amp;quot; metadata on the post, insert it --&amp;gt;
&amp;lt;!-- in a &amp;quot;description&amp;quot; meta tag, otherwise insert default text --&amp;gt;
{{ if .Description }}
  &amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Description }}&amp;quot;&amp;gt;
{{ else }}
  &amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;Default description&amp;quot;&amp;gt;
{{ end }}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let’s deconstruct the Hugo templating syntax. I’ll keep it brief so, if it doesn’t make sense, &lt;a href=&#34;https://bookdown.org/yihui/blogdown/templates.html#a-minimal-example&#34;&gt;read this introduction&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If the page is the homepage (&lt;code&gt;{{ if eq .URL &amp;quot;/&amp;quot; }}&lt;/code&gt;):&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;{{ if eq .URL &amp;quot;/&amp;quot; }}
&amp;lt;title&amp;gt;{{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Site.Title }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:type&amp;quot; content=&amp;quot;website&amp;quot;&amp;gt;
{{ else }}
...
{{ end }}

{{ if eq .URL &amp;quot;/&amp;quot; }}
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Site.Params.description }}&amp;quot;&amp;gt;
{{ else }}
...
{{ end }}&lt;/code&gt;&lt;/pre&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Add a &lt;code&gt;og:title&lt;/code&gt; tag with the name of site (&lt;code&gt;.Site.Title&lt;/code&gt; refers to the &lt;code&gt;title&lt;/code&gt; key in &lt;code&gt;config.toml&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;Add a &lt;code&gt;og:type&lt;/code&gt; tag of type “website”.&lt;/li&gt;
&lt;li&gt;Add a &lt;code&gt;description&lt;/code&gt; tag with the description of the site (&lt;code&gt;.Site.Params.description&lt;/code&gt; refers to the &lt;code&gt;description&lt;/code&gt; key from the &lt;code&gt;params&lt;/code&gt; section defined in &lt;code&gt;config.toml&lt;/code&gt;)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;If the page is not the homepage:&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;{{ if eq .URL &amp;quot;/&amp;quot; }}
...
{{ else }}
&amp;lt;title&amp;gt;{{ .Title }}{{ with .Params.subtitle }} - {{ . }} {{ end }} - {{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Title }} - {{ .Site.Title }}&amp;quot;&amp;gt;
{{ end }}

{{ if eq .URL &amp;quot;/&amp;quot; }}
...
{{ else }}
  {{ if .Description }}
  &amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Description }}&amp;quot;&amp;gt;
  {{ end }}
{{ end }}&lt;/code&gt;&lt;/pre&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Add a &lt;code&gt;og:title&lt;/code&gt; tag with the name of the post (&lt;code&gt;.Title&lt;/code&gt; refers to the &lt;code&gt;title&lt;/code&gt; key at the top of the post) and the name of the site (&lt;code&gt;.Site.Title&lt;/code&gt; refers to the &lt;code&gt;title&lt;/code&gt; key in &lt;code&gt;config.toml&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;Only if a &lt;code&gt;description&lt;/code&gt; key is defined on the post, add it as &lt;code&gt;description&lt;/code&gt; key.&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div id=&#34;adding-tags&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Adding tags&lt;/h3&gt;
&lt;p&gt;We do have &lt;code&gt;og:title&lt;/code&gt;. We want to add:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;og:description&lt;/code&gt;: support for description, the current &lt;code&gt;description&lt;/code&gt; tag isn’t pulled as &lt;code&gt;og:description&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;twitter:creator&lt;/code&gt; and &lt;code&gt;twitter:site&lt;/code&gt;: twitter handles of the site/author&lt;/li&gt;
&lt;li&gt;&lt;code&gt;twitter:card&lt;/code&gt; and &lt;code&gt;og:image&lt;/code&gt;: the type of twitter card and image address&lt;/li&gt;
&lt;/ul&gt;
&lt;div id=&#34;post-description-with-ogdescription&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Post description with &lt;code&gt;og:description&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;In the current template, a &lt;code&gt;description&lt;/code&gt; tag is already added. Note that if there is no description for the post, no &lt;code&gt;description&lt;/code&gt; tag is added.&lt;/p&gt;
&lt;p&gt;We want (1) to add logic for &lt;code&gt;og:description&lt;/code&gt; tag and (2) to add a default description for when no description was written for the post.&lt;/p&gt;
&lt;div id=&#34;add-logic-for-ogdescription&#34; class=&#34;section level5&#34;&gt;
&lt;h5&gt;Add logic for &lt;code&gt;og:description&lt;/code&gt;&lt;/h5&gt;
&lt;p&gt;Rather than using the &lt;code&gt;{{ if eq .URL &amp;quot;/&amp;quot; }}&lt;/code&gt; twice we will wrap everything in the first &lt;code&gt;if&lt;/code&gt; statement.&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;{{ if eq .URL &amp;quot;/&amp;quot; }}
&amp;lt;title&amp;gt;{{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Site.Title }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:type&amp;quot; content=&amp;quot;website&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Site.Params.description }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:description&amp;quot; content=&amp;quot;{{ .Site.Params.description }}&amp;quot;&amp;gt;
{{ else }}
&amp;lt;title&amp;gt;{{ .Title }}{{ with .Params.subtitle }} - {{ . }} {{ end }} - {{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Title }} - {{ .Site.Title }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:type&amp;quot; content=&amp;quot;article&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Description }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:description&amp;quot; content=&amp;quot;{{ .Description }}&amp;quot;&amp;gt;
{{ end }}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;add-default-for-ogdescription&#34; class=&#34;section level5&#34;&gt;
&lt;h5&gt;Add default for &lt;code&gt;og:description&lt;/code&gt;&lt;/h5&gt;
&lt;p&gt;What happen if the post has no description? We could write an &lt;code&gt;if&lt;/code&gt; statement to check first if there is a &lt;code&gt;description&lt;/code&gt; key (&lt;code&gt;{{ if .Description }}...&lt;/code&gt;), but we can also provide a &lt;a href=&#34;https://gohugo.io/functions/default/&#34;&gt;&lt;code&gt;default&lt;/code&gt;&lt;/a&gt;, which goes like &lt;code&gt;{{ variable-name | default default-value }}&lt;/code&gt;. To avoid writing the &lt;code&gt;default-value&lt;/code&gt; twice (for tags &lt;code&gt;description&lt;/code&gt; and &lt;code&gt;og:description&lt;/code&gt;), we can store it in a &lt;a href=&#34;https://golang.org/pkg/text/template/#hdr-Variables&#34;&gt;Go template variable&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Below we create the &lt;code&gt;$defaultDescription&lt;/code&gt; variable, defined as a string “Article posted by &lt;author-name&gt;, on &lt;nicely-formated-date&gt;”. Then we add it as default for the tags &lt;code&gt;og:description&lt;/code&gt; and &lt;code&gt;description&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;{{ $defaultDescription := printf &amp;quot;Article posted by %s, on %s&amp;quot; .Params.author (.Date.Format &amp;quot;Monday, January 2nd, 2006&amp;quot;) }}
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Description | default $defaultDescription }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:description&amp;quot; content=&amp;quot;{{ .Description | default $defaultDescription }}&amp;quot;&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and in context:&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;{{ if eq .URL &amp;quot;/&amp;quot; }}
&amp;lt;title&amp;gt;{{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Site.Title }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:type&amp;quot; content=&amp;quot;website&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Site.Params.description }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:description&amp;quot; content=&amp;quot;{{ .Site.Params.description }}&amp;quot;&amp;gt;
{{ else }}
&amp;lt;title&amp;gt;{{ .Title }}{{ with .Params.subtitle }} - {{ . }} {{ end }} - {{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Title }} - {{ .Site.Title }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:type&amp;quot; content=&amp;quot;article&amp;quot;&amp;gt;
  
{{ $defaultDescription := printf &amp;quot;Article posted by %s, on %s&amp;quot; .Params.author (.Date.Format &amp;quot;Monday, January 2nd, 2006&amp;quot;) }}
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Description | default $defaultDescription }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:description&amp;quot; content=&amp;quot;{{ .Description | default $defaultDescription }}&amp;quot;&amp;gt;
{{ end }}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;twitter-creator-and-site&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Twitter creator and site&lt;/h4&gt;
&lt;p&gt;We could make twitter creator and site dependent of posts metadata if multiple authors were writing on your site. In this case, I just added two keys &lt;code&gt;twitterAuthor&lt;/code&gt; and &lt;code&gt;twitterSite&lt;/code&gt; into the &lt;code&gt;params&lt;/code&gt; section of &lt;code&gt;config.toml&lt;/code&gt; and used this for all posts (i.e outside of the if/else homepage conditional).&lt;/p&gt;
&lt;pre class=&#34;toml&#34;&gt;&lt;code&gt;# in config.toml
[params]
    description = &amp;quot;A datascience journal.&amp;quot;
    twitterAuthor = &amp;quot;@xvrdm&amp;quot;
    twitterSite = &amp;quot;@invalid_input&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and in the template:&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;&amp;lt;meta name=&amp;quot;twitter:creator&amp;quot; content=&amp;quot;{{ .Site.Params.twitterAuthor }}&amp;quot;&amp;gt;
&amp;lt;meta name=&amp;quot;twitter:site&amp;quot; content=&amp;quot;{{ .Site.Params.twitterSite }}&amp;quot;&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and in context:&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;{{ if eq .URL &amp;quot;/&amp;quot; }}
&amp;lt;title&amp;gt;{{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Site.Title }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:type&amp;quot; content=&amp;quot;website&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Site.Params.description }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:description&amp;quot; content=&amp;quot;{{ .Site.Params.description }}&amp;quot;&amp;gt;
{{ else }}
&amp;lt;title&amp;gt;{{ .Title }}{{ with .Params.subtitle }} - {{ . }} {{ end }} - {{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Title }} - {{ .Site.Title }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:type&amp;quot; content=&amp;quot;article&amp;quot;&amp;gt;
  
{{ $defaultDescription := printf &amp;quot;Article posted by %s, on %s&amp;quot; .Params.author (.Date.Format &amp;quot;Monday, January 2nd, 2006&amp;quot;) }}
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Description | default $defaultDescription }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:description&amp;quot; content=&amp;quot;{{ .Description | default $defaultDescription }}&amp;quot;&amp;gt;
{{ end }}

&amp;lt;meta name=&amp;quot;twitter:creator&amp;quot; content=&amp;quot;{{ .Site.Params.twitterAuthor }}&amp;quot;&amp;gt;
&amp;lt;meta name=&amp;quot;twitter:site&amp;quot; content=&amp;quot;{{ .Site.Params.twitterSite }}&amp;quot;&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;twitter-card-type-with-twittercard&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Twitter card type with &lt;code&gt;twitter:card&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;Three scenarios:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If the page is the homepage, we want to have a simple &lt;code&gt;summary&lt;/code&gt; card (small image) with the site logo as image.&lt;/li&gt;
&lt;li&gt;If the page is a post and has no image specified in its metadata, again a simple &lt;code&gt;summary&lt;/code&gt; card with the site logo as image.&lt;/li&gt;
&lt;li&gt;If the page is a post and has an image specified in its metadata, then let’s do a &lt;code&gt;summary_large_image&lt;/code&gt; card (image should be on a size ratio 2x1).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In the default template, the site logo is located in &lt;code&gt;https://&amp;lt;site-url&amp;gt;/images&lt;/code&gt; with a name defined in &lt;code&gt;config.toml&lt;/code&gt; (see the &lt;code&gt;params.logo&lt;/code&gt; section) and accessible via &lt;code&gt;.Site.params.logo.url&lt;/code&gt; variable.&lt;/p&gt;
&lt;p&gt;For images, I place them all in a dir called &lt;code&gt;img&lt;/code&gt; in &lt;code&gt;static&lt;/code&gt;. So I refer them in posts with &lt;code&gt;/img/myimagefile.jpg&lt;/code&gt;. At the top of the post, I can add a metadata key named &lt;code&gt;twitterImg&lt;/code&gt; and then refer to it in the template with &lt;code&gt;.Params.twitterImg&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;A post metadata could look like this:&lt;/p&gt;
&lt;pre class=&#34;yaml&#34;&gt;&lt;code&gt;title: &amp;quot;Create maps from SITG files with sf and ggplot2&amp;quot;
author: &amp;quot;Xavier Adam&amp;quot;
date: 2017-09-15
twitterImg: /img/map-ggplot-sf-social.img
categories: [&amp;quot;R&amp;quot;]
tags: [&amp;quot;R&amp;quot;,&amp;quot;RMarkdown&amp;quot;,&amp;quot;map&amp;quot;, &amp;quot;shape&amp;quot;, &amp;quot;sf&amp;quot;, &amp;quot;ggplot2&amp;quot;, &amp;quot;rmapshaper&amp;quot;]&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The template syntax would be something like:&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;{{ if eq .URL &amp;quot;/&amp;quot; }}
  &amp;lt;meta name=&amp;quot;twitter:card&amp;quot; content=&amp;quot;summary&amp;quot;&amp;gt;
  &amp;lt;meta name=&amp;quot;twitter:image&amp;quot; content=&amp;quot;http://xvrdm.github.io/images/{{ .Site.Params.logo.url }}&amp;quot; &amp;gt;
{{ else }}
  {{ if .Params.twitterImg }}
    &amp;lt;meta name=&amp;quot;twitter:card&amp;quot; content=&amp;quot;summary_large_image&amp;quot;&amp;gt;
    &amp;lt;meta name=&amp;quot;twitter:image&amp;quot; content=&amp;quot;http://xvrdm.github.io/{{ .Params.twitterImg }}&amp;quot; &amp;gt;
  {{ else }}
    &amp;lt;meta name=&amp;quot;twitter:card&amp;quot; content=&amp;quot;summary&amp;quot;&amp;gt;
    &amp;lt;meta name=&amp;quot;twitter:image&amp;quot; content=&amp;quot;http://xvrdm.github.io/images/{{ .Site.Params.logo.url }}&amp;quot; &amp;gt;
{{ end }}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and the final template:&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;{{ if eq .URL &amp;quot;/&amp;quot; }}
&amp;lt;title&amp;gt;{{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Site.Title }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:type&amp;quot; content=&amp;quot;website&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Site.Params.description }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:description&amp;quot; content=&amp;quot;{{ .Site.Params.description }}&amp;quot;&amp;gt;
&amp;lt;meta name=&amp;quot;twitter:card&amp;quot; content=&amp;quot;summary&amp;quot;&amp;gt;
&amp;lt;meta name=&amp;quot;twitter:image&amp;quot; content=&amp;quot;http://xvrdm.github.io/images/{{ .Site.Params.logo.url }}&amp;quot; &amp;gt;
{{ else }}
&amp;lt;title&amp;gt;{{ .Title }}{{ with .Params.subtitle }} - {{ . }} {{ end }} - {{ .Site.Title }}&amp;lt;/title&amp;gt;
&amp;lt;meta property=&amp;quot;og:title&amp;quot; content=&amp;quot;{{ .Title }} - {{ .Site.Title }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:type&amp;quot; content=&amp;quot;article&amp;quot;&amp;gt;

  {{ if .Params.twitterImg }}
  &amp;lt;meta name=&amp;quot;twitter:card&amp;quot; content=&amp;quot;summary_large_image&amp;quot;&amp;gt;
  &amp;lt;meta name=&amp;quot;twitter:image&amp;quot; content=&amp;quot;http://xvrdm.github.io/{{ .Params.twitterImg }}&amp;quot; &amp;gt;
  {{ else }}
  &amp;lt;meta name=&amp;quot;twitter:card&amp;quot; content=&amp;quot;summary&amp;quot;&amp;gt;
  &amp;lt;meta name=&amp;quot;twitter:image&amp;quot; content=&amp;quot;http://xvrdm.github.io/images/{{ .Site.Params.logo.url }}&amp;quot; &amp;gt;
  {{ end }}
  
{{ $defaultDescription := printf &amp;quot;Article posted by %s, on %s&amp;quot; .Params.author (.Date.Format &amp;quot;Monday, January 2nd, 2006&amp;quot;) }}
&amp;lt;meta property=&amp;quot;description&amp;quot; content=&amp;quot;{{ .Description | default $defaultDescription }}&amp;quot;&amp;gt;
&amp;lt;meta property=&amp;quot;og:description&amp;quot; content=&amp;quot;{{ .Description | default $defaultDescription }}&amp;quot;&amp;gt;
{{ end }}

&amp;lt;meta name=&amp;quot;twitter:creator&amp;quot; content=&amp;quot;{{ .Params.twitterAuthor }}&amp;quot;&amp;gt;
&amp;lt;meta name=&amp;quot;twitter:site&amp;quot; content=&amp;quot;{{ .Params.twitterSite }}&amp;quot;&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Using the &lt;a href=&#34;&#34;&gt;card validator&lt;/a&gt;, you can try your new cards:&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Create maps from SITG files with sf and ggplot2</title>
      <link>/2017/09/15/create-maps-from-sitg-files-with-sf-and-ggplot2/</link>
      <pubDate>Fri, 15 Sep 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/09/15/create-maps-from-sitg-files-with-sf-and-ggplot2/</guid>
      <description>&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;In Geneva (Switzerland), we are lucky to have &lt;a href=&#34;http://ge.ch/sitg/sitg_catalog/sitg_donnees?keyword&amp;amp;distribution=3&amp;amp;datatype=tous&amp;amp;topic=tous&amp;amp;service=tous&#34;&gt;SITG&lt;/a&gt;, a website with tons of geographical open datasets. I wanted to try my hand at doing maps in R for some time now, but could not find a way that felt integrated with the other packages I usually work with. Importing &lt;a href=&#34;https://en.wikipedia.org/wiki/Shapefile&#34;&gt;&lt;code&gt;.sh&lt;/code&gt;&lt;/a&gt; files was a challenge (for me), as well as plotting the data in &lt;a href=&#34;http://ggplot2.tidyverse.org/&#34;&gt;&lt;code&gt;ggplot2&lt;/code&gt;&lt;/a&gt; rather than with a dedicated map library like &lt;a href=&#34;https://cran.r-project.org/web/packages/tmap/vignettes/tmap-nutshell.html&#34;&gt;&lt;code&gt;tmap&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;All that changed with &lt;a href=&#34;http://r-spatial.github.io/sf/&#34;&gt;&lt;code&gt;sf&lt;/code&gt;&lt;/a&gt;, a package that implements &lt;a href=&#34;https://en.wikipedia.org/wiki/Simple_Features&#34;&gt;Simple Features&lt;/a&gt; for R. Full disclaimer: I know nothing about geographic information systems. All I can say is: if you are already using the &lt;a href=&#34;https://www.tidyverse.org/&#34;&gt;&lt;code&gt;tidyverse&lt;/code&gt;&lt;/a&gt;, &lt;code&gt;sf&lt;/code&gt; makes it really straightforward to convert geographical datasets to &lt;code&gt;data.frames/tibbles&lt;/code&gt; that you can then manipulate with your usual toolbox (&lt;code&gt;dplyr&lt;/code&gt;, &lt;code&gt;tidyr&lt;/code&gt;…). To learn more about the ecosystem of R packages for geocomputation, you could do worse than start &lt;a href=&#34;http://robinlovelace.net/geocompr/intro.html#rs-spatial-ecosystem&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;As I walked around Geneva countryside, I stumbled upon a &lt;a href=&#34;https://www.google.ch/maps/@46.1683766,6.068557,3a,75y,96.05h,82.7t/data=!3m8!1e1!3m6!1sAF1QipM5sKEBi_Ci70-Tl8I8cabW9Tu2rFtkiXDWLGUU!2e10!3e11!6shttps:%2F%2Flh5.googleusercontent.com%2Fp%2FAF1QipM5sKEBi_Ci70-Tl8I8cabW9Tu2rFtkiXDWLGUU%3Dw203-h100-k-no-pi-0-ya8.500008-ro-0-fo100!7i8704!8i4352?hl=en&#34;&gt;point of view&lt;/a&gt; with several information boards. One showed a little map that I thought would make a good first example.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/170915-photo-map-ggplot-sf.jpeg&#34; alt=&#34;Land use in Geneva, Switzerland&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Land use in Geneva, Switzerland&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;installing-sf&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Installing sf&lt;/h2&gt;
&lt;p&gt;If you already have all dependencies, it might be as straightforward as installing the package &lt;code&gt;sf&lt;/code&gt;. On Ubuntu, it was a bit of a pain, especially because I did not read the &lt;a href=&#34;https://github.com/r-spatial/sf#linux&#34;&gt;instructions first&lt;/a&gt;. After adding &lt;code&gt;libpng-dev&lt;/code&gt; on top of the other libraries, the &lt;code&gt;sf&lt;/code&gt; install worked in RStudio.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;planning-the-map&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Planning the map&lt;/h2&gt;
&lt;p&gt;Thinking in layers - like always with &lt;code&gt;ggplot2&lt;/code&gt; - it looks like we need the following things: 1. borders of each communal districts in Geneva 2. borders of water (lake and main rivers) 3. areas of buildings 4. areas of forests 5. areas of agricultural fields&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;mapping-communal-districts&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Mapping communal districts&lt;/h2&gt;
&lt;p&gt;The polygons of all Geneva communal districts are available &lt;a href=&#34;http://ge.ch/sitg/sitg_catalog/sitg_donnees?keyword=COMMUNES%20GENEVOISES%20%28GEOMETRIE%20SIMPLIFIEE%29&amp;amp;topic=tous&amp;amp;service=tous&amp;amp;datatype=tous&amp;amp;distribution=3&amp;amp;sort=auto&#34;&gt;here, named ‘COMMUNES GENEVOISES (GEOMETRIE SIMPLIFIEE)’&lt;/a&gt;)“. I downloaded the &lt;code&gt;SHP&lt;/code&gt; version. Make sure you place all the files (not just the &lt;code&gt;.shp&lt;/code&gt; and &lt;code&gt;.shx&lt;/code&gt;) in the same directory.&lt;code&gt;.shp&lt;/code&gt; and &lt;code&gt;.shx&lt;/code&gt; are enough to get the polygones, but you would miss all the metadata (like the names of the communes). Using &lt;code&gt;sf&lt;/code&gt; function &lt;code&gt;st_read&lt;/code&gt;, we can import them into R.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Load sf and dplyr quietly
suppressMessages(library(sf))
suppressMessages(library(dplyr))

# Load the communes dataset
communes  &amp;lt;- st_read(&amp;quot;../data/GEO_COMMUNES_GE_SIMPLIFIEES.shp&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Reading layer `GEO_COMMUNES_GE_SIMPLIFIEES&amp;#39; from data source `/home/xadam/dev/GitHub/ii_src/content/data/GEO_COMMUNES_GE_SIMPLIFIEES.shp&amp;#39; using driver `ESRI Shapefile&amp;#39;
## Simple feature collection with 48 features and 7 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: 2485410 ymin: 1109645 xmax: 2512974 ymax: 1135578
## epsg (SRID):    NA
## proj4string:    +proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +units=m +no_defs&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can see that the file was successfully loaded, and that we have 48 geometry (of type &lt;code&gt;MULTIPOLYGON&lt;/code&gt;) with 7 columns.&lt;/p&gt;
&lt;p&gt;Our usual dataframe functions (&lt;code&gt;dim&lt;/code&gt;, &lt;code&gt;names&lt;/code&gt;…) work on the &lt;code&gt;sf&lt;/code&gt; object. With &lt;code&gt;glimpse&lt;/code&gt; from &lt;code&gt;dplyr&lt;/code&gt;, we can get a sense of what each column contains (e.g &lt;code&gt;COMMUNE&lt;/code&gt; has the names of communes).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# a glimpse at the column content
glimpse(communes)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Observations: 48
## Variables: 8
## $ COMMUNE    &amp;lt;fctr&amp;gt; Corsier, Carouge, Puplinge, Perly-Certoux, Genève-...
## $ NO_COMM    &amp;lt;int&amp;gt; 19, 8, 39, 35, 22, 21, 28, 13, 41, 7, 29, 47, 33, 2...
## $ ABREVIATIO &amp;lt;fctr&amp;gt; Cr, Ca, Pu, P.C., E.V., V.G., He, C.Bg, Sy, Bx, Ju...
## $ NO_COM_FED &amp;lt;int&amp;gt; 6619, 6608, 6636, 6632, 6621, 6621, 6625, 6613, 663...
## $ LIEN_WWW   &amp;lt;fctr&amp;gt; http://www.geneve-communes.ch, http://www.geneve-c...
## $ SHAPE_AREA &amp;lt;dbl&amp;gt; 2735462, 2703700, 2669651, 2542247, 2538140, 252017...
## $ SHAPE_LEN  &amp;lt;dbl&amp;gt; 8817.079, 8682.215, 8290.230, 7353.972, 7805.008, 8...
## $ geometry   &amp;lt;simple_feature&amp;gt; MULTIPOLYGON (((2506472.244..., MULTIPOL...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The &lt;code&gt;dplyr&lt;/code&gt; verbs are also available. So you can &lt;code&gt;filter&lt;/code&gt;, &lt;code&gt;rename&lt;/code&gt;, &lt;code&gt;mutate&lt;/code&gt;… and always get back a &lt;code&gt;sf&lt;/code&gt; object.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Filter to see only commune &amp;quot;Carouge&amp;quot;
communes %&amp;gt;% filter(COMMUNE == &amp;quot;Carouge&amp;quot;) %&amp;gt;% head&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Simple feature collection with 1 feature and 7 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: 2498785 ymin: 1113794 xmax: 2500854 ymax: 1116325
## epsg (SRID):    NA
## proj4string:    +proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +units=m +no_defs
##   COMMUNE NO_COMM ABREVIATIO NO_COM_FED                      LIEN_WWW
## 1 Carouge       8         Ca       6608 http://www.geneve-communes.ch
##   SHAPE_AREA SHAPE_LEN                       geometry
## 1    2703700  8682.215 MULTIPOLYGON (((2499509.292...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Filter to see only communes with &amp;quot;Genève&amp;quot; in their name
communes %&amp;gt;% filter(grepl(&amp;quot;^genève&amp;quot;, COMMUNE, ignore.case=T)) %&amp;gt;% head&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Simple feature collection with 4 features and 7 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: 2497477 ymin: 1114844 xmax: 2502538 ymax: 1120889
## epsg (SRID):    NA
## proj4string:    +proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +units=m +no_defs
##                 COMMUNE NO_COMM ABREVIATIO NO_COM_FED
## 1     Genève-Eaux-Vives      22       E.V.       6621
## 2           Genève-Cité      21       V.G.       6621
## 3 Genève-Petit-Saconnex      23        P.S       6621
## 4    Genève-Plainpalais      24        Pl.       6621
##                        LIEN_WWW SHAPE_AREA SHAPE_LEN
## 1 http://www.geneve-communes.ch    2538140  7805.008
## 2 http://www.geneve-communes.ch    2520179  8975.992
## 3 http://www.geneve-communes.ch    6233939 13848.284
## 4 http://www.geneve-communes.ch    4628296 14154.933
##                         geometry
## 1 MULTIPOLYGON (((2502293.896...
## 2 MULTIPOLYGON (((2499898.226...
## 3 MULTIPOLYGON (((2499654.219...
## 4 MULTIPOLYGON (((2499714.537...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Select only COMMUNE column (note that geometry is kept)
# I also had to use select.sf rather than the generic select
communes %&amp;gt;% select.sf(COMMUNE) %&amp;gt;% head&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Simple feature collection with 6 features and 1 field
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: 2494595 ymin: 1111735 xmax: 2508349 ymax: 1125219
## epsg (SRID):    NA
## proj4string:    +proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +units=m +no_defs
##             COMMUNE                       geometry
## 1           Corsier MULTIPOLYGON (((2506472.244...
## 2           Carouge MULTIPOLYGON (((2499509.292...
## 3          Puplinge MULTIPOLYGON (((2507415.896...
## 4     Perly-Certoux MULTIPOLYGON (((2496407.883...
## 5 Genève-Eaux-Vives MULTIPOLYGON (((2502293.896...
## 6       Genève-Cité MULTIPOLYGON (((2499898.226...&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Mutate names to lowercase
communes %&amp;gt;% 
  mutate(COMMUNE = stringr::str_to_lower(COMMUNE)) %&amp;gt;% 
  head&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Simple feature collection with 6 features and 7 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: 2494595 ymin: 1111735 xmax: 2508349 ymax: 1125219
## epsg (SRID):    NA
## proj4string:    +proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +units=m +no_defs
##             COMMUNE NO_COMM ABREVIATIO NO_COM_FED
## 1           corsier      19         Cr       6619
## 2           carouge       8         Ca       6608
## 3          puplinge      39         Pu       6636
## 4     perly-certoux      35       P.C.       6632
## 5 genève-eaux-vives      22       E.V.       6621
## 6       genève-cité      21       V.G.       6621
##                        LIEN_WWW SHAPE_AREA SHAPE_LEN
## 1 http://www.geneve-communes.ch    2735462  8817.079
## 2 http://www.geneve-communes.ch    2703700  8682.215
## 3 http://www.geneve-communes.ch    2669651  8290.230
## 4 http://www.geneve-communes.ch    2542247  7353.972
## 5 http://www.geneve-communes.ch    2538140  7805.008
## 6 http://www.geneve-communes.ch    2520179  8975.992
##                         geometry
## 1 MULTIPOLYGON (((2506472.244...
## 2 MULTIPOLYGON (((2499509.292...
## 3 MULTIPOLYGON (((2507415.896...
## 4 MULTIPOLYGON (((2496407.883...
## 5 MULTIPOLYGON (((2502293.896...
## 6 MULTIPOLYGON (((2499898.226...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To learn more about applying &lt;code&gt;dplyr&lt;/code&gt; verbs to &lt;code&gt;sf&lt;/code&gt; objects, see &lt;a href=&#34;https://r-spatial.github.io/sf/reference/dplyr.html&#34;&gt;this article from the documentation&lt;/a&gt; and &lt;a href=&#34;http://strimas.com/r/tidy-sf/&#34;&gt;Strimas blog post&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To map the polygons, there is now a dedicated geom &lt;code&gt;geom_sf&lt;/code&gt; in &lt;code&gt;ggplot2&lt;/code&gt;. This makes mapping geo areas as simple as lines (&lt;code&gt;geom_line&lt;/code&gt;) or points (&lt;code&gt;geom_point&lt;/code&gt;). Note that, at this stage, you need the development version of &lt;code&gt;ggplot2&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# if you don&amp;#39;t have the development version
# install.packages(&amp;quot;devtools&amp;quot;)
# devtools::install_github(&amp;quot;tidyverse/ggplot2&amp;quot;)
library(ggplot2)

# Create a plot
ggplot() + 
  # add a layer with lightgrey communal polygons
  geom_sf(data=communes) + 
  # add a title
  labs(title=&amp;quot;Communals districts of Geneva&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-7-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;geom_sf&lt;/code&gt; accepts styling arguments: &lt;code&gt;fill&lt;/code&gt; for the color inside the polygons, &lt;code&gt;color&lt;/code&gt; for the color of the polygons borders.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot() + 
  geom_sf(data=communes, fill=&amp;quot;darkred&amp;quot;, color=&amp;quot;gold&amp;quot;) + 
  labs(title=&amp;quot;Communals districts of Geneva&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-8-1.png&#34; width=&#34;672&#34; /&gt; Great! But here we notice something surprising: districts don’t overlap the lake, but they do overlap the rivers. Let’see how we can fix this.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;removing-rivers&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Removing rivers&lt;/h2&gt;
&lt;p&gt;The polygons of Geneva lake and main rivers (Rhône and Arve) are available &lt;a href=&#34;http://ge.ch/sitg/sitg_catalog/sitg_donnees?keyword=petit%20lac&amp;amp;topic=tous&amp;amp;service=tous&amp;amp;datatype=tous&amp;amp;distribution=3&amp;amp;sort=auto&#34;&gt;here, named ‘EMPRISE DU LAC LEMAN (Petit-lac)’&lt;/a&gt;. We can load them with &lt;code&gt;st_read&lt;/code&gt; again.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;waters &amp;lt;- st_read(&amp;quot;../data/GEO_LAC.shp&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Reading layer `GEO_LAC&amp;#39; from data source `/home/xadam/dev/GitHub/ii_src/content/data/GEO_LAC.shp&amp;#39; using driver `ESRI Shapefile&amp;#39;
## Simple feature collection with 3 features and 3 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: 2485388 ymin: 1110037 xmax: 2510891 ymax: 1136120
## epsg (SRID):    NA
## proj4string:    +proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +units=m +no_defs&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;glimpse(waters)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Observations: 3
## Variables: 4
## $ NOM        &amp;lt;fctr&amp;gt; Léman, Arve, Rhône
## $ SHAPE_AREA &amp;lt;dbl&amp;gt; 67916036.2, 638356.6, 3148365.7
## $ SHAPE_LEN  &amp;lt;dbl&amp;gt; 64418.43, 21388.25, 59438.90
## $ geometry   &amp;lt;simple_feature&amp;gt; POLYGON ((2510891.1652 1134..., POLYGON ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;There are only 3 geometries: Léman (the lake), Arve and Rhône (the main rivers). Let’s see what they looks like:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Create a plot
ggplot() + 
  # add a layer with blue water polygons
  geom_sf(data=waters) + 
  # add a title
  labs(title=&amp;quot;Lake and rivers of Geneva&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-10-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Using &lt;code&gt;dplyr&lt;/code&gt; again, let’s filter to see only the rivers.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Create a plot
ggplot() + 
  # add a layer with blue water polygons
  geom_sf(data= waters %&amp;gt;% filter(NOM != &amp;quot;Léman&amp;quot;)) + 
  # add a title
  labs(title=&amp;quot;Lake and rivers of Geneva&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-11-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;We could map waters on top of the communes. But we could also explore geometry calculations and remove it from the commune shapes. The &lt;code&gt;sf&lt;/code&gt; package has functions to combine polygon sets into new &lt;code&gt;sf&lt;/code&gt; object. The functions are described in this &lt;a href=&#34;https://cran.r-project.org/web/packages/sf/vignettes/sf3.html&#34;&gt;vignette&lt;/a&gt;. You can do things like union (&lt;code&gt;st_union&lt;/code&gt;), intersection (&lt;code&gt;st_intersection&lt;/code&gt;), difference (&lt;code&gt;st_difference&lt;/code&gt;)… Here we will calculate the difference, which keeps everything but the intersection.&lt;/p&gt;
&lt;p&gt;Note that we need to “group” the rivers, otherwise nothing will be removed since communes are never overlapped by both rivers in the same place. Below we apply:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;st_combine&lt;/code&gt; to combine the two rivers in &lt;code&gt;waters&lt;/code&gt; to a single multipolygon&lt;/li&gt;
&lt;li&gt;&lt;code&gt;st_union&lt;/code&gt; to convert the &lt;code&gt;st_combine&lt;/code&gt; multipolygon to a normal polygon&lt;/li&gt;
&lt;li&gt;&lt;code&gt;st_difference&lt;/code&gt; to remove the &lt;code&gt;st_union&lt;/code&gt; polygon from communes&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;communes_no_water &amp;lt;- 
  communes %&amp;gt;%
    st_difference(st_union(st_combine(waters)))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: attribute variables are assumed to be spatially constant
## throughout all geometries&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot() +
  geom_sf(data=communes_no_water) +
  labs(title=&amp;quot;Communes without rivers&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-12-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;zoom-on-the-map&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Zoom on the map&lt;/h2&gt;
&lt;p&gt;To check that rivers were correctly removed, we might want to “zoom” on the map. Playing with coordinates isn’t something I understand well at all. It looks like along &lt;code&gt;geom_sf&lt;/code&gt;, a dedicated coordinate function &lt;code&gt;coord_sf&lt;/code&gt; was added to &lt;code&gt;ggplot2&lt;/code&gt;, which lets us restrict coordinates. However, using limits in the axis unit (like &lt;code&gt;ylim(c(46.2,46.25))&lt;/code&gt;) won’t work. Even if latitude and longitude are displayed in this format on the axis, that’s not the format of the undelying data. Let’s see what the coordinates for the first polygon look like:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;communes_no_water %&amp;gt;%
  select(geometry) %&amp;gt;%
  slice(1) %&amp;gt;%
  as.character()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;list(list(list(c(2506472.2448, 2506542.9965, 2506716.5846, 2507240.2961, 2507493.079, 2507486.3281, 2507585.1196, 2507576.499, 2507646.5101, 2507913.8754, 2508176.8697, 2508334.7441, 2508348.9038, 2508268.3703, 2507973.44, 2507700.1959, 2507160.6547, 2507087.6019, 2506884.1048, 2506780.5705, 2506656.0346, 2506420.4294, 2506474.8647, 2506235.2632, 2506251.3018, 2506172.348, 2506198.9391, 2506112.8363, 2506054.4852, 2505828.127, 2505536.5367, 2505536.4371, 2505262.7578, 2505257.80583182, 2505262.7578, \n2505264.218, 2505271.1583, 2505277.1085, 2505291.8989, 2505300.2949, 2505300.3665, 2505300.4338, 2505300.5055, 2505300.5467, 2505300.5774, 2505300.586, 2505300.6495, 2505300.7212, 2505300.793, 2505300.865, 2505300.9245, 2505300.9363, 2505300.957, 2505301.0081, 2505301.0792, 2505301.1511, 2505301.1983, 2505301.2226, 2505301.2596, 2505301.2991, 2505301.3656, 2505301.4368, 2505301.4683, 2505301.5081, 2505301.5792, 2505301.6249, 2505301.6505, 2505301.7218, 2505301.7592, 2505301.7927, 2505301.8456, 2505301.8639, \n2505301.9265, 2505301.9349, 2505302.006, 2505302.0762, 2505302.1476, 2505302.167, 2505302.2187, 2505302.2785, 2505302.2893, 2505302.3279, 2505302.36, 2505302.4164, 2505302.4306, 2505302.5012, 2505302.5719, 2505302.6423, 2505302.7128, 2505302.7677, 2505302.7831, 2505302.8536, 2505302.8709, 2505302.9242, 2505302.9941, 2505303.039, 2505303.0643, 2505303.1344, 2505303.2048, 2505303.2313, 2505303.2747, 2505303.3447, 2505303.415, 2505303.4846, 2505303.5545, 2505303.6233, 2505303.6942, 2505303.7205, 2505303.7638, \n2505303.8335, 2505303.8745, 2505303.9031, 2505303.9164, 2505303.9728, 2505303.9962, 2505304.0423, 2505304.1117, 2505304.1342, 2505304.1812, 2505304.2505, 2505304.2584, 2505304.3198, 2505304.3892, 2505304.4583, 2505304.5275, 2505304.5553, 2505304.5966, 2505304.6309, 2505304.6658, 2505304.7348, 2505304.7966, 2505304.8037, 2505304.8182, 2505304.8397, 2505304.8756, 2505304.9418, 2505304.9933, 2505305.0104, 2505305.0289, 2505305.0793, 2505305.1478, 2505305.1931, 2505305.2165, 2505305.2534, 2505305.2852, \n2505305.305, 2505305.3537, 2505305.3739, 2505305.4222, 2505305.4457, 2505305.4907, 2505305.5176, 2505305.5591, 2505305.6195, 2505305.688, 2505305.7561, 2505305.7964, 2505305.8243, 2505305.8612, 2505305.8926, 2505305.9606, 2505306.0288, 2505306.0817, 2505306.0967, 2505306.1647, 2505306.2202, 2505306.2325, 2505306.2757, 2505306.3005, 2505306.3683, 2505306.419, 2505306.4362, 2505306.5037, 2505306.551, 2505306.5715, 2505306.6391, 2505306.7068, 2505306.7742, 2505306.8417, 2505306.9091, 2505306.9763, 2505307.0437, \n2505307.1118, 2505307.1782, 2505307.2453, 2505307.3123, 2505307.3794, 2505307.4465, 2505307.5134, 2505307.5802, 2505307.6472, 2505307.7139, 2505307.7212, 2505307.7807, 2505307.8473, 2505307.8643, 2505307.9139, 2505307.9805, 2505308.0471, 2505308.1135, 2505308.135, 2505308.1799, 2505308.2464, 2505308.3127, 2505308.379, 2505308.4453, 2505308.5114, 2505308.5775, 2505308.6436, 2505308.7096, 2505308.7755, 2505308.8078, 2505308.8414, 2505308.8792, 2505308.9072, 2505308.973, 2505309.0388, 2505309.0752, \n2505309.1045, 2505309.1465, 2505309.1701, 2505309.236, 2505309.3013, 2505309.3667, 2505309.4323, 2505309.4976, 2505309.563, 2505309.6169, 2505309.6283, 2505309.6934, 2505309.7394, 2505309.7586, 2505309.8238, 2505309.8889, 2505309.9292, 2505309.9541, 2505309.9979, 2505310.0187, 2505310.0837, 2505310.1486, 2505310.2134, 2505310.2772, 2505310.3429, 2505310.3639, 2505310.4075, 2505310.4721, 2505310.5283, 2505310.5367, 2505310.6011, 2505310.6112, 2505310.6655, 2505310.7212, 2505310.73, 2505310.7772, 2505310.7899, \n2505310.8547, 2505310.9133, 2505310.9362, 2505310.9584, 2505310.9839, 2505311.0477, 2505311.1119, 2505311.1718, 2505311.2399, 2505311.2694, 2505311.3037, 2505311.3131, 2505311.3674, 2505311.4015, 2505311.4311, 2505311.4861, 2505311.4947, 2505311.5204, 2505311.5581, 2505311.6201, 2505311.6846, 2505311.7475, 2505311.7629, 2505311.8106, 2505311.8733, 2505311.9364, 2505311.9987, 2505312.0613, 2505312.1236, 2505312.1863, 2505312.2484, 2505312.3102, 2505312.3723, 2505312.4048, 2505312.434, 2505312.485, \n2505312.4958, 2505312.5573, 2505312.6189, 2505312.6323, 2505312.6803, 2505312.7077, 2505312.7415, 2505312.7526, 2505312.8028, 2505312.8281, 2505312.8638, 2505312.9062, 2505312.9248, 2505312.9738, 2505312.9857, 2505313.0466, 2505313.107, 2505313.1185, 2505313.1675, 2505313.1942, 2505313.2278, 2505313.2705, 2505313.2882, 2505313.3124, 2505313.3482, 2505313.3926, 2505313.4083, 2505313.4395, 2505313.4682, 2505313.4844, 2505313.5279, 2505313.5569, 2505313.5877, 2505313.606, 2505313.6473, 2505313.7066, \n2505313.7661, 2505313.8254, 2505313.8844, 2505313.8963, 2505313.9434, 2505313.9629, 2505314.0023, 2505314.0611, 2505314.102, 2505314.1198, 2505314.1783, 2505314.2366, 2505314.2638, 2505314.2951, 2505314.3156, 2505314.3582, 2505314.4113, 2505314.4622, 2505314.4692, 2505314.4759, 2505314.5272, 2505314.5623, 2505314.5848, 2505314.6409, 2505314.7, 2505314.7127, 2505314.7574, 2505314.7858, 2505314.8146, 2505314.8717, 2505314.9202, 2505314.9288, 2505314.9529, 2505314.9857, 2505315.0424, 2505315.0991, 2505315.1559, \n2505315.2021, 2505315.2121, 2505315.2611, 2505315.2684, 2505315.3246, 2505315.3702, 2505315.3807, 2505315.3986, 2505315.4484, 2505315.4601, 2505315.5034, 2505315.516, 2505315.5562, 2505315.5649, 2505315.5717, 2505315.6272, 2505315.6653, 2505315.6827, 2505315.7065, 2505315.7379, 2505315.7904, 2505315.844, 2505315.854, 2505315.9033, 2505315.9402, 2505315.9581, 2505316.0127, 2505316.0351, 2505316.0617, 2505316.0674, 2505316.0783, 2505316.1219, 2505316.1339, 2505316.1762, 2505316.2042, 2505316.2305, \n2505316.2846, 2505316.2999, 2505316.3296, 2505316.3435, 2505316.3925, 2505316.4041, 2505316.4462, 2505316.4999, 2505316.5394, 2505316.5534, 2505316.6071, 2505316.6602, 2505316.666, 2505316.7133, 2505316.7372, 2505316.7635, 2505316.8193, 2505316.8552, 2505316.872, 2505316.9258, 2505316.9603, 2505316.9773, 2505317.0228, 2505317.0298, 2505317.082, 2505317.1342, 2505317.1733, 2505317.1863, 2505317.2382, 2505317.271, 2505317.2901, 2505317.3173, 2505317.3418, 2505317.3935, 2505317.4448, 2505317.486, 2505317.4961, \n2505317.5473, 2505317.5707, 2505317.5985, 2505317.6187, 2505317.6494, 2505317.7003, 2505317.7509, 2505317.7918, 2505317.8016, 2505317.8101, 2505317.852, 2505317.882, 2505317.9023, 2505317.9181, 2505317.9526, 2505317.993, 2505318.0028, 2505318.0123, 2505318.0527, 2505318.1024, 2505318.1356, 2505318.1523, 2505318.17, 2505318.2018, 2505318.2514, 2505318.3006, 2505318.3499, 2505318.3837, 2505318.3991, 2505318.4098, 2505318.4481, 2505318.4656, 2505318.4969, 2505318.5288, 2505318.5456, 2505318.5943, 2505318.6427, \n2505318.6675, 2505318.6911, 2505318.7393, 2505318.7874, 2505318.8181, 2505318.8355, 2505318.8772, 2505318.887, 2505318.9309, 2505318.9785, 2505318.9968, 2505319.026, 2505319.0574, 2505319.0735, 2505319.0974, 2505319.1207, 2505319.1566, 2505319.1679, 2505319.1793, 2505319.2148, 2505319.2463, 2505319.2616, 2505319.2804, 2505319.3084, 2505319.3223, 2505319.3549, 2505319.4013, 2505319.4478, 2505319.491, 2505319.5402, 2505319.5861, 2505319.5955, 2505319.6302, 2505319.6433, 2505319.6505, 2505325.5705, \n2505324.4206, 2505322.65473884, 2505336.3311, 2505344.68364709, 2505346.5114, 2505351.1517, 2505362.4121, 2505363.1322, 2505374.5442, 2505375.9931, 2505387.7857, 2505421.8947, 2505427.8349, 2505433.3353, 2505454.6961, 2505459.4263, 2505463.3165, 2505466.2366, 2505468.5967, 2505479.30271796, 2505490.2176, 2505497.51739588, 2505498.9881, 2505504.0683, 2505528.1592, 2505525.2092, 2505527.6093, 2505535.0498, 2505535.6398, 2505538.4797, 2505539.7499, 2505557.6007, 2505561.7609, 2505569.1513, 2505573.9215, \n2505572.5014, 2505575.2615, 2505576.7216, 2505578.7916, 2505585.9422, 2505588.6622, 2505587.8222, 2505591.0938, 2505592.1423, 2505593.0611, 2505593.1461, 2505595.3426, 2505595.4695, 2505598.0229, 2505601.3931, 2505603.42903839, 2505631.39626359, 2505632.3145, 2505635.7546, 2505637.35901417, 2505653.0398957, 2505659.6457, 2505662.3757, 2505663.9158, 2505666.766, 2505666.6358, 2505665.89079892, 2505667.59453906, 2505667.843, 2505667.859, 2505670.67579125, 2505711.10097915, 2505711.7079, 2505712.56594025, \n2505717.578, 2505723.05515657, 2505727.2252, 2505731.6085, 2505736.5988, 2505735.1887, 2505747.0494, 2505760.04985888, 2505790.7204, 2505963.627, 2506153.1339, 2506289.9082, 2506472.2448, 1124692.4017, 1124491.3611, 1124634.572, 1124573.8129, 1124344.6513, 1124269.491, 1124213.1405, 1124169.1303, 1124136.75, 1124140.9695, 1124035.3784, 1124163.6087, 1124110.3485, 1123910.6677, 1123446.5461, 1123587.3573, 1123548.4582, 1123406.3777, 1123488.4978, 1123411.1374, 1123207.4525, 1123237.0108, 1123343.1843, \n1123490.9758, 1123522.8368, 1123576.3873, 1123599.7475, 1123691.3477, 1123940.8085, 1124017.0686, 1124191.8389, 1124281.6792, 1124529.8298, 1124532.53118268, 1124529.8299, 1124537.4298, 1124538.3199, 1124539.4498, 1124554.6501, 1124562.6852, 1124562.7541, 1124562.8188, 1124562.8881, 1124562.9278, 1124562.9574, 1124562.9658, 1124563.0272, 1124563.0966, 1124563.1663, 1124563.2362, 1124563.2941, 1124563.3056, 1124563.3257, 1124563.3754, 1124563.4448, 1124563.5151, 1124563.5612, 1124563.5849, 1124563.6212, \n1124563.6599, 1124563.7251, 1124563.7951, 1124563.826, 1124563.8651, 1124563.9352, 1124563.9802, 1124564.0055, 1124564.0758, 1124564.1128, 1124564.146, 1124564.1983, 1124564.2164, 1124564.2786, 1124564.2869, 1124564.3574, 1124564.4273, 1124564.4984, 1124564.5178, 1124564.5693, 1124564.629, 1124564.6397, 1124564.6784, 1124564.7104, 1124564.767, 1124564.7812, 1124564.8519, 1124564.923, 1124564.9937, 1124565.0648, 1124565.1201, 1124565.1356, 1124565.2069, 1124565.2243, 1124565.2781, 1124565.349, 1124565.3945, \n1124565.4202, 1124565.4913, 1124565.5628, 1124565.5899, 1124565.634, 1124565.7055, 1124565.7773, 1124565.8483, 1124565.92, 1124565.9905, 1124566.0632, 1124566.0903, 1124566.1349, 1124566.2066, 1124566.2488, 1124566.2783, 1124566.2921, 1124566.3502, 1124566.3745, 1124566.4221, 1124566.4939, 1124566.5173, 1124566.566, 1124566.638, 1124566.6462, 1124566.7101, 1124566.7823, 1124566.8544, 1124566.9266, 1124566.9556, 1124566.9988, 1124567.0347, 1124567.0712, 1124567.1435, 1124567.2085, 1124567.2159, 1124567.2311, \n1124567.2537, 1124567.2914, 1124567.3611, 1124567.4155, 1124567.4335, 1124567.453, 1124567.5063, 1124567.5787, 1124567.6265, 1124567.6513, 1124567.6905, 1124567.7242, 1124567.7452, 1124567.7968, 1124567.8183, 1124567.8698, 1124567.8947, 1124567.9427, 1124567.9712, 1124568.0156, 1124568.08, 1124568.1532, 1124568.2261, 1124568.2693, 1124568.2992, 1124568.3388, 1124568.3725, 1124568.4455, 1124568.5189, 1124568.5759, 1124568.5921, 1124568.6655, 1124568.7254, 1124568.7388, 1124568.7854, 1124568.8124, \n1124568.8859, 1124568.9408, 1124568.9594, 1124569.0329, 1124569.084, 1124569.1067, 1124569.1802, 1124569.2541, 1124569.3278, 1124569.4016, 1124569.4755, 1124569.5493, 1124569.6234, 1124569.6978, 1124569.7714, 1124569.8455, 1124569.9196, 1124569.9938, 1124570.0681, 1124570.1424, 1124570.2166, 1124570.2911, 1124570.3655, 1124570.3736, 1124570.44, 1124570.5145, 1124570.5334, 1124570.589, 1124570.6636, 1124570.7383, 1124570.8129, 1124570.8372, 1124570.8876, 1124570.9626, 1124571.0374, 1124571.1123, 1124571.1874, \n1124571.2623, 1124571.3373, 1124571.4124, 1124571.4875, 1124571.5626, 1124571.5994, 1124571.6378, 1124571.6809, 1124571.713, 1124571.7883, 1124571.8637, 1124571.9054, 1124571.9391, 1124571.9873, 1124572.0145, 1124572.0903, 1124572.1656, 1124572.241, 1124572.3168, 1124572.3924, 1124572.4682, 1124572.5308, 1124572.5439, 1124572.6197, 1124572.6732, 1124572.6955, 1124572.7715, 1124572.8475, 1124572.8945, 1124572.9236, 1124572.9749, 1124572.9993, 1124573.0754, 1124573.1516, 1124573.2277, 1124573.3028, \n1124573.3802, 1124573.4051, 1124573.4565, 1124573.5329, 1124573.5994, 1124573.6093, 1124573.6857, 1124573.6977, 1124573.7621, 1124573.8283, 1124573.8387, 1124573.8949, 1124573.9101, 1124573.9866, 1124574.056, 1124574.0833, 1124574.1096, 1124574.1399, 1124574.216, 1124574.2927, 1124574.3646, 1124574.4463, 1124574.4818, 1124574.5232, 1124574.5346, 1124574.6003, 1124574.6415, 1124574.6775, 1124574.7443, 1124574.7547, 1124574.7861, 1124574.8321, 1124574.9079, 1124574.987, 1124575.0645, 1124575.0835, \n1124575.1423, 1124575.2199, 1124575.2982, 1124575.3758, 1124575.4539, 1124575.5319, 1124575.6107, 1124575.6888, 1124575.767, 1124575.8456, 1124575.8868, 1124575.924, 1124575.989, 1124576.0027, 1124576.0813, 1124576.1603, 1124576.1778, 1124576.2393, 1124576.2749, 1124576.3182, 1124576.3328, 1124576.3974, 1124576.4304, 1124576.4765, 1124576.5319, 1124576.5559, 1124576.6201, 1124576.6353, 1124576.7151, 1124576.7943, 1124576.8097, 1124576.874, 1124576.9092, 1124576.9536, 1124577.0104, 1124577.0335, 1124577.066, \n1124577.1133, 1124577.1724, 1124577.1933, 1124577.2349, 1124577.2734, 1124577.295, 1124577.3533, 1124577.3922, 1124577.4337, 1124577.4585, 1124577.514, 1124577.5942, 1124577.6749, 1124577.7556, 1124577.836, 1124577.8523, 1124577.9169, 1124577.9436, 1124577.9977, 1124578.0786, 1124578.135, 1124578.1597, 1124578.2407, 1124578.3217, 1124578.3595, 1124578.4032, 1124578.4318, 1124578.4914, 1124578.5658, 1124578.6373, 1124578.6472, 1124578.6569, 1124578.729, 1124578.7786, 1124578.8105, 1124578.8901, 1124578.9742, \n1124578.9923, 1124579.0561, 1124579.0971, 1124579.138, 1124579.2201, 1124579.2899, 1124579.3022, 1124579.3372, 1124579.3845, 1124579.4667, 1124579.5491, 1124579.6319, 1124579.6996, 1124579.7142, 1124579.786, 1124579.7968, 1124579.8795, 1124579.9468, 1124579.9623, 1124579.9887, 1124580.0626, 1124580.0802, 1124580.1444, 1124580.163, 1124580.2231, 1124580.236, 1124580.2462, 1124580.3292, 1124580.3864, 1124580.4126, 1124580.4484, 1124580.4958, 1124580.5752, 1124580.6563, 1124580.6714, 1124580.7463, 1124580.8027, \n1124580.8298, 1124580.9134, 1124580.9478, 1124580.9885, 1124580.9973, 1124581.0141, 1124581.0811, 1124581.0996, 1124581.165, 1124581.2086, 1124581.2491, 1124581.3332, 1124581.357, 1124581.4032, 1124581.4249, 1124581.5016, 1124581.5199, 1124581.5859, 1124581.6703, 1124581.733, 1124581.7548, 1124581.8398, 1124581.9242, 1124581.9334, 1124582.0087, 1124582.0469, 1124582.0889, 1124582.1784, 1124582.2361, 1124582.2632, 1124582.35, 1124582.4058, 1124582.4334, 1124582.5072, 1124582.5186, 1124582.6037, 1124582.6889, \n1124582.7534, 1124582.7744, 1124582.8598, 1124582.9139, 1124582.9455, 1124582.9905, 1124583.031, 1124583.1168, 1124583.2024, 1124583.2712, 1124583.2881, 1124583.3741, 1124583.4135, 1124583.4602, 1124583.4944, 1124583.5461, 1124583.6323, 1124583.7184, 1124583.788, 1124583.8047, 1124583.8192, 1124583.8909, 1124583.9425, 1124583.9773, 1124584.0044, 1124584.0638, 1124584.1336, 1124584.1505, 1124584.1671, 1124584.237, 1124584.3235, 1124584.3815, 1124584.4106, 1124584.4416, 1124584.4972, 1124584.5842, \n1124584.6709, 1124584.7582, 1124584.818, 1124584.8453, 1124584.8644, 1124584.9326, 1124584.9639, 1124585.0197, 1124585.077, 1124585.107, 1124585.1946, 1124585.2818, 1124585.3266, 1124585.3694, 1124585.457, 1124585.5447, 1124585.6006, 1124585.6325, 1124585.7091, 1124585.727, 1124585.8079, 1124585.8959, 1124585.9296, 1124585.9839, 1124586.0422, 1124586.0721, 1124586.1167, 1124586.1602, 1124586.2275, 1124586.2485, 1124586.27, 1124586.3367, 1124586.3962, 1124586.425, 1124586.4606, 1124586.5135, 1124586.5398, \n1124586.6018, 1124586.6902, 1124586.7791, 1124586.862, 1124586.9567, 1124587.0453, 1124587.0636, 1124587.1308, 1124587.1563, 1124587.17, 1124598.4601, 1124599.0701, 1124611.00841722, 1124637.8703, 1124644.31630732, 1124642.6904, 1124645.0605, 1124650.8305, 1124651.2803, 1124659.7225, 1124660.7943, 1124669.5181, 1124694.7507, 1124699.2706, 1124703.6707, 1124721.9908, 1124726.2508, 1124729.9209, 1124732.8613, 1124735.4508, 1124748.20743245, 1124756.6309, 1124772.6616971, 1124775.0211, 1124783.1711, \n1124821.8212, 1124823.7511, 1124827.6512, 1124839.7914, 1124840.8014, 1124845.4713, 1124847.4913, 1124876.4015, 1124884.1814, 1124897.2116, 1124904.8116, 1124905.5515, 1124910.9217, 1124910.1717, 1124914.1615, 1124927.3716, 1124937.8617, 1124937.9317, 1124953.2671, 1124958.1818, 1124962.089, 1124962.4506, 1124971.7917, 1124972.3202, 1124982.9518, 1124996.8318, 1125005.2501256, 1125066.66785839, 1125068.2021, 1125072.7521, 1125074.52178701, 1125084.96034149, 1125087.2422, 1125089.3523, 1125089.0723, \n1125092.4523, 1125092.6022, 1125093.51501702, 1125094.64917419, 1125094.3467, 1125094.36, 1125096.70032283, 1125123.61083328, 1125123.7526, 1125124.58603842, 1125127.9225, 1125134.77444215, 1125138.8249, 1125143.0825, 1125147.9026, 1125149.0725, 1125163.4027, 1125181.05494504, 1125219.4239, 1125030.8824, 1124968.9824, 1124776.2818, 1124692.4017)), list(c(2505557.35214595, 2505558.16319845, 2505561.631, 2505562.1869, 2505562.7611, 2505563.0544, 2505563.6526, 2505563.9571, 2505564.2648, 2505564.4148, \n2505564.5756, 2505564.889, 2505565.205, 2505565.5235, 2505565.8438, 2505566.1663, 2505566.4911, 2505567.0921, 2505567.3932, 2505567.6938, 2505567.9932, 2505568.2912, 2505568.5869, 2505568.88, 2505569.1697, 2505569.4557, 2505569.7374, 2505570.0143, 2505570.2855, 2505570.5509, 2505570.8101, 2505571.0613, 2505572.4316, 2505571.9014, 2505569.0362, 2505568.9464, 2505568.8583, 2505568.7724, 2505568.6825, 2505568.5864, 2505568.5, 2505568.4137, 2505568.316, 2505568.227, 2505568.1392, 2505568.0492, 2505567.9581, \n2505567.8668, 2505567.7763, 2505567.6851, 2505567.5944, 2505567.5031, 2505567.4123, 2505567.3209, 2505567.23, 2505567.1388, 2505567.0477, 2505566.9567, 2505566.8655, 2505566.7897, 2505566.7111, 2505566.6355, 2505566.5601, 2505566.4202, 2505566.2901, 2505566.1535, 2505566.0229, 2505565.888, 2505565.7576, 2505565.6238, 2505565.4947, 2505565.3649, 2505565.2332, 2505565.1012, 2505564.9731, 2505564.8488, 2505564.7172, 2505564.5858, 2505564.4604, 2505564.3306, 2505564.2072, 2505564.1964, 2505564.075, 2505563.954, \n2505563.9422, 2505563.8179, 2505563.6959, 2505563.5738, 2505563.4502, 2505563.4408, 2505563.3179, 2505563.1969, 2505563.0772, 2505562.9555, 2505562.9451, 2505562.8221, 2505562.7054, 2505562.6604, 2505562.6011, 2505561.441, 2505557.9308, 2505557.35214595, 1124904.06245871, 1124905.84357949, 1124911.5016, 1124911.8534, 1124912.175, 1124912.324, 1124912.5983, 1124912.7233, 1124912.8402, 1124912.8926, 1124912.9487, 1124913.0488, 1124913.1405, 1124913.2236, 1124913.2984, 1124913.3643, 1124913.4216, 1124913.4523, \n1124913.4481, 1124913.4311, 1124913.4006, 1124913.3575, 1124913.3014, 1124913.2325, 1124913.151, 1124913.0567, 1124912.9505, 1124912.832, 1124912.7016, 1124912.5594, 1124912.4062, 1124912.2416, 1124911.5317, 1124910.5116, 1124912.1329, 1124912.1535, 1124912.1726, 1124912.1898, 1124912.2079, 1124912.225, 1124912.2403, 1124912.2537, 1124912.2688, 1124912.2811, 1124912.2922, 1124912.3021, 1124912.3122, 1124912.3207, 1124912.3282, 1124912.3347, 1124912.3402, 1124912.3447, 1124912.3482, 1124912.3507, \n1124912.3522, 1124912.3527, 1124912.3522, 1124912.3507, 1124912.3482, 1124912.3454, 1124912.3417, 1124912.3193, 1124912.2967, 1124912.2538, 1124912.2129, 1124912.1688, 1124912.1257, 1124912.08, 1124912.0348, 1124911.9874, 1124911.9405, 1124911.8924, 1124911.8425, 1124911.7914, 1124911.7408, 1124911.6906, 1124911.6364, 1124911.5812, 1124911.5274, 1124911.4706, 1124911.4156, 1124911.4107, 1124911.3555, 1124911.2995, 1124911.2939, 1124911.2352, 1124911.1765, 1124911.1167, 1124911.0551, 1124911.0504, \n1124910.9874, 1124910.9254, 1124910.8619, 1124910.7974, 1124910.7918, 1124910.7242, 1124910.6601, 1124910.6349, 1124910.6015, 1124909.1716, 1124903.6915, 1124904.06245871))))&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Applying &lt;code&gt;coord_sf&lt;/code&gt; with the right &lt;code&gt;datum&lt;/code&gt; shows the original coordinate system on the map.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot() +
  geom_sf(data=communes_no_water) +
  labs(title=&amp;quot;Communes without rivers&amp;quot;) +
  coord_sf(datum = st_crs(communes_no_water))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-14-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Using these numbers, we can define limits for our map.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot() +
  geom_sf(data=communes_no_water) +
  labs(title=&amp;quot;Communes without rivers&amp;quot;) +
  # zooming on a smaller region
  coord_sf(xlim=c(2490000,2505000), ylim=c(1115000,1125000))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-15-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;simplify-polygons&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Simplify polygons&lt;/h2&gt;
&lt;p&gt;The borders are too detailed for the schematic look we are after. To simplify polygons, we can use the &lt;code&gt;rmapshaper&lt;/code&gt; package (on Ubuntu, I had to install dependencies &lt;a href=&#34;https://github.com/ropensci/geojsonio/issues/65&#34;&gt;&lt;code&gt;libv8-dev&lt;/code&gt;&lt;/a&gt; and &lt;a href=&#34;https://github.com/jeroen/protolite&#34;&gt;&lt;code&gt;protolite&lt;/code&gt;&lt;/a&gt;). &lt;code&gt;rmapshaper&lt;/code&gt; lets us access the &lt;code&gt;mapshaper&lt;/code&gt; javascript library, which provide tools to simplify and modify polygons. We will mainly use the simplify function &lt;code&gt;ms_simplify&lt;/code&gt;. Arguments for &lt;code&gt;ms_simplify&lt;/code&gt; are described in the &lt;a href=&#34;https://cran.r-project.org/web/packages/rmapshaper/vignettes/rmapshaper.html&#34;&gt;vignette&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(rmapshaper))
suppressMessages(library(gridExtra))

communes_no_water_simplified &amp;lt;- 
  communes_no_water %&amp;gt;%
    ms_simplify(keep_shapes=T, keep=0.02)

# using grid.arrange from gridExtra
# we can plot the two version side by side
chart_original &amp;lt;-
  ggplot() + 
    geom_sf(data=communes_no_water) +
    labs(title=&amp;quot;Original polygons&amp;quot;,
         subtitle=&amp;quot;No ms_simplify&amp;quot;)

chart_simplified &amp;lt;-
  ggplot() + 
    geom_sf(data=communes_no_water_simplified) +
    labs(title=&amp;quot;Simplified polygons&amp;quot;,
         subtitle=&amp;quot;ms_simplify at keep=0.02&amp;quot;)

grid.arrange(chart_original, chart_simplified, ncol=2)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-16-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;map-land-use&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Map land use&lt;/h2&gt;
&lt;p&gt;The polygons for building, forest and agricultural zones are available &lt;a href=&#34;http://ge.ch/sitg/sitg_catalog/sitg_donnees?keyword=agglo%20zone%20simplifiee&amp;amp;topic=tous&amp;amp;service=tous&amp;amp;datatype=tous&amp;amp;distribution=3&amp;amp;sort=auto&#34;&gt;here, named ‘AGGLO - ZONES D’AFFECTATION SIMPLIFIEES DE L’AGGLOMERATION FRANCO-VALDO-GENEVOISE’&lt;/a&gt;. We can load them with &lt;code&gt;st_read&lt;/code&gt; again.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;zones &amp;lt;- st_read(&amp;quot;../data/AGGLO_ZONE_AFF_SIMPLIFIEE.shp&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Reading layer `AGGLO_ZONE_AFF_SIMPLIFIEE&amp;#39; from data source `/home/xadam/dev/GitHub/ii_src/content/data/AGGLO_ZONE_AFF_SIMPLIFIEE.shp&amp;#39; using driver `ESRI Shapefile&amp;#39;
## Simple feature collection with 24474 features and 8 fields
## geometry type:  POLYGON
## dimension:      XYZ
## bbox:           xmin: 2465760 ymin: 1089315 xmax: 2531322 ymax: 1155694
## epsg (SRID):    NA
## proj4string:    +proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +units=m +no_defs&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;glimpse(zones)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Observations: 24,474
## Variables: 9
## $ COMMUNE    &amp;lt;fctr&amp;gt; CROZET, CROZET, CROZET, CROZET, CROZET, CROZET, CR...
## $ LIBFVG     &amp;lt;fctr&amp;gt; Zone de centre village, Zone agricole ou viticole,...
## $ SOURCE     &amp;lt;fctr&amp;gt; PLU, PLU, PLU, PLU, PLU, PLU, PLU, PLU, PLU, PLU, ...
## $ CODECOM    &amp;lt;fctr&amp;gt; 01135, 01135, 01135, 01135, 01135, 01135, 01135, 0...
## $ CODEFVG    &amp;lt;fctr&amp;gt; B, N1, N2, N2, E1y, N2, N2, N2, E1, E1, E1, E1, y,...
## $ CODEURB    &amp;lt;fctr&amp;gt; Ua, Na, N, N, 1AUt, Nh, Nh, Nh, Nt, Ut, Ut, Ut, 2A...
## $ SHAPE_AREA &amp;lt;dbl&amp;gt; 28170.5386, 6904.7535, 2839.2095, 4186.5152, 23454....
## $ SHAPE_LEN  &amp;lt;dbl&amp;gt; 1174.0810, 335.0173, 244.3988, 296.8529, 1367.4976,...
## $ geometry   &amp;lt;simple_feature&amp;gt; POLYGON Z ((2489475.4124 11..., POLYGON ...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Lots of data is contained here. Among the variables, &lt;code&gt;LIBFVG&lt;/code&gt; seems to contains the zone types. If we extract the column (encoded as factor), we can use &lt;code&gt;levels&lt;/code&gt; to see unique values.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;zones$LIBFVG %&amp;gt;%
  levels()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  [1] &amp;quot;Zone à affectation différée&amp;quot;                       
##  [2] &amp;quot;Zone aéroportuaire&amp;quot;                                
##  [3] &amp;quot;Zone agricole ou viticole&amp;quot;                         
##  [4] &amp;quot;Zone centrale à très forte densité&amp;quot;                
##  [5] &amp;quot;Zone d&amp;#39;activités économiques ou touristiques&amp;quot;      
##  [6] &amp;quot;Zone de centre historique&amp;quot;                         
##  [7] &amp;quot;Zone de centre village&amp;quot;                            
##  [8] &amp;quot;Zone d&amp;#39;équipements publics, sportifs ou de loisirs&amp;quot;
##  [9] &amp;quot;Zone de verdure&amp;quot;                                   
## [10] &amp;quot;Zone future centrale à très forte densité&amp;quot;         
## [11] &amp;quot;Zone future d&amp;#39;activités économiques ou touristiqu&amp;quot; 
## [12] &amp;quot;Zone future de centre village&amp;quot;                     
## [13] &amp;quot;Zone future d&amp;#39;équipements publics, sportifs ou de&amp;quot; 
## [14] &amp;quot;Zone future péricentrale à forte densité&amp;quot;          
## [15] &amp;quot;Zone future péricentrale à moyenne densité&amp;quot;        
## [16] &amp;quot;Zone future périurbaine à faible densité&amp;quot;          
## [17] &amp;quot;Zone liée aux grandes infrastructures de transport&amp;quot;
## [18] &amp;quot;Zone naturelle ou forestière&amp;quot;                      
## [19] &amp;quot;Zone péricentrale à forte densité&amp;quot;                 
## [20] &amp;quot;Zone péricentrale à moyenne densité&amp;quot;               
## [21] &amp;quot;Zone périurbaine à faible densité&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let’s isolate the building zones and add it as an additional &lt;code&gt;geom_sf&lt;/code&gt; layer to our map (grey fill, no borders):&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;building_zones &amp;lt;- c(
    &amp;quot;Zone périurbaine à faible densité&amp;quot;,
    &amp;quot;Zone péricentrale à moyenne densité&amp;quot;,
    &amp;quot;Zone péricentrale à forte densité&amp;quot;,
    &amp;quot;Zone de centre village&amp;quot;,
    &amp;quot;Zone centrale à très forte densité&amp;quot;,
    &amp;quot;Zone de centre historique&amp;quot;,                         
    &amp;quot;Zone aéroportuaire&amp;quot;
)

ggplot() + 
  geom_sf(data=communes_no_water_simplified) +
  geom_sf(data=zones %&amp;gt;% filter(LIBFVG %in% building_zones),
          fill=&amp;quot;grey&amp;quot;, color=NA)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-19-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;First thing to note: the area covered by the &lt;code&gt;zones&lt;/code&gt; polygons is way larger than our little Geneva canton. Previously we used &lt;code&gt;st_difference&lt;/code&gt; to find the non-overlapping area. This time, let’s use &lt;code&gt;st_intersection&lt;/code&gt; to find overlapping area and “crop” the &lt;code&gt;zones&lt;/code&gt; polygons to Geneva area. We will also slightly simplify the polygons with &lt;code&gt;ms_simplify&lt;/code&gt;, so they don’t look too detailled compared to our commune borders.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;buildings_geneva &amp;lt;-
  zones %&amp;gt;%
   filter(LIBFVG %in% building_zones) %&amp;gt;%
   ms_simplify(keep_shapes = T, keep=0.0001) %&amp;gt;%
   st_intersection(st_union(st_combine(communes_no_water_simplified)))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: attribute variables are assumed to be spatially constant
## throughout all geometries&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot() +
  geom_sf(data=communes_no_water_simplified) +
  geom_sf(data=buildings_geneva, fill=&amp;quot;grey&amp;quot;, color=NA)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-20-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;To plot the borders of the communes above the building areas, we can call &lt;code&gt;geom_sf&lt;/code&gt; twice rather than once. Remember that &lt;code&gt;ggplot&lt;/code&gt; chart work as stack of layers, so each additional &lt;code&gt;geom&lt;/code&gt; goes on top of the previous ones.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Create ggplot
ggplot() +
  # Add polygons for communes, default fill, no border
  geom_sf(data=communes_no_water_simplified, color=NA) +
  # Add polygons for buildings, fill grey, no border
  geom_sf(data=buildings_geneva, fill=&amp;quot;grey&amp;quot;, color=NA) +
  # Add polygons for communes, no fill, default border
  geom_sf(data=communes_no_water_simplified, fill=NA) +
  labs(title=&amp;quot;Geneva communes and buildings&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-21-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Let’s do the same with the forest areas. When I tried to use &lt;code&gt;st_intersection&lt;/code&gt; here, I got &lt;code&gt;TopologyException&lt;/code&gt; errors and warnings about &lt;code&gt;Self-intersection&lt;/code&gt;. Adding calls to &lt;code&gt;st_make_valid&lt;/code&gt; where you get these errors seems &lt;a href=&#34;https://github.com/r-spatial/sf/issues/347&#34;&gt;to fix the issues&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;forest_zones &amp;lt;- c(
    &amp;quot;Zone de verdure&amp;quot;
    ,&amp;quot;Zone naturelle ou forestière&amp;quot;
)

forests_geneva &amp;lt;-
  zones %&amp;gt;%
   filter(LIBFVG %in% forest_zones) %&amp;gt;%
   ms_simplify(keep=0.005) %&amp;gt;%
   st_make_valid() %&amp;gt;%
   st_intersection(st_union(st_combine(communes_no_water_simplified)))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: attribute variables are assumed to be spatially constant
## throughout all geometries&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot() +
  # Add polygons for communes, default fill, no border
  geom_sf(data=communes_no_water_simplified, color=NA) +
  # Add polygons for buildings, fill grey, no border
  geom_sf(data=buildings_geneva, fill=&amp;quot;grey&amp;quot;, color=NA) +
  # Add polygons for forests, fill grey, no border +
  geom_sf(data=forests_geneva, fill=&amp;quot;darkgreen&amp;quot;, alpha=0.2, color=NA)+
  # Add polygons borders for communes, no fill, default border
  geom_sf(data=communes_no_water_simplified, fill=NA) +
  labs(title=&amp;quot;Geneva communes, buildings and forests&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-22-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;If we got carried away, we could even add the agricultural fields to the map.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;fields_geneva &amp;lt;-
  zones %&amp;gt;%
   filter(LIBFVG == &amp;quot;Zone agricole ou viticole&amp;quot;) %&amp;gt;%
   ms_simplify(keep=0.005) %&amp;gt;%
   st_make_valid() %&amp;gt;%
   st_intersection(st_union(st_combine(communes_no_water_simplified)))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: attribute variables are assumed to be spatially constant
## throughout all geometries&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot() +
  # Add polygons for communes, default fill, no border
  geom_sf(data=communes_no_water_simplified, color=NA) +
  # Add polygons for forests, fill green, no border +
  geom_sf(data=forests_geneva, fill=&amp;quot;darkgreen&amp;quot;, alpha=0.2, color=NA)+
  # Add polygons for agricultural area
  geom_sf(data=fields_geneva, fill=&amp;quot;yellow&amp;quot;, alpha=0.1, color=NA)+
  # Add polygons for buildings, fill grey, no border
  geom_sf(data=buildings_geneva, fill=&amp;quot;grey&amp;quot;, color=NA) +
  # Add polygons borders for communes, no fill, default border
  geom_sf(data=communes_no_water_simplified, fill=NA) +
  labs(title=&amp;quot;Geneva communes, buildings, forests and fields&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-23-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;adding-lake-and-rivers-back&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Adding lake and rivers back&lt;/h2&gt;
&lt;p&gt;What if we decided to add waters back?&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot() +
  # Add lake and rivers
  geom_sf(data=waters, fill=&amp;quot;blue&amp;quot;, color=NA) + 
  # Add polygons for communes, default fill, no border
  geom_sf(data=communes_no_water_simplified, color=NA) +
  # Add polygons for forests, fill green, no border +
  geom_sf(data=forests_geneva, fill=&amp;quot;darkgreen&amp;quot;, alpha=0.2, color=NA)+
  # Add polygons for agricultural area
  geom_sf(data=fields_geneva, fill=&amp;quot;yellow&amp;quot;, alpha=0.1, color=NA)+
  # Add polygons for buildings, fill grey, no border
  geom_sf(data=buildings_geneva, fill=&amp;quot;grey&amp;quot;, color=NA) +
  # Add polygons borders for communes, no fill, default border
  geom_sf(data=communes_no_water_simplified, fill=NA) +
  labs(title=&amp;quot;Geneva communes, buildings, forests and fields&amp;quot;,
       subtitle=&amp;quot;Water is misaligned...&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-24-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Unfortunately, our water borders cannot match our simplified communes map. Even if we apply exactly the same &lt;code&gt;ms_simplify&lt;/code&gt;, it won’t do the trick.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;waters_simplified &amp;lt;-
  waters %&amp;gt;%
  ms_simplify(keep_shapes=T, keep=0.02)

ggplot() +
  # Add lake and rivers
  geom_sf(data=waters_simplified, fill=&amp;quot;blue&amp;quot;, color=NA) + 
  # Add polygons for communes, default fill, no border
  geom_sf(data=communes_no_water_simplified, color=NA) +
  # Add polygons for forests, fill green, no border +
  geom_sf(data=forests_geneva, fill=&amp;quot;darkgreen&amp;quot;, alpha=0.2, color=NA)+
  # Add polygons for agricultural area
  geom_sf(data=fields_geneva, fill=&amp;quot;yellow&amp;quot;, alpha=0.1, color=NA)+
  # Add polygons for buildings, fill grey, no border
  geom_sf(data=buildings_geneva, fill=&amp;quot;grey&amp;quot;, color=NA) +
  # Add polygons borders for communes, no fill, default border
  geom_sf(data=communes_no_water_simplified, fill=NA) +
  labs(title=&amp;quot;Geneva communes, buildings, forests and fields&amp;quot;,
       subtitle=&amp;quot;Water, even simplified, is still misaligned...&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-25-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The solution is to merge communes and water into the same &lt;code&gt;sf&lt;/code&gt; object before applying &lt;code&gt;ms_simplify&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;communes_and_water &amp;lt;- 
  communes %&amp;gt;%
  # remove waters from the original communes
  st_difference(st_union(st_combine(waters))) %&amp;gt;%
  # apply the same columns names so that we
  # can bind waters and communes sf objects
  rename(NOM=COMMUNE) %&amp;gt;%
  select(NOM, SHAPE_AREA, SHAPE_LEN) %&amp;gt;%
  # add the waters polygons
  rbind(waters) %&amp;gt;%
  # simplify
  ms_simplify(keep=0.01) %&amp;gt;%
  st_make_valid()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: attribute variables are assumed to be spatially constant
## throughout all geometries&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot() +
  geom_sf(data=communes_and_water) +
  labs(title=&amp;quot;Communes and waters in the same sf&amp;quot;,
       subtitle=&amp;quot;Simplifed together at 0.01&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-26-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Now that borders are aligned, we can split &lt;code&gt;communes&lt;/code&gt; and &lt;code&gt;water&lt;/code&gt; again. This makes cropping other &lt;code&gt;sf&lt;/code&gt; objects on communes, as well as applying different fill color much easier.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;communes_simplified &amp;lt;- 
  communes_and_water %&amp;gt;%
  filter(!(NOM %in% waters$NOM))

waters_simplified &amp;lt;- 
  communes_and_water %&amp;gt;%
  filter(NOM %in% waters$NOM)

buildings_geneva &amp;lt;-
  zones %&amp;gt;%
   filter(LIBFVG %in% building_zones) %&amp;gt;%
   ms_simplify(keep=0.005) %&amp;gt;%
   st_make_valid() %&amp;gt;%
   st_intersection(st_union(st_combine(communes_simplified)))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: attribute variables are assumed to be spatially constant
## throughout all geometries&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;forests_geneva &amp;lt;-
  zones %&amp;gt;%
   filter(LIBFVG %in% forest_zones) %&amp;gt;%
   ms_simplify(keep=0.005) %&amp;gt;%
   st_make_valid() %&amp;gt;%
   st_intersection(st_union(st_combine(communes_simplified)))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: attribute variables are assumed to be spatially constant
## throughout all geometries&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;fields_geneva &amp;lt;-
  zones %&amp;gt;%
   filter(LIBFVG == &amp;quot;Zone agricole ou viticole&amp;quot;) %&amp;gt;%
   ms_simplify(keep=0.005) %&amp;gt;%
   st_make_valid() %&amp;gt;%
   st_intersection(st_union(st_combine(communes_simplified)))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: attribute variables are assumed to be spatially constant
## throughout all geometries&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot() +
  # Add lake and rivers
  geom_sf(data=waters_simplified, fill=&amp;quot;lightblue&amp;quot;, color=NA) + 
  # Add polygons for communes, default fill, no border
  geom_sf(data=communes_simplified) +
  # Add polygons for forests, fill green, no border +
  geom_sf(data=forests_geneva, fill=&amp;quot;darkgreen&amp;quot;, alpha=0.2, color=NA)+
  # Add polygons for buildings, fill grey, no border
  geom_sf(data=buildings_geneva, fill=&amp;quot;grey&amp;quot;, color=NA) +
  # Add polygons for agricultural area
  geom_sf(data=fields_geneva, fill=&amp;quot;yellow&amp;quot;, alpha=0.1, color=NA)+
  # Add polygons borders for communes, no fill, default border
  geom_sf(data=communes_simplified, fill=NA) +
  labs(title=&amp;quot;Geneva communes, buildings and forests&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-27-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;some-more-styling&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Some more styling&lt;/h2&gt;
&lt;p&gt;A few final tweaks:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;add a caption to mention the source of the data&lt;/li&gt;
&lt;li&gt;add fill and border for smoother borders (I see some jagged lines in ubuntu)&lt;/li&gt;
&lt;li&gt;apply the &lt;code&gt;ipsum&lt;/code&gt; theme from Bob Rudis &lt;a href=&#34;https://github.com/hrbrmstr/hrbrthemes&#34;&gt;&lt;code&gt;hrbrthemes&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(hrbrthemes)

ggplot() +
  # Add lake and rivers
  geom_sf(data=waters_simplified, fill=&amp;quot;lightblue&amp;quot;, color=&amp;quot;lightblue&amp;quot;) + 
  # Add polygons for communes, default fill, no border
  geom_sf(data=communes_simplified) +
  # Add polygons for forests, fill green, no border +
  geom_sf(data=forests_geneva, fill=&amp;quot;lightgreen&amp;quot;, color=&amp;quot;lightgreen&amp;quot;) +
   # Add polygons for agricultural area
  geom_sf(data=fields_geneva, fill=&amp;quot;lightyellow&amp;quot;, color=&amp;quot;lightyellow&amp;quot;) +
  # Add polygons for buildings, fill grey, no border
  geom_sf(data=buildings_geneva, fill=&amp;quot;lightgrey&amp;quot;, color=&amp;quot;lightgrey&amp;quot;) +
  # Add polygons borders for communes, no fill, default border
  geom_sf(data=communes_simplified, fill=NA, size=0.5, color=&amp;quot;darkgrey&amp;quot;) +
  labs(title=&amp;quot;Geneva Land Use&amp;quot;,
       subtitle=&amp;quot;showing communes, buildings, forests and fields&amp;quot;,
       caption=&amp;quot;Datasets from http://ge.ch/sitg/.&amp;quot;) +
  theme_ipsum()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/170915-map-ggplot-sf_files/figure-html/unnamed-chunk-28-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;some-more-ressources&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Some more ressources&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://robinlovelace.net/geocompr/&#34;&gt;Geocomputation with R&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://robinlovelace.net/presentations/spatial-tidyverse.html#1&#34;&gt;Spatial data and the tidyverse&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://bhaskarvk.github.io/user2017.geodataviz/?utm_content=buffer7427d&amp;amp;utm_medium=social&amp;amp;utm_source=twitter.com&amp;amp;utm_campaign=buffer&#34;&gt;GeoSpatial Data Visualization in R&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://r-spatial.org/r/2017/08/28/nest.html&#34;&gt;Tidy storm trajectories&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Scraping javascript generated content with splashr</title>
      <link>/2017/07/26/scraping-javascript-generated-content-with-splashr/</link>
      <pubDate>Wed, 26 Jul 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/07/26/scraping-javascript-generated-content-with-splashr/</guid>
      <description>&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;While scraping rental listings, it’s useful to verify that the scripts managed to grab all the offers. This is nice to have on simple &lt;a href=&#34;https://www.moservernet.ch/en/apartments-for-rent/&#34;&gt;fully loaded single page&lt;/a&gt;, but even nicer if the rental listings are set up as a &lt;a href=&#34;http://www.brolliet.ch/en/rent/&#34;&gt;infinite scroll page&lt;/a&gt;, which seem increasingly popular on real estate websites and require multiple calls from the scraper.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1707263-scrsh-count-msrvrn.png&#34; alt=&#34;Count of offers on rental websites.&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Count of offers on rental websites.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Even when they don’t load all the results, the websites nearly always indicate the number of matched offers. This can be used to verify that our final dataset has the correct number of rows.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;scraping-the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Scraping the data&lt;/h2&gt;
&lt;div id=&#34;scraping-static-content&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Scraping static content&lt;/h3&gt;
&lt;p&gt;Using &lt;a href=&#34;https://xvrdm.github.io/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/&#34;&gt;our previous example&lt;/a&gt;, we can see that the number of matched offers is written on the page.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1707261-scrsh-count-msrvrn.png&#34; alt=&#34;Count of offers can be found on the page.&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Count of offers can be found on the page.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Please keep in mind that I took the screenshot when I originally published the post and reran the code multiple times since. So the final scraped number might not match the screenshot.&lt;/p&gt;
&lt;p&gt;Inspect the html of the page to find the id/class of the number of results and store it in a variable. We can complete the code as below:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Load needed packages
suppressMessages(library(xml2))
suppressMessages(library(rvest))

# Create an html document
listing_url &amp;lt;- &amp;quot;https://www.moservernet.ch/en/apartments-for-rent/&amp;quot;
listing_html &amp;lt;- xml2::read_html(listing_url)

# Find the number of listed offers
listing_html %&amp;gt;%
  html_node(&amp;quot;#count-search&amp;quot;) %&amp;gt;%
  html_text()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;()&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Empty? It looks like the count is actually populated by a tiny bit of javascript, so it’s not available when we parse the page source.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1707262-scrsh-js-msrvrn.png&#34; alt=&#34;The counter is updated by Javascript.&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;The counter is updated by Javascript.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;scraping-content-generated-by-javascript&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Scraping content generated by javascript&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;xml2::read_html&lt;/code&gt; by itself cannot inspect the content generated by javascript. For that we can use another library &lt;a href=&#34;https://github.com/hrbrmstr/splashr&#34;&gt;&lt;code&gt;splashr&lt;/code&gt;&lt;/a&gt;. In a nutshell, &lt;code&gt;splashr&lt;/code&gt; lets you spin and interact with a &lt;a href=&#34;https://splash.readthedocs.io/en/stable/&#34;&gt;splash&lt;/a&gt; headless browser in a &lt;a href=&#34;https://www.docker.com/&#34;&gt;docker&lt;/a&gt; container. If this sounds like jibberish, let’s try a translation:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;“spin and interact with a headless browser”: create a virtual browser (we won’t see it, it happens in the background) that will browse/render the page and give us back it’s content (including the javascript generated content). “Splash” is one these headless browsers, but you might have heard of another one named “phantomJS”.&lt;/li&gt;
&lt;li&gt;“in a docker container”: think of docker is a way to easily run lightweight virtual machines (called container). So rather than installing splash and all its python dependencies, we will run a virtual machine with splash installed in it and destroy it when we are done, leaving our main system untouched.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Installing docker is beyond the scope of this post, but there are tons of ressource online. At the time of this writing, to install &lt;a href=&#34;https://github.com/hrbrmstr/splashr&#34;&gt;&lt;code&gt;splashr&lt;/code&gt;&lt;/a&gt; and &lt;a href=&#34;https://github.com/bhaskarvk/docker&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the package that manages docker from R), you need to grab them from github.&lt;/p&gt;
&lt;p&gt;The github page of &lt;a href=&#34;https://github.com/bhaskarvk/docker&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the R package) explains how to install the python package &lt;a href=&#34;https://docker-py.readthedocs.io/en/stable/&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt;. Yes, you read that well: in order to use &lt;a href=&#34;http://splash.readthedocs.io&#34;&gt;&lt;code&gt;splash&lt;/code&gt;&lt;/a&gt; (the scrapping python lib), &lt;a href=&#34;https://github.com/hrbrmstr/%5Bsplashr&#34;&gt;&lt;code&gt;splashr&lt;/code&gt;&lt;/a&gt; uses:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/bhaskarvk/docker&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the R package),
&lt;ul&gt;
&lt;li&gt;which uses &lt;a href=&#34;https://docker-py.readthedocs.io/en/stable/&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the python lib installed in a virtualenv named &lt;code&gt;docker&lt;/code&gt;),
&lt;ul&gt;
&lt;li&gt;which uses &lt;a href=&#34;https://www.docker.com/&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the container engine).&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So proceed in steps:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Install &lt;a href=&#34;https://www.docker.com/&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the engine)&lt;/li&gt;
&lt;li&gt;Install &lt;a href=&#34;https://docker-py.readthedocs.io/en/stable/&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the python lib) in a virtualenv like explained &lt;a href=&#34;https://github.com/bhaskarvk/docker&#34;&gt;here&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Install the R packages&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;devtools::install_github(&amp;quot;bhaskarvk/docker&amp;quot;)
devtools::install_github(&amp;quot;hrbrmstr/splashr&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;ol start=&#34;4&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Let RStudio know that you want python commands to be run in this virtualenv&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Use the path where you installed the docker venv
library(reticulate)
use_virtualenv(&amp;quot;~/.virtualenv/docker&amp;quot;, required=T)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The very first time we run &lt;code&gt;splashr&lt;/code&gt;, it might be a bit slow: it will have to download the docker image (the template used to create container) that has &lt;code&gt;Splash&lt;/code&gt; installed in it. The image is documented &lt;a href=&#34;https://hub.docker.com/r/hrbrmstr/splashttpd/&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(splashr))
install_splash()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Pulling from scrapinghub/splash&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Digest: sha256:08c9b401fb812c9bf6591773c88c73b0c535336b97dd1ac04f9dbb988b2a7f76&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Status: Image is up to date for scrapinghub/splash:3.0&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can then use &lt;code&gt;splashr&lt;/code&gt; to create a &lt;code&gt;splash&lt;/code&gt; container and get the &lt;code&gt;html&lt;/code&gt;, this time with javascript generated content in it. The &lt;code&gt;xml2&lt;/code&gt; functions can still be used on the html returned by &lt;code&gt;splashr&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I added a wait time of two seconds between &lt;code&gt;start_splash&lt;/code&gt; and &lt;code&gt;render_html&lt;/code&gt; because I kept getting errors looking like &lt;code&gt;render_html&lt;/code&gt; was called before the container was fully operational.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;splash_container &amp;lt;- splashr::start_splash()
Sys.sleep(2)
listing_html_js &amp;lt;- splashr::render_html(url = listing_url)

count &amp;lt;- listing_html_js %&amp;gt;%
  html_node(&amp;quot;#count-search&amp;quot;) %&amp;gt;%
  html_text()
print(paste(&amp;quot;count value is:&amp;quot;, count))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;count value is: (21 results)&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The number is extracted with a little regular expression and the &lt;code&gt;stringr&lt;/code&gt; package:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;offer_number &amp;lt;- stringr::str_extract(count, &amp;quot;[0-9]+&amp;quot;) 
print(paste(&amp;quot;offer_number value is:&amp;quot;, offer_number))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;offer_number value is: 21&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Don’t forget to stop and delete your container.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;stop_splash(splash_container)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We now have the expected number of offers, which we can use to verify our final dataset (read &lt;a href=&#34;https://xvrdm.github.io/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/&#34;&gt;previous post&lt;/a&gt; to see how).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Testing Flask SQLAlchemy database with pytest</title>
      <link>/2017/07/03/testing-flask-sqlalchemy-database-with-pytest/</link>
      <pubDate>Mon, 03 Jul 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/07/03/testing-flask-sqlalchemy-database-with-pytest/</guid>
      <description>&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;http://testdriven.io/part-one-test-setup/&#34;&gt;Early in the tutorial&lt;/a&gt;, the author explains how to set up your app to use &lt;a href=&#34;https://docs.python.org/3/library/unittest.html&#34;&gt;&lt;code&gt;unittest&lt;/code&gt;&lt;/a&gt; and the &lt;a href=&#34;https://github.com/jarus/flask-testing&#34;&gt;&lt;code&gt;Flask-Testing&lt;/code&gt;&lt;/a&gt; extension for its test framework. Since I wanted to use &lt;a href=&#34;https://docs.pytest.org/en/latest/&#34;&gt;&lt;code&gt;pytest&lt;/code&gt;&lt;/a&gt;, this was a good opportunity to explore the test setup a bit more in depth.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;running-pytest-from-a-script&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Running pytest from a script&lt;/h2&gt;
&lt;p&gt;Firstly, add &lt;code&gt;pytest&lt;/code&gt; to your &lt;code&gt;requirements.txt&lt;/code&gt; and place a dummy test in the &lt;code&gt;project/tests&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;def test_dummy():
    assert True&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Secondly, add a &lt;code&gt;manager.command&lt;/code&gt; to &lt;code&gt;manage.py&lt;/code&gt; that run the pytest tests.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# manage.py
import pytest
@manager.command
def test():
    &amp;quot;&amp;quot;&amp;quot;Runs the tests.&amp;quot;&amp;quot;&amp;quot;
    pytest.main([&amp;quot;-s&amp;quot;, &amp;quot;project/tests&amp;quot;])&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Some notes: - To find info on calling pytest directly from python code, go &lt;a href=&#34;https://docs.pytest.org/en/latest/usage.html#calling-pytest-from-python-code&#34;&gt;here&lt;/a&gt; - I first tried to just run &lt;code&gt;pytest.main()&lt;/code&gt; and ended up with some “File not found” error. You need to provide an empty list &lt;code&gt;[]&lt;/code&gt; at the very least. The error is discussed more in depth &lt;a href=&#34;https://github.com/pytest-dev/pytest/issues/1110&#34;&gt;here&lt;/a&gt;. - Running &lt;code&gt;pytest.main([])&lt;/code&gt; with an empty list will look for test everywhere in your project. If you have placed the &lt;code&gt;env&lt;/code&gt; dir in &lt;code&gt;/project&lt;/code&gt;, with all the sources of your virtual environment packages, you might find tons of tests that you did not want to touch. Therefore, it’s better to target specifically the &lt;code&gt;project/tests&lt;/code&gt; dir with the last argument &lt;code&gt;project/tests&lt;/code&gt;. - Adding &lt;code&gt;-s&lt;/code&gt; to the pytest command lets pytest print to the console any print statements that you use in your tests, not just the ones from failing tests.&lt;/p&gt;
&lt;p&gt;We can now run the test on the running containers with:&lt;/p&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;$ docker-compose run users-service python manage.py test 

== test session starts ==
platform linux -- Python 3.6.1, pytest-3.1.2, py-1.4.34, pluggy-0.4.0
rootdir: /usr/src/app, inifile:
collected 1 items 

project/tests/test_ping.py .

== 1 passed in 0.01 seconds ==&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;creating-an-app-fixture&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Creating an app fixture&lt;/h2&gt;
&lt;p&gt;In the tutorial, the author creates the class &lt;code&gt;BaseTestCase&lt;/code&gt; in &lt;code&gt;project/tests/base.py&lt;/code&gt;, which imports the &lt;code&gt;app&lt;/code&gt; from &lt;code&gt;project&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# http://testdriven.io/part-one-test-setup/
# project/tests/base.py 
[...]
from project import app, db


class BaseTestCase(TestCase):
    def create_app(self):
        app.config.from_object(&amp;#39;project.config.TestingConfig&amp;#39;)
        return app
[...]&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This &lt;code&gt;app&lt;/code&gt; instance can then be used in our different tests, without needing to reimport the app for each test. At the beginning of its &lt;code&gt;project/tests/test_users.py&lt;/code&gt;, you can see that the class &lt;code&gt;TestUserService&lt;/code&gt; inherits from &lt;code&gt;BaseTestCase&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# http://testdriven.io/part-one-test-setup/
# project/tests/test_users.py 
[...]
from project.tests.base import BaseTestCase


class TestUserService(BaseTestCase):
[...]&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Reusable objects for tests are called fixtures. In &lt;code&gt;unittest&lt;/code&gt;, fixtures are defined as classes with two special functions &lt;code&gt;setUp&lt;/code&gt; and &lt;code&gt;tearDown&lt;/code&gt;, that are &lt;a href=&#34;https://docs.python.org/3/library/unittest.html#organizing-test-code&#34;&gt;executed before/after each test&lt;/a&gt;. &lt;a href=&#34;https://docs.pytest.org/en/latest/fixture.html&#34; class=&#34;uri&#34;&gt;https://docs.pytest.org/en/latest/fixture.html&lt;/a&gt;). We will cover their pytest implementations later.&lt;/p&gt;
&lt;p&gt;Rather than importing the app, we will first move the code to the &lt;a href=&#34;http://flask.pocoo.org/docs/0.12/patterns/appfactories/&#34;&gt;Application Factories pattern&lt;/a&gt; (also used in the tutorial &lt;a href=&#34;http://testdriven.io/part-one-flask-blueprints/&#34;&gt;soon after&lt;/a&gt;). Rewrite your &lt;code&gt;project/__init__.py&lt;/code&gt; as below:&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# project/__init__.py
import os
from flask import Flask
from flask_sqlalchemy import SQLAlchemy


db = SQLAlchemy()


class User(db.Model):
    __tablename__ = &amp;quot;users&amp;quot;
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    username = db.Column(db.String(128), nullable=False)
    email = db.Column(db.String(128), nullable=False)
    active = db.Column(db.Boolean(), default=False, nullable=False)
    created_at = db.Column(db.DateTime, nullable=False)

    def __init__(self, username, email):
        self.username = username
        self.email = email
        self.created_at = datetime.datetime.now()


def create_app():
    app = Flask(__name__)

    app_settings = os.getenv(&amp;#39;APP_SETTINGS&amp;#39;)
    app.config.from_object(app_settings)

    db.init_app(app)

    @app.route(&amp;#39;/ping&amp;#39;, methods=[&amp;#39;GET&amp;#39;])
    def ping_pong():
        return jsonify({
            &amp;#39;status&amp;#39;: &amp;#39;Epic success&amp;#39;,
            &amp;#39;message&amp;#39;: &amp;#39;pong!&amp;#39;
        })

    return app&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We now have a &lt;code&gt;create_app()&lt;/code&gt; function, that can return an &lt;code&gt;app&lt;/code&gt; instance. In pytest, fixture are defined as function, with the &lt;code&gt;@pytest.fixture&lt;/code&gt; decorator.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# project/tests/conftest.py
import pytest
from project import create_app


@pytest.fixture
def app():
    app = create_app()
    app.config.from_object(&amp;#39;project.config.TestingConfig&amp;#39;)
    return app&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Tests in pytest are also just function, named with the prefix &lt;code&gt;test_&lt;/code&gt;. To use a fixture in a test, just add it as an argument. Note that assertions are simpler than in unittest, you only need the &lt;code&gt;assert&lt;/code&gt; function.&lt;/p&gt;
&lt;p&gt;Test the different configurations:&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# project/tests/test_config.py
import os


def test_development_config(app):
    app.config.from_object(&amp;#39;project.config.DevelopmentConfig&amp;#39;)
    assert app.config[&amp;#39;DEBUG&amp;#39;]
    assert not app.config[&amp;#39;TESTING&amp;#39;]
    assert app.config[&amp;#39;SQLALCHEMY_DATABASE_URI&amp;#39;] == os.environ.get(
        &amp;#39;DATABASE_URL&amp;#39;)


def test_testing_config(app):
    app.config.from_object(&amp;#39;project.config.TestingConfig&amp;#39;)
    assert app.config[&amp;#39;DEBUG&amp;#39;]
    assert app.config[&amp;#39;TESTING&amp;#39;]
    assert not app.config[&amp;#39;PRESERVE_CONTEXT_ON_EXCEPTION&amp;#39;]
    assert app.config[&amp;#39;SQLALCHEMY_DATABASE_URI&amp;#39;] == os.environ.get(
        &amp;#39;DATABASE_TEST_URL&amp;#39;)


def test_production_config(app):
    app.config.from_object(&amp;#39;project.config.ProductionConfig&amp;#39;)
    assert not app.config[&amp;#39;DEBUG&amp;#39;]
    assert not app.config[&amp;#39;TESTING&amp;#39;]
    assert app.config[&amp;#39;SQLALCHEMY_DATABASE_URI&amp;#39;] == os.environ.get(
        &amp;#39;DATABASE_URL&amp;#39;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Testing the ping route (using &lt;a href=&#34;http://flask.pocoo.org/docs/0.12/api/#flask.Flask.test_client&#34;&gt;&lt;code&gt;test_client()&lt;/code&gt;&lt;/a&gt; to get a &lt;code&gt;client&lt;/code&gt; that can test routes):&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# project/tests/test_ping.py
import json


def test_ping(app):
    client = app.test_client()
    resp = client.get(&amp;#39;/ping&amp;#39;)
    data = json.loads(resp.data.decode())
    assert resp.status_code == 200
    assert &amp;#39;pong&amp;#39; in data[&amp;#39;message&amp;#39;]
    assert &amp;#39;success&amp;#39; in data[&amp;#39;status&amp;#39;]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;accessing-the-database-from-the-tests&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Accessing the database from the tests&lt;/h2&gt;
&lt;div id=&#34;making-tables-accessible-with-create_all&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Making tables accessible with &lt;code&gt;create_all()&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;So far we haven’t put any code related to the database in our &lt;code&gt;app&lt;/code&gt; fixture. The tutorial has done so in &lt;code&gt;BaseTestCase&lt;/code&gt;. If we rewrite the &lt;a href=&#34;http://testdriven.io/part-one-restful-routes/&#34;&gt;&lt;code&gt;test_add_user&lt;/code&gt;&lt;/a&gt; for pytest and try to run it, we get an error.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# project/tests/test_users.py
def test_add_user(app):
    &amp;quot;&amp;quot;&amp;quot;Ensure a new user can be added to the database.&amp;quot;&amp;quot;&amp;quot;
    with app.test_client() as client:
        response = client.post(
            &amp;#39;/users&amp;#39;,
            data=json.dumps(dict(
                username=&amp;#39;michael&amp;#39;,
                email=&amp;#39;michael@realpython.com&amp;#39;
            )),
            content_type=&amp;#39;application/json&amp;#39;,
        )
        data = json.loads(response.data.decode())
        assert response.status_code == 201
        assert &amp;#39;michael@realpython.com was added!&amp;#39; in data[&amp;#39;message&amp;#39;]
        assert &amp;#39;success&amp;#39; in data[&amp;#39;status&amp;#39;]&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;$ docker-compose run users-service python manage.py test_app
[...]
======= FAILURES ======
____ test_add_user ____
[...]
sqlalchemy.exc.ProgrammingError: (psycopg2.ProgrammingError) relation &amp;quot;users&amp;quot; does not exist&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So our app fixture knows about sql alchemy but hasn’t created the tables needed for our user model. From the &lt;a href=&#34;http://flask-sqlalchemy.pocoo.org/2.1/contexts/&#34;&gt;Flask-SQLAlchemy documentation&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;What it (init_db) does is prepare the application to work with SQLAlchemy. However that does not now bind the SQLAlchemy object to your application.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Let’s jump in an python shell and try to see how we can bind our &lt;code&gt;db&lt;/code&gt; object to our &lt;code&gt;app&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;$ docker exec -ti users-service bash
root@910656bc5f75:/usr/src/app# python3
&amp;gt;&amp;gt;&amp;gt; from project import create_app, db
&amp;gt;&amp;gt;&amp;gt; app = create_app()
&amp;gt;&amp;gt;&amp;gt; app
&amp;lt;Flask &amp;#39;project&amp;#39;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; db
&amp;lt;SQLAlchemy engine=None&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So &lt;code&gt;create_app()&lt;/code&gt; gives us an app object, but the imported &lt;code&gt;db&lt;/code&gt; isn’t connected to it out-of-the-box (it has no engine). If we jump into the &lt;a href=&#34;http://flask-sqlalchemy.pocoo.org/2.1/contexts/&#34;&gt;app context&lt;/a&gt;, the engine gets populated.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;&amp;gt;&amp;gt;&amp;gt; app_ctx = app.app_context()
&amp;gt;&amp;gt;&amp;gt; app_ctx.push()  # jump into the app context
&amp;gt;&amp;gt;&amp;gt; db
&amp;lt;SQLAlchemy engine=&amp;#39;postgres://postgres:postgres@users-db:5432/users_dev&amp;#39;&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;However, &lt;code&gt;db&lt;/code&gt; still doesn’t have tables and running tests at this stage would keep saying that &lt;code&gt;relation users does not exist&lt;/code&gt;. That’s why we need &lt;code&gt;create_table()&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;&amp;gt;&amp;gt;&amp;gt; db.engine.table_names()  # Check the tables currently on the engine
[]                           # no table found
&amp;gt;&amp;gt;&amp;gt; db.create_all()          # Create the tables according to defined models
&amp;gt;&amp;gt;&amp;gt; db.engine.table_names()
[&amp;#39;users&amp;#39;]                    # Now table &amp;#39;users&amp;#39; is found&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can now update our &lt;code&gt;app&lt;/code&gt; fixture:&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# project/tests/conftest.py
import pytest
from project import create_app, db


@pytest.fixture
def app():
    app = create_app()
    app.config.from_object(&amp;#39;project.config.TestingConfig&amp;#39;)
    with app.app_context():   
        # alternative pattern to app.app_context().push()
        # all commands indented under &amp;#39;with&amp;#39; are run in the app context 
        db.create_all()
        return app&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;cleaning-database-with-drop_all&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Cleaning database with &lt;code&gt;drop_all()&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Let’s check the impact of our tests on the database. Before running tests:&lt;/p&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;$ docker exec -ti $(docker ps -aqf &amp;quot;name=users-db&amp;quot;) psql -U postgres

psql (9.6.3)
postgres=# \c users_dev
You are now connected to database &amp;quot;users_dev&amp;quot; as user &amp;quot;postgres&amp;quot;.
users_dev=# \dt
No relations found.
users_dev=# \c users_test
You are now connected to database &amp;quot;users_test&amp;quot; as user &amp;quot;postgres&amp;quot;.
users_test=# \dt
No relations found.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After running tests:&lt;/p&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;# Running pytest
$ docker-compose run users-service python manage.py test_app
[... Output of pytest ...]
========= 5 passed in 0.17 seconds =========

# Checking the database
$ docker exec -ti $(docker ps -aqf &amp;quot;name=users-db&amp;quot;) psql -U postgres

psql (9.6.3)
postgres=# \c users_dev
You are now connected to database &amp;quot;users_dev&amp;quot; as user &amp;quot;postgres&amp;quot;.
users_dev=# \dt
No relations found.
users_dev=# \c users_test
You are now connected to database &amp;quot;users_test&amp;quot; as user &amp;quot;postgres&amp;quot;.
users_test=# \dt
users_test=# \dt
         List of relations
 Schema | Name  | Type  |  Owner   
--------+-------+-------+----------
 public | users | table | postgres
(1 row)

users_test=# SELECT * FROM users;
 id | username |         email          | active |         created_at         
----+----------+------------------------+--------+----------------------------
  1 | michael  | michael@realpython.com | f      | 2017-07-04 09:23:43.34457&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can see that the users table was successfully created in the &lt;code&gt;users_test&lt;/code&gt; database, which we selected in &lt;code&gt;conftest.py&lt;/code&gt;. A user was also successfully inserted. However, if we run the tests again and recheck the table, we can see how trouble is starting to creep in:&lt;/p&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;# Running test 
[...]

# Checking the database
[...]
users_test=# SELECT * FROM users;
 id | username |         email          | active |         created_at         
----+----------+------------------------+--------+----------------------------
  1 | michael  | michael@realpython.com | f      | 2017-07-04 09:23:43.34457
  2 | michael  | michael@realpython.com | f      | 2017-07-04 09:24:55.972571
(2 rows)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We are not cleaning up the database after our tests. To do so, we need to add &lt;code&gt;drop_all()&lt;/code&gt; as a tear-down action for our app fixture (after &lt;code&gt;yield&lt;/code&gt;). This will not only empty the table rows, but also delete the table itself:&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# project/tests/conftest.py
import pytest
from project import create_app, db


@pytest.fixture
def app():
    app = create_app()
    app.config.from_object(&amp;#39;project.config.TestingConfig&amp;#39;)
    with app.app_context():   
        db.create_all()
        yield app   # Note that we changed return for yield, see below for why
        db.drop_all()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For the first time, we added a command (&lt;code&gt;db.drop_all()&lt;/code&gt;) that needed to be executed after the test using the fixture. Previously we used &lt;code&gt;return&lt;/code&gt; to get the app out of the fixture. But using &lt;code&gt;return&lt;/code&gt; means ending the function. That’s where &lt;code&gt;yield&lt;/code&gt; comes to the rescue. Unlike &lt;code&gt;unittest&lt;/code&gt;, &lt;code&gt;pytest&lt;/code&gt; does not put setup and teardown code in dedicated function. Everything that comes before &lt;code&gt;return&lt;/code&gt;/&lt;code&gt;yield&lt;/code&gt; is setup code, everything that comes after &lt;code&gt;yield&lt;/code&gt; is teardown code. Documentation is &lt;a href=&#34;https://docs.pytest.org/en/latest/fixture.html#fixture-finalization-executing-teardown-code&#34;&gt;here&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;By using a yield statement instead of return, all the code after the yield statement serves as the teardown code.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;If you try to run tests again, you will see that the database is left clean.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;avoid-locking-postgres-with-db.session.remove&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Avoid locking postgres with &lt;code&gt;db.session.remove()&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;This is the part I still have trouble understanding. Using the fixture above, &lt;code&gt;pytest&lt;/code&gt; started hanging indefinitely at random test (usually at tests that touched the database several times, but not always). When it happened, I could not even stop &lt;code&gt;pytest&lt;/code&gt; and had to restart the container.&lt;/p&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;$ docker-compose run users-service python manage.py test_app
===== test session starts =====
[...]
project/tests/test_configs.py ...
project/tests/test_users.py ..

hanging... hanging... hanging...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;From this &lt;a href=&#34;https://stackoverflow.com/questions/26350911/what-to-do-when-a-py-test-hangs-silently&#34;&gt;SO question&lt;/a&gt;, I got the confirmation that postgres might be locked. Using &lt;a href=&#34;https://www.devopsderek.com/blog/2012/11/13/list-and-disconnect-postgresql-db-sessions/&#34;&gt;the commands listed on devopsderek.com&lt;/a&gt;, it is possible to look at the sessions active while pytest is locked. Below we can see that one is blocked with the state &lt;a href=&#34;https://stackoverflow.com/questions/51019/what-does-it-mean-when-a-postgresql-process-is-idle-in-transaction&#34;&gt;“idle in transaction”&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;# Checking the database while pytest is hanging
$ docker exec -ti $(docker ps -aqf &amp;quot;name=users-db&amp;quot;) psql -U postgres
postgres=# SELECT * FROM pg_stat_activity;

datid |  datname   | pid | ... | state               | ... | query
------+------------+-----+-----+---------------------+-----+-
[... lots of sessions ...]
16386 | users_test | 200 | ... | idle in transaction | ... | SELECT users.id...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Killing the session manually in postgres did also kill &lt;code&gt;pytest&lt;/code&gt; without needing to restart the container.&lt;/p&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;# Still in psql
postgres=# SELECT pg_terminate_backend(200);
 pg_terminate_backend 
----------------------
 t
(1 row)&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;# In the terminal running pytest
psycopg2.OperationalError: terminating connection due to administrator command
server closed the connection unexpectedly
    This probably means the server terminated abnormally
    before or while processing the request.
$ # free to type again&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Still following &lt;a href=&#34;https://stackoverflow.com/questions/26350911/what-to-do-when-a-py-test-hangs-silently&#34;&gt;SO advice&lt;/a&gt;, you can explicitly close the connection after each test, which solves the issue.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# project/tests/conftest.py
import pytest
from project import create_app, db


@pytest.fixture
def app():
    app = create_app()
    app.config.from_object(&amp;#39;project.config.TestingConfig&amp;#39;)
    with app.app_context():   
        db.create_all()
        yield app  
        db.session.remove()  # looks like db.session.close() would work as well
        db.drop_all()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We end up very close to the &lt;a href=&#34;http://testdriven.io/part-one-test-setup/&#34;&gt;testdriven.io example&lt;/a&gt; for &lt;code&gt;unittest&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# project/tests/base.py on http://testdriven.io/part-one-test-setup/
from flask_testing import TestCase

from project import app, db


class BaseTestCase(TestCase):
    def create_app(self):  # done in our pytest fixture before yield
        app.config.from_object(&amp;#39;project.config.TestingConfig&amp;#39;)
        return app
        
    def setUp(self):  # done in our pytest fixture before yield
        db.create_all()
        db.session.commit()

    def tearDown(self): # done in our pytest fixture after yield
        db.session.remove()
        db.drop_all()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I just haven’t found the reason why &lt;code&gt;db.session.commit()&lt;/code&gt; would be necessary (although I suspect it might be an alternative to explicitely declaring the app context like we did in &lt;code&gt;with&lt;/code&gt;). I will update the post when I understand it better.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Clojure for pythonista - Manipulating strings</title>
      <link>/2017/06/13/clojure-for-pythonista---manipulating-strings/</link>
      <pubDate>Tue, 13 Jun 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/06/13/clojure-for-pythonista---manipulating-strings/</guid>
      <description>&lt;div id=&#34;foreword&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Foreword&lt;/h2&gt;
&lt;p&gt;I am trying to learn clojure. This series of posts is my attempt to solve beginner exercises both in python and clojure. Exercises are inspired by the excellent Reuven Lerner’s &lt;a href=&#34;https://practicemakespython.com/&#34;&gt;Practice Makes Python&lt;/a&gt; and other sources like &lt;a href=&#34;https://learnpythonthehardway.org/&#34;&gt;Learn python the hard way&lt;/a&gt;. Before trying any exercises, you can read an excellent introduction to clojure : &lt;a href=&#34;http://www.braveclojure.com/do-things/&#34;&gt;Brave Clojure&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;This exercise introduces ways to deal with strings.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;goal&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Goal&lt;/h2&gt;
&lt;p&gt;Create a command line script that asks the user to enter a word, sort the letters in alphabetic order and output the sentence “Your letters are: &lt;word-in-alphabetic-order&gt;”. The idea is to play both with characters sequence and string interpolation.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;reordering-letters&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Reordering letters&lt;/h2&gt;
&lt;div id=&#34;reordering-letters-in-python&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Reordering letters in python&lt;/h3&gt;
&lt;p&gt;In python, strings are treated like sequences of characters, so you can iterate over them like you would do on a list. There is no character type and functions that “reclaim” character as argument (e.g &lt;code&gt;ord()&lt;/code&gt;, which gives the unicode code point) are in fact asking for &lt;a href=&#34;https://docs.python.org/3/library/functions.html#ord&#34;&gt;strings of one character&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
ord(&amp;#39;bla&amp;#39;)
&amp;gt; TypeError: ord() expected a character, but string of length 3 found&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
ord(&amp;#39;a&amp;#39;)
&amp;gt; 97
ord(&amp;#39;b&amp;#39;)
&amp;gt; 98&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;When using operators like greater-than or smaller-than on characters, the unicode code points are compared (so no need to use &lt;code&gt;ord()&lt;/code&gt;).&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
&amp;#39;a&amp;#39; &amp;lt; &amp;#39;b&amp;#39;
&amp;gt; True&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Although strings are iterable like lists, they don’t have all the list’s functions. For example, you cannot use &lt;code&gt;.sort()&lt;/code&gt; on a string. You would have to convert it to a list first with &lt;code&gt;list()&lt;/code&gt;. Note that &lt;code&gt;.sort()&lt;/code&gt; changes the list in place and return &lt;code&gt;None&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
my_str = &amp;quot;bla&amp;quot;
my_str.sort()
&amp;gt; AttributeError: &amp;#39;str&amp;#39; object has no attribute &amp;#39;sort&amp;#39;

my_str = list(my_str)
my_str
&amp;gt; [&amp;#39;b&amp;#39;, &amp;#39;l&amp;#39;, &amp;#39;a&amp;#39;]
my_str.sort()
my_str
&amp;gt; [&amp;#39;a&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;l&amp;#39;]&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To make things simpler, python has the &lt;code&gt;sorted&lt;/code&gt; function, which work on any iterable, not just list. It also has the benefit of returning a new list rather than changing the list in-place.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
sorted(&amp;quot;bla&amp;quot;)
&amp;gt; [&amp;#39;a&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;l&amp;#39;]&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For more info on the difference between &lt;code&gt;.sort()&lt;/code&gt; and &lt;code&gt;sorted&lt;/code&gt;, read this &lt;a href=&#34;https://stackoverflow.com/questions/22442378/what-is-the-difference-between-sortedlist-vs-list-sort-python&#34;&gt;SO thread&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Both &lt;code&gt;.sort()&lt;/code&gt; and &lt;code&gt;sorted&lt;/code&gt; return list of characters. To convert this list back to a normal string, we can use &lt;a href=&#34;https://docs.python.org/3/library/stdtypes.html?highlight=join#str.join&#34;&gt;&lt;code&gt;str.join(iterable)&lt;/code&gt;&lt;/a&gt;. Note that &lt;code&gt;str&lt;/code&gt; here refers to the separator that will be placed between each element of the iterable.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
&amp;quot;&amp;quot;.join(sorted(&amp;quot;bla&amp;quot;))
&amp;gt; &amp;#39;abl&amp;#39;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;reordering-letters-in-clojure&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Reordering letters in clojure&lt;/h3&gt;
&lt;p&gt;In clojure, there is a character type, which is different than the string type. Strings (even with only one character) are delimited by double quotes. Characters have a &lt;code&gt;\&lt;/code&gt; prefix.&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(= &amp;quot;a&amp;quot; &amp;quot;a&amp;quot;)
&amp;gt; true

(= \a \a)
&amp;gt; true

(= &amp;quot;a&amp;quot; \a)
&amp;gt; false

(type &amp;quot;a&amp;quot;)
&amp;gt; java.lang.String

(type \a)
&amp;gt; java.lang.Character&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Operators like greater-than or smaller-than don’t work on strings or characters.&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(&amp;gt; \a &amp;quot;a&amp;quot;)
&amp;gt; java.lang.ClassCastException: 
&amp;gt; java.lang.String cannot be cast to java.lang.Number

(&amp;gt; &amp;quot;b&amp;quot; \a)
&amp;gt; java.lang.ClassCastException: 
&amp;gt; java.lang.Character cannot be cast to java.lang.Number&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As the error message states, these operators need Number and neither strings nor character are automatically casted to Number. You need to use &lt;a href=&#34;https://clojuredocs.org/clojure.core/int&#34;&gt;&lt;code&gt;int&lt;/code&gt;&lt;/a&gt; (like we did with &lt;code&gt;ord()&lt;/code&gt; in python). This coerse numbers to integer but also characters to unicode points. It does not work on strings.&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(int \a)
&amp;gt; 97

(int &amp;quot;a&amp;quot;)
&amp;gt; java.lang.ClassCastException: 
&amp;gt; java.lang.String cannot be cast to java.lang.Character&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we can compare characters, according to “alphabetical order” (at least unicode points).&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(&amp;lt; (int \a) (int \c))
&amp;gt; true&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To convert a single-character string to a character, we would need new functions:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://clojuredocs.org/clojure.core/seq&#34;&gt;&lt;code&gt;seq&lt;/code&gt;&lt;/a&gt; takes a collection and return a seq. When used on strings, it returns a seq of the letters in the string, coerced to character.&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://clojuredocs.org/clojure.core/first&#34;&gt;&lt;code&gt;first&lt;/code&gt;&lt;/a&gt; returns the first item of a collection. It is useful in our case since seq will give us a single item collection, rather than just a character.&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(seq &amp;quot;a&amp;quot;)
&amp;gt; (\a)
(first (seq &amp;quot;a&amp;quot;))
&amp;gt; \a
(int (first (seq &amp;quot;a&amp;quot;)))
&amp;gt; 97&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;An alternative to &lt;code&gt;first&lt;/code&gt; would be to use &lt;a href=&#34;https://clojuredocs.org/clojure.core/apply&#34;&gt;&lt;code&gt;apply&lt;/code&gt;&lt;/a&gt;, which lets you convert a collection to a list of arguments for a function. This is similar to unpacking argumets with &lt;a href=&#34;https://docs.python.org/3/tutorial/controlflow.html#unpacking-argument-lists&#34;&gt;&lt;code&gt;*args&lt;/code&gt; at function call in python&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(int (seq &amp;quot;a&amp;quot;))
&amp;gt; java.lang.ClassCastException: 
&amp;gt; clojure.lang.StringSeq cannot be cast to java.lang.Character

(apply int (seq &amp;quot;a&amp;quot;))
&amp;gt; 97&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Fortunately, sorting the letters of a strings in alphabetical order don’t require manual comparaison of each characters. The &lt;a href=&#34;https://clojuredocs.org/clojure.core/sort&#34;&gt;&lt;code&gt;sort&lt;/code&gt;&lt;/a&gt; function does both the conversion to characters and the sorting.&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(sort &amp;quot;hello&amp;quot;)
&amp;gt; (\e \h \l \l \o)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To join the characters back into a word, we can use &lt;code&gt;str&lt;/code&gt;, which concatenate strings and/or characters. &lt;code&gt;str&lt;/code&gt; expect arguments not a seq of characters, so we can use our &lt;code&gt;apply&lt;/code&gt; function again.&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
;; intended use
(str \e \h \l \l \o)
&amp;gt; &amp;quot;ehllo&amp;quot;

;; wrong
(str (\e \h \l \l \o))
&amp;gt; &amp;quot;(\\e \\h \\l \\l \\o)&amp;quot;

;; workaround using apply
(apply str (\e \h \l \l \o))
&amp;gt; &amp;quot;ehllo&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;An alternative to &lt;code&gt;str&lt;/code&gt;, closer to python’s &lt;code&gt;join&lt;/code&gt; is &lt;a href=&#34;https://clojuredocs.org/clojure.string/join&#34;&gt;&lt;code&gt;clojure.string/join&lt;/code&gt;&lt;/a&gt;. It allows to choose a separator and expects an iterable as argument (no need for &lt;code&gt;apply&lt;/code&gt;).&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(clojure.string/join &amp;quot;&amp;quot; (sort &amp;quot;hello&amp;quot;))
&amp;gt; &amp;quot;ehllo&amp;quot;
(clojure.string/join &amp;quot;,&amp;quot; (sort &amp;quot;hello&amp;quot;))
&amp;gt; &amp;quot;e,h,l,l,o&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;string-interpolation&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;String interpolation&lt;/h2&gt;
&lt;div id=&#34;string-interpolation-in-python&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;String interpolation in python&lt;/h3&gt;
&lt;p&gt;When starting out with python, it is tempting to use simple concatenate patterns to insert variable in strings.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
# Using +
alpha_string = &amp;quot;&amp;quot;.join(sorted(&amp;quot;hello&amp;quot;))
&amp;quot;Your reordered string is: &amp;quot; + alpha_string + &amp;quot;!&amp;quot;)
&amp;gt; &amp;quot;Your reordered string is: ehllo!&amp;quot;

# Using join (poor choice, note that you get a space between ehllo and !)
&amp;quot; &amp;quot;.join([&amp;quot;Your reordered string is:&amp;quot;, alpha_string, &amp;quot;!&amp;quot;])
&amp;gt; &amp;quot;Your reordered string is: ehllo !&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;But you can get much nicer syntax and options using string interpolation. For example, the two examples above would fail if &lt;code&gt;alpha_string&lt;/code&gt; was a number. They would not do an implicit conversion to string, like the methods below.&lt;/p&gt;
&lt;p&gt;Python 3.6 supports 3 types of interpolation: &lt;code&gt;%&lt;/code&gt;, &lt;code&gt;.format&lt;/code&gt; and &lt;code&gt;literal string f&lt;/code&gt;. These are &lt;a href=&#34;https://zerokspot.com/weblog/2015/12/31/new-string-formatting-in-python/&#34;&gt;well&lt;/a&gt; &lt;a href=&#34;https://blog.lerner.co.il/teaching-old-dog-new-tricks-learned-love-str-format-gave/&#34;&gt;covered&lt;/a&gt; &lt;a href=&#34;https://www.python.org/dev/peps/pep-0498/&#34;&gt;online&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;For simple variable &lt;code&gt;literal f strings&lt;/code&gt; are definitely more readable:&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
alpha_string = &amp;quot;&amp;quot;.join(sorted(&amp;quot;hello&amp;quot;))
# Using .format
&amp;quot;Your reordered string is: {}!&amp;quot;.format(alpha_string)
&amp;gt; &amp;quot;Your reordered string is: ehllo!&amp;quot;

# Using f (&amp;gt;= 3.6)
f&amp;quot;Your reordered string is: {alpha_string}!&amp;quot;
&amp;gt; &amp;quot;Your reordered string is: ehllo!&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For dictionary, it is more a matter of taste, thanks to dictionary unpacking:&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
user = {&amp;#39;name&amp;#39;: &amp;#39;Jane&amp;#39;, &amp;#39;city&amp;#39;: &amp;#39;Geneva&amp;#39;}
# Using .format
&amp;quot;{name} lives in {city}&amp;quot;.format(**user)
&amp;gt; &amp;quot;Jane lives in Geneva&amp;quot;

# Using f (&amp;gt;= 3.6)
f&amp;quot;{user[&amp;#39;name&amp;#39;]} lives in {user[&amp;#39;city&amp;#39;]}&amp;quot;
&amp;gt; &amp;quot;Jane lives in Geneva&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;string-interpolation-in-clojure&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;String interpolation in clojure&lt;/h3&gt;
&lt;p&gt;Similar to &lt;code&gt;+&lt;/code&gt;/&lt;code&gt;join&lt;/code&gt; in python, you can do basic, not very practical, insertion of variables with &lt;code&gt;str&lt;/code&gt;/&lt;code&gt;clojure.string/join&lt;/code&gt; with clojure. Unlike python, both methods will convert number to string for you.&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(def alphastring (apply str (sort &amp;quot;hello&amp;quot;)))

;; Using str
(str &amp;quot;Your reordered string is: &amp;quot; alphastring &amp;quot;!&amp;quot;)
&amp;gt; &amp;quot;Your reordered string is: ehllo!&amp;quot;

;; Using join (poor choice, note that you get a space between alphastring and &amp;quot;!&amp;quot;)
(clojure.string/join &amp;quot; &amp;quot; [&amp;quot;Your reordered string is:&amp;quot; alphastring &amp;quot;!&amp;quot;])
&amp;gt; &amp;quot;Your reordered string is: ehllo !&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Interpolation can be done with &lt;a href=&#34;https://clojuredocs.org/clojure.core/format&#34;&gt;&lt;code&gt;format&lt;/code&gt;&lt;/a&gt;, a pattern similar to &lt;code&gt;%-formatting&lt;/code&gt; in python. The list of &lt;code&gt;%-characters&lt;/code&gt; &lt;a href=&#34;https://dzone.com/articles/java-string-format-examples&#34;&gt;can be found here&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(def name &amp;quot;Jane&amp;quot;)
(def city &amp;quot;Geneva&amp;quot;)
(def age 33)
(format &amp;quot;%s lives in %s and is %d!&amp;quot; name city age)
&amp;gt; &amp;quot;Jane lives in Geneva and is 33!&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Clojure string interpolation options are well explained in &lt;a href=&#34;https://dzone.com/articles/java-string-format-examples&#34;&gt;this article&lt;/a&gt;, including a benchmark of their speed. The article ends up showcasing &lt;code&gt;core.incubator&lt;/code&gt;’s &lt;code&gt;&amp;lt;&amp;lt;&lt;/code&gt; macro which even lets you do string interpolation in a similar way to ruby or python’s &lt;code&gt;f&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Clojure for pythonista - User Input/Loop/Conditional</title>
      <link>/2017/06/08/clojure-for-pythonista---user-input/loop/conditional/</link>
      <pubDate>Thu, 08 Jun 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/06/08/clojure-for-pythonista---user-input/loop/conditional/</guid>
      <description>&lt;div id=&#34;foreword&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Foreword&lt;/h2&gt;
&lt;p&gt;I am trying to learn clojure. This series of posts is my attempt to solve beginner exercises both in python and clojure. Exercises are inspired by the excellent Reuven Lerner’s &lt;a href=&#34;https://practicemakespython.com/&#34;&gt;Practice Makes Python&lt;/a&gt; and other sources like &lt;a href=&#34;https://learnpythonthehardway.org/&#34;&gt;Learn python the hard way&lt;/a&gt;. Before trying any exercises, you can read an excellent introduction to clojure : &lt;a href=&#34;http://www.braveclojure.com/do-things/&#34;&gt;Brave Clojure&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;This exercise introduces the following concepts: user-input, conditional and loop.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;goal&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Goal&lt;/h2&gt;
&lt;p&gt;Create a command line game where the user has to guess a number between 0 and 99. The final program should repeat the question until the user find the right number, providing a helpful “Higher!” or “Lower!” hint after each failed attempt.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;getting-random-numbers&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Getting random numbers&lt;/h2&gt;
&lt;div id=&#34;getting-random-numbers-in-python&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Getting random numbers in python&lt;/h3&gt;
&lt;p&gt;In python, random integers can be obtained from &lt;code&gt;randint&lt;/code&gt;, a function from the &lt;code&gt;random&lt;/code&gt; package.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
import random
# Get a random number between 0 and 99
number = random.randint(0, 100)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;getting-random-numbers-in-clojure&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Getting random numbers in clojure&lt;/h3&gt;
&lt;p&gt;In clojure, you get random integer from the &lt;code&gt;rand-int&lt;/code&gt; function (which by default start at 0 and end at the first argument)&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(def -main []
  (rand-int 100))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;getting-user-input&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Getting user input&lt;/h2&gt;
&lt;div id=&#34;getting-user-input-in-python&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Getting user input in python&lt;/h3&gt;
&lt;p&gt;In python, you can get user input with the &lt;code&gt;input&lt;/code&gt; function. &lt;code&gt;input&lt;/code&gt; takes a string as an argument that you can use to display a prompt to the user. To make sure that the input is converted to a integer, we wrap the &lt;code&gt;input&lt;/code&gt; call in &lt;code&gt;int&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
guess = int(input(&amp;quot;Enter a guess: &amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;getting-user-input-in-clojure&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Getting user input in clojure&lt;/h3&gt;
&lt;p&gt;In clojure, you can get user input with the &lt;a href=&#34;https://clojuredocs.org/clojure.core/read-line&#34;&gt;&lt;code&gt;read-line&lt;/code&gt;&lt;/a&gt; function. The conversion to an integer is also necessary and you can use &lt;code&gt;Integer/parseInt&lt;/code&gt; for that. &lt;code&gt;read-line&lt;/code&gt; doesn’t have prompt feature, so we will print the prompt to the console with &lt;a href=&#34;https://clojuredocs.org/clojure.core/read-line&#34;&gt;&lt;code&gt;println&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(defn -main []
  (println &amp;quot;Enter a guess:&amp;quot;)
  (let [guess (Integer/parseInt (read-line))]))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;conditionals&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Conditionals&lt;/h2&gt;
&lt;div id=&#34;conditionals-in-python&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Conditionals in python&lt;/h3&gt;
&lt;p&gt;Now that we have a random number and a number entered by the user, we need to compare them and send the response response.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
import random
number = random.randint(0, 100)
guess = int(input(&amp;quot;Enter a guess: &amp;quot;))

if number &amp;gt; guess:
    print(&amp;quot;Too small!&amp;quot;)
elif number &amp;lt; guess:
    print(&amp;quot;Too big!&amp;quot;)
else:
    print(&amp;quot;Correct!&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;conditionals-in-clojure&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Conditionals in clojure&lt;/h3&gt;
&lt;p&gt;In clojure, the &lt;a href=&#34;http://www.braveclojure.com/do-things/#if&#34;&gt;&lt;code&gt;if&lt;/code&gt;&lt;/a&gt; function seems to be designed for single comparison. It works as a simple “if/else”: &lt;code&gt;(if &amp;lt;test&amp;gt; &amp;lt;do-if-true&amp;gt; &amp;lt;do-if-false&amp;gt;)&lt;/code&gt;. There is no such thing as &lt;code&gt;elif&lt;/code&gt;. However, clojure has &lt;a href=&#34;https://clojuredocs.org/clojure.core/cond&#34;&gt;&lt;code&gt;cond&lt;/code&gt;&lt;/a&gt; function, which allow for as many comparison as we like. The keyword &lt;code&gt;:else&lt;/code&gt; is just the last comparison and evaluate to &lt;code&gt;true&lt;/code&gt;, if no other comparison have been &lt;code&gt;true&lt;/code&gt; before it. We could have chosen any other truthy value (e.g &lt;code&gt;:otherwise&lt;/code&gt; or &lt;code&gt;1&lt;/code&gt;).&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(defn -main []
  (let [number (rand-int 100)]
    (println &amp;quot;Enter a guess:&amp;quot;)
    (let [guess (Integer/parseInt (read-line))]
      (cond (&amp;gt; number guess)
              (println &amp;quot;Too Low!&amp;quot;)
            (&amp;lt; number guess)
              (println &amp;quot;Too Big!&amp;quot;)
            :else
              (println &amp;quot;Yeah!&amp;quot;)))))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;loop-to-repeat-the-question&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Loop to repeat the question&lt;/h2&gt;
&lt;div id=&#34;loop-to-repeat-the-question-in-python&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Loop to repeat the question in python&lt;/h3&gt;
&lt;p&gt;Lastly, we need to make the program able to repeat the question when the answer is wrong.&lt;/p&gt;
&lt;p&gt;In python, never-ending loop are often implemented with &lt;code&gt;while True&lt;/code&gt;, using the &lt;code&gt;break&lt;/code&gt; keyword to exit on specific conditions.&lt;/p&gt;
&lt;pre class=&#34;python&#34;&gt;&lt;code&gt;# python
import random
number = random.randint(0, 100)

while True:
    guess = int(input(&amp;quot;Enter a guess: &amp;quot;))
    if number &amp;gt; guess:
        print(&amp;quot;Too small!&amp;quot;)
    elif number &amp;lt; guess:
        print(&amp;quot;Too big!&amp;quot;)
    else:
        print(&amp;quot;Correct!&amp;quot;)
        break&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;loop-to-repeat-the-question-in-clojure&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Loop to repeat the question in clojure&lt;/h3&gt;
&lt;p&gt;In clojure, you can take the opposite approach. Rather than saying “when to exit” (&lt;code&gt;break&lt;/code&gt;), we can use the &lt;a href=&#34;http://www.braveclojure.com/do-things/#loop&#34;&gt;&lt;code&gt;loop&lt;/code&gt;&lt;/a&gt; function and tell it “when to loop” (&lt;code&gt;recur&lt;/code&gt;):&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(defn -main []
  (let [number (rand-int 100)]
    (loop []
      (println &amp;quot;Enter a guess:&amp;quot;)
      (let [guess (Integer/parseInt (read-line))]
        (cond (&amp;gt; number guess)
                (do (println &amp;quot;Too Low!&amp;quot;)
                    (recur))
              (&amp;lt; number guess)
                (do (println &amp;quot;Too Big!&amp;quot;)
                    (recur))
              :else
                (println &amp;quot;Yeah!&amp;quot;))))))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that we had to wrap the “actions” following each &lt;code&gt;cond&lt;/code&gt;’s conditions with the &lt;a href=&#34;http://www.braveclojure.com/do-things/#do&#34;&gt;&lt;code&gt;do&lt;/code&gt;&lt;/a&gt; function, a simple way to group multiple statements into one. Otherwise, the first call to &lt;code&gt;(recur)&lt;/code&gt; (after “Too Low!”) would be interpreted as the second condition for &lt;code&gt;cond&lt;/code&gt; (instead of &lt;code&gt;(&amp;lt; number guess)&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Alternatively, you could use a recursive function. I haven’t been able to find if for such a short problem one method is better than the other, but this is a good illustration of a program with two functions.&lt;/p&gt;
&lt;pre class=&#34;clojure&#34;&gt;&lt;code&gt;;; clojure
(defn try-and-guess [number]
  (println &amp;quot;Enter your guess:&amp;quot;)
  (let [guess (Integer/parseInt (read-line))]
    (cond
      (&amp;lt; guess number) 
        (do (println &amp;quot;Guess is too small...&amp;quot;)
            (try-and-guess number))
      (&amp;gt; guess number)
        (do (println &amp;quot;Guess is too big...&amp;quot;)
            (try-and-guess number))
      :else
      (println &amp;quot;Yeah!&amp;quot;))))

(defn -main []
  (let [number (rand-int 100)]
    (try-and-guess number)))&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>A minimal emacs setup with orgmode</title>
      <link>/2017/05/29/a-minimal-emacs-setup-with-orgmode/</link>
      <pubDate>Mon, 29 May 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/05/29/a-minimal-emacs-setup-with-orgmode/</guid>
      <description>&lt;div id=&#34;foreword&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Foreword&lt;/h2&gt;
&lt;p&gt;Trying to start using emacs can be a bit intimidating. Very rough looking outside the box, complex keyboard shortcuts, configuration in emacs-elisp language… I personally decided to try the switch (from vim) for the following reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;once configured well, emacs can rival in features with many of IDE. &lt;a href=&#34;https://elpy.readthedocs.io/&#34;&gt;Elpy&lt;/a&gt; looks great for python and &lt;a href=&#34;https://cider.readthedocs.io/&#34;&gt;CIDER&lt;/a&gt; looks amazing for clojure.&lt;/li&gt;
&lt;li&gt;with EVIL mode, you can use VIM key-bindings in emacs&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://orgmode.org/&#34;&gt;org-mode&lt;/a&gt; lets you do things you wouldn’t believe possible with plain text&lt;/li&gt;
&lt;li&gt;emacs can &lt;a href=&#34;https://github.com/hlissner/.emacs.d&#34;&gt;look good&lt;/a&gt;!&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There are well explained stories of vim users migrating to emacs:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=JWD1Fpdd4Pc&#34;&gt;Evil Mode: Or, How I Learned to Stop Worrying and Love Emacs - YouTube&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://juanjoalvarez.net/es/detail/2014/sep/19/vim-emacsevil-chaotic-migration-guide/&#34;&gt;From Vim to Emacs+Evil chaotic migration guide&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;But before implementing advanced features, you might want to put in place a setup that lets you start with the bare minimum (i.e vim key-bindings and an &lt;em&gt;easy&lt;/em&gt; to customize config file). Emacs is configured with a programming language called emacs-lisp. For people not knowing emacs-lisp at all, it makes sense to use &lt;a href=&#34;https://en.wikipedia.org/wiki/Literate_programming&#34;&gt;literate programming&lt;/a&gt; and &lt;a href=&#34;http://orgmode.org/worg/org-contrib/babel/&#34;&gt;org-babel&lt;/a&gt;, a technique that lets you heavily document your code. Literate programming isn’t a paradigm that necessarily work well to write entire programs with. But for config files in unknown programming languages, it’s great. Literate programming is often used for analysis and if you are coming from python or R, this is similar to what you do in &lt;a href=&#34;http://jupyter.org/&#34;&gt;jupyter&lt;/a&gt; or &lt;a href=&#34;http://rmarkdown.rstudio.com/r_notebooks.html&#34;&gt;r notebooks&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;install-emacs&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Install emacs&lt;/h2&gt;
&lt;p&gt;First you need to install emacs. You can start &lt;a href=&#34;https://www.gnu.org/software/emacs/&#34;&gt;here&lt;/a&gt; or from any of the hundred of tutorials online. At the time of this post, version 25.2 is out and that is the one I am using.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;set-up-org-babel-config-file&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Set up org-babel config file&lt;/h2&gt;
&lt;p&gt;Depending on how you installed emacs, you might have a &lt;code&gt;.emacs&lt;/code&gt; file in you home directory &lt;code&gt;~&lt;/code&gt;. This is similar to &lt;code&gt;.vimrc&lt;/code&gt; file for vim and usually contains config commands that are loaded at start up.&lt;/p&gt;
&lt;p&gt;However, from the &lt;a href=&#34;https://www.gnu.org/software/emacs/manual/html_node/emacs/Init-File.html&#34;&gt;doc&lt;/a&gt;, we can see that there are other options to load your config:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;When Emacs is started, it normally tries to load a Lisp program from an initialization file, or init file for short. This file, if it exists, specifies how to initialize Emacs for you. Emacs looks for your init file using the filenames ~/.emacs, ~/.emacs.el, or ~/.emacs.d/init.el; you can choose to use any one of these three names (see Find Init). Here, ~/ stands for your home directory.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;In our case, we want to use &lt;code&gt;~/.emacs.d/init.el&lt;/code&gt; instead of &lt;code&gt;~/.emacs&lt;/code&gt; and use it exclusively to setup package management and load an org-babel config file (&lt;code&gt;~/.emacs.d/emacs-config.org&lt;/code&gt;). The difference in extension is important. &lt;code&gt;.el&lt;/code&gt; files are written in emacs-lisp, the programming language powering emacs. &lt;code&gt;.org&lt;/code&gt; files are org-mode files, basically plain text file that can mix code and text.&lt;/p&gt;
&lt;p&gt;Note that if you are using windows, the &lt;code&gt;~&lt;/code&gt; directory might be &lt;code&gt;C:\Users\&amp;lt;user-name&amp;gt;\AppData\Roaming&lt;/code&gt; or even something else. There are hints &lt;a href=&#34;https://www.gnu.org/software/emacs/manual/html_node/efaq-w32/Location-of-init-file.html&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Delete file &lt;code&gt;~/.emacs&lt;/code&gt; if you have one&lt;/li&gt;
&lt;li&gt;Create dir &lt;code&gt;~/.emacs.d/&lt;/code&gt; if you don’t have one&lt;/li&gt;
&lt;li&gt;Create file &lt;code&gt;~/.emacs.d/init.el&lt;/code&gt; if you don’t have one&lt;/li&gt;
&lt;li&gt;In &lt;code&gt;~/.emacs.d/init.el&lt;/code&gt;, we need only to do a few things:
&lt;ul&gt;
&lt;li&gt;setup emacs so that it can download packages from the &lt;a href=&#34;http://melpa.milkbox.net/&#34;&gt;MELPA package server&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;install the &lt;a href=&#34;https://github.com/jwiegley/use-package&#34;&gt;&lt;code&gt;use-package&lt;/code&gt;&lt;/a&gt; package which simplify package management (all other package will be installed in &lt;code&gt;emacs-config.org&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;load the &lt;code&gt;org&lt;/code&gt; package and use the &lt;code&gt;org-babel-load-file&lt;/code&gt; function to load the code inside &lt;code&gt;~/.emacs.d/emacs-config.org&lt;/code&gt; at emacs start up.&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In &lt;code&gt;~/.emacs.d/init.el&lt;/code&gt; (lines starting with &lt;code&gt;;;&lt;/code&gt; are comments):&lt;/p&gt;
&lt;pre class=&#34;emacslisp&#34;&gt;&lt;code&gt;;; add MELPA package server
(require &amp;#39;package)

(add-to-list &amp;#39;package-archives 
  &amp;#39;(&amp;quot;melpa&amp;quot; . &amp;quot;http://melpa.milkbox.net/packages/&amp;quot;))

(unless package-archive-contents
  (package-refresh-contents))

(package-initialize)

;; if not yet installed, install package use-package
(unless (package-installed-p &amp;#39;use-package)
  (package-install &amp;#39;use-package))

;; load org package and our emacs-config.org file
(require &amp;#39;org)
(org-babel-load-file &amp;quot;~/.emacs.d/emacs-config.org&amp;quot;) &lt;/code&gt;&lt;/pre&gt;
&lt;ol start=&#34;5&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Lastly, create file &lt;code&gt;~/.emacs.d/emacs-config.org&lt;/code&gt;, which will host the bulk of our config and the explanations. Lines starting with &lt;code&gt;#+&lt;/code&gt; are org-mode document metadata. Lines starting with &lt;code&gt;*&lt;/code&gt; are content headers (number of asterisks representing the header level). Code block are wrapped between &lt;code&gt;#+BEGIN_SRC emacs-lisp&lt;/code&gt; and &lt;code&gt;#+END_SRC&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In &lt;code&gt;~/.emacs.d/emacs-config.org&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&#34;orgmode&#34;&gt;&lt;code&gt;#+TITLE: Emacs configuration
#+DESCRIPTION: An org-babel based emacs configuration
#+LANGUAGE: en
#+PROPERTY: results silent

* Remove startup welcome screen
The code block below toggle off the welcome startup screen.

#+BEGIN_SRC emacs-lisp
(custom-set-variables
  &amp;#39;(inhibit-startup-screen t))
#+END_SRC&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As you can see, we can now document the code not only with comment but with &lt;a href=&#34;http://orgmode.org/guide/Headlines.html#Headlines&#34;&gt;hierarchical headers&lt;/a&gt;, &lt;a href=&#34;http://orgmode.org/guide/Plain-lists.html#Plain-lists&#34;&gt;lists&lt;/a&gt;, &lt;a href=&#34;http://orgmode.org/guide/Tables.html#Tables&#34;&gt;tables&lt;/a&gt;, &lt;a href=&#34;http://orgmode.org/guide/External-links.html#External-links&#34;&gt;links&lt;/a&gt; and &lt;a href=&#34;http://orgmode.org/guide/&#34;&gt;all the other things&lt;/a&gt; offered by org-mode.&lt;/p&gt;
&lt;p&gt;If you are trying to do this step by step and run emacs every time, you might notice that emacs will complain if you use &lt;code&gt;(org-babel-load-file &amp;lt;path&amp;gt;)&lt;/code&gt; in &lt;code&gt;init.el&lt;/code&gt; on a non existing or empty file. This should go away as soon as you have at least one valid code block in your &lt;code&gt;emacs-config.org&lt;/code&gt;. Above we removed the welcome screen displayed by default at emacs launch.&lt;/p&gt;
&lt;p&gt;You will notice that on first run, emacs create a &lt;code&gt;~/.emacs.d/emacs-config.el&lt;/code&gt; file that contains only the code that we wrapped in code blocks in our &lt;code&gt;emacs-config.org&lt;/code&gt;. This file will be updated each time you change your &lt;code&gt;emacs-config.org&lt;/code&gt; file and restart emacs.&lt;/p&gt;
&lt;p&gt;You might also notice that on first run, emacs will append some lines to our &lt;code&gt;init.el&lt;/code&gt; file. Something like:&lt;/p&gt;
&lt;pre class=&#34;emacslisp&#34;&gt;&lt;code&gt;(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won&amp;#39;t work right.
 &amp;#39;(inhibit-startup-screen t)
 &amp;#39;(package-selected-packages (quote (use-package))))
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won&amp;#39;t work right.
 )&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;These lines should not be touched.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;adding-vim-key-bindings&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Adding Vim key-bindings&lt;/h2&gt;
&lt;p&gt;From now on, we can add the rest of our config in &lt;code&gt;emacs-config.org&lt;/code&gt;. We will enable vim keybindings by installing our first package via &lt;a href=&#34;https://github.com/jwiegley/use-package&#34;&gt;&lt;code&gt;use-package&lt;/code&gt;&lt;/a&gt;, called &lt;code&gt;EVIL&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Some reasons to use &lt;code&gt;use-package&lt;/code&gt; for your package management and config:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;you can wrap together in the same function the install, enabling and config of each package. This keeps things neatly organized.&lt;/li&gt;
&lt;li&gt;the &lt;code&gt;:ensure&lt;/code&gt; keyword, when set to true (&lt;code&gt;t&lt;/code&gt;), will install the package if it’s not installed yet.&lt;/li&gt;
&lt;li&gt;it’s easy to install/load packages depending on the operating system&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Append the following lines to &lt;code&gt;~/.emacs.d/emacs-config.org&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&#34;orgmode&#34;&gt;&lt;code&gt;* EVIL
** Install
Install EVIL (if not yet installed), and enable it.

#+BEGIN_SRC emacs-lisp
(use-package evil
  :ensure t
  :config
  (evil-mode 1))
#+END_SRC&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Restart EMACS. On my machine, I often get error when I start EMACS with new packages. Closing it once and restarting a second time usually works well.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1705091-scrsh-emacs-error.png&#34; alt=&#34;The type of error I get on first start with new package&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;The type of error I get on first start with new package&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;After your second restart, you should be all set to start using emacs.&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Create Swiss cantons cartogram with ggplot2</title>
      <link>/2017/05/08/create-swiss-cantons-cartogram-with-ggplot2/</link>
      <pubDate>Mon, 08 May 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/05/08/create-swiss-cantons-cartogram-with-ggplot2/</guid>
      <description>&lt;script src=&#34;../rmarkdown-libs/htmlwidgets/htmlwidgets.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../rmarkdown-libs/jquery/jquery.min.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../rmarkdown-libs/datatables-binding/datatables.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../rmarkdown-libs/dt-core/css/jquery.dataTables.min.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;link href=&#34;../rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../rmarkdown-libs/dt-core/js/jquery.dataTables.min.js&#34;&gt;&lt;/script&gt;


&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;While reading &lt;a href=&#34;www.rweekly.org&#34;&gt;rweekly&lt;/a&gt; past issues, I stumbbled upon a post from &lt;a href=&#34;http://maxhumber.com/2017/02/15/tile_canada.html&#34;&gt;Max Humber&lt;/a&gt;, explaining how he tried to design a tile grid map / state cartogram for Canada. I had never seen such design and thought that it would be a great fit for Swiss cantons. While browsing the excellent repositories of &lt;a href=&#34;https://github.com/hrbrmstr&#34;&gt;Bob Rudis&lt;/a&gt;, I realised that he had written &lt;a href=&#34;https://github.com/hrbrmstr/statebins&#34;&gt;statebin&lt;/a&gt;, a ggplot extension to easily create US state cartogram. This post is my attempt to convert his code to handle Swiss cantons.&lt;/p&gt;
&lt;p&gt;In hrbrmstr library, US states are on a 8x12 grid.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1705081-cantonbins-scrsh-hrbrmstr-statesbin.png&#34; alt=&#34;US States mapped with statebins. Source: https://github.com/hrbrmstr/statebins&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;US States mapped with statebins. Source: &lt;a href=&#34;https://github.com/hrbrmstr/statebins&#34; class=&#34;uri&#34;&gt;https://github.com/hrbrmstr/statebins&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;These coordinates are saved with the full and abbreviated names in a dataframe. The &lt;code&gt;L&lt;/code&gt; suffix after the numbers is a &lt;a href=&#34;http://stackoverflow.com/questions/24350733/why-would-r-use-the-l-suffix-to-denote-an-integer&#34;&gt;way to specify integer&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Original code from hrbrmstr
# source: https://github.com/hrbrmstr/statebins/blob/master/R/statebins.R
state_coords &amp;lt;- structure(
  list(abbrev = c(&amp;quot;AL&amp;quot;, &amp;quot;AK&amp;quot;, &amp;quot;AZ&amp;quot;, &amp;quot;AR&amp;quot;, &amp;quot;CA&amp;quot;, &amp;quot;CO&amp;quot;,
                  &amp;quot;CT&amp;quot;, &amp;quot;DC&amp;quot;, &amp;quot;DE&amp;quot;, &amp;quot;FL&amp;quot;, &amp;quot;GA&amp;quot;, &amp;quot;HI&amp;quot;,
                  &amp;quot;ID&amp;quot;, &amp;quot;IL&amp;quot;, &amp;quot;IN&amp;quot;, &amp;quot;IA&amp;quot;, &amp;quot;KS&amp;quot;, &amp;quot;KY&amp;quot;, 
                  &amp;quot;LA&amp;quot;, &amp;quot;ME&amp;quot;, &amp;quot;MD&amp;quot;, &amp;quot;MA&amp;quot;, &amp;quot;MI&amp;quot;, &amp;quot;MN&amp;quot;,
                  &amp;quot;MS&amp;quot;, &amp;quot;MO&amp;quot;, &amp;quot;MT&amp;quot;, &amp;quot;NE&amp;quot;, &amp;quot;NV&amp;quot;, &amp;quot;NH&amp;quot;, 
                  &amp;quot;NJ&amp;quot;, &amp;quot;NM&amp;quot;, &amp;quot;NY&amp;quot;, &amp;quot;NC&amp;quot;, &amp;quot;ND&amp;quot;, &amp;quot;OH&amp;quot;, 
                  &amp;quot;OK&amp;quot;, &amp;quot;OR&amp;quot;, &amp;quot;PA&amp;quot;, &amp;quot;RI&amp;quot;, &amp;quot;SC&amp;quot;, &amp;quot;SD&amp;quot;, 
                  &amp;quot;TN&amp;quot;, &amp;quot;TX&amp;quot;, &amp;quot;UT&amp;quot;, &amp;quot;VT&amp;quot;, &amp;quot;VA&amp;quot;, &amp;quot;WA&amp;quot;, 
                  &amp;quot;WV&amp;quot;, &amp;quot;WI&amp;quot;, &amp;quot;WY&amp;quot;, &amp;quot;PR&amp;quot;),
       it = c(&amp;quot;Alabama&amp;quot;, &amp;quot;Alaska&amp;quot;, &amp;quot;Arizona&amp;quot;, &amp;quot;Arkansas&amp;quot;,
              &amp;quot;California&amp;quot;, &amp;quot;Colorado&amp;quot;, &amp;quot;Connecticut&amp;quot;, 
              &amp;quot;District of Columbia&amp;quot;, &amp;quot;Delaware&amp;quot;, &amp;quot;Florida&amp;quot;, 
              &amp;quot;Georgia&amp;quot;, &amp;quot;Hawaii&amp;quot;, &amp;quot;Idaho&amp;quot;, &amp;quot;Illinois&amp;quot;, 
              &amp;quot;Indiana&amp;quot;, &amp;quot;Iowa&amp;quot;, &amp;quot;Kansas&amp;quot;, &amp;quot;Kentucky&amp;quot;, 
              &amp;quot;Louisiana&amp;quot;, &amp;quot;Maine&amp;quot;, &amp;quot;Maryland&amp;quot;, 
              &amp;quot;Massachusetts&amp;quot;, &amp;quot;Michigan&amp;quot;, &amp;quot;Minnesota&amp;quot;, 
              &amp;quot;Mississippi&amp;quot;, &amp;quot;Missouri&amp;quot;, &amp;quot;Montana&amp;quot;, 
              &amp;quot;Nebraska&amp;quot;, &amp;quot;Nevada&amp;quot;, &amp;quot;New Hampshire&amp;quot;,
              &amp;quot;New Jersey&amp;quot;, &amp;quot;New Mexico&amp;quot;, &amp;quot;New York&amp;quot;,
              &amp;quot;North Carolina&amp;quot;, &amp;quot;North Dakota&amp;quot;, &amp;quot;Ohio&amp;quot;,
              &amp;quot;Oklahoma&amp;quot;, &amp;quot;Oregon&amp;quot;, &amp;quot;Pennsylvania&amp;quot;,
              &amp;quot;Rhode Island&amp;quot;, &amp;quot;South Carolina&amp;quot;,
              &amp;quot;South Dakota&amp;quot;, &amp;quot;Tennessee&amp;quot;, &amp;quot;Texas&amp;quot;, &amp;quot;Utah&amp;quot;,
              &amp;quot;Vermont&amp;quot;, &amp;quot;Virginia&amp;quot;, &amp;quot;Washington&amp;quot;,
              &amp;quot;West Virginia&amp;quot;, &amp;quot;Wisconsin&amp;quot;, &amp;quot;Wyoming&amp;quot;,
              &amp;quot;Puerto Rico&amp;quot;),
       col = c(8L, 1L, 3L, 6L, 2L, 4L, 11L, 10L, 11L, 10L,
               9L, 1L, 3L, 7L, 7L, 6L, 5L, 7L, 6L, 12L,
               10L, 11L, 8L, 6L, 7L, 6L, 4L, 5L, 3L, 12L,
               10L, 4L, 10L, 8L, 5L, 8L, 5L, 2L, 9L, 12L,
               9L, 5L, 7L, 5L, 3L, 11L, 9L, 2L, 8L, 7L, 4L, 12L),
       row = c(7L, 7L, 6L, 6L, 5L, 5L, 4L, 6L, 5L, 8L, 7L,
               8L, 3L, 3L, 4L, 4L, 6L, 5L, 7L, 1L, 5L, 3L,
               3L, 3L, 7L, 5L, 3L, 5L, 4L, 2L, 4L, 6L, 3L, 
               6L, 3L, 4L, 7L, 4L, 4L, 4L, 6L, 4L, 6L, 8L,
               5L, 2L, 5L, 3L, 5L, 2L, 4L, 8L)),
  .Names = c(&amp;quot;abbrev&amp;quot;, &amp;quot;state&amp;quot;, &amp;quot;col&amp;quot;, &amp;quot;row&amp;quot;),
  class = &amp;quot;data.frame&amp;quot;, 
  row.names = c(NA, -52L)
)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To sketch the mockup of your tile grid, excel can come to rescue.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1705081-cantonbins-scrsh-excel.png&#34; alt=&#34;Mock up of Swiss tile grid&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Mock up of Swiss tile grid&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;This shows that cantons could be represented on a 5x9 grid.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1705081-cantonbins-scrsh-excel-2.png&#34; alt=&#34;Columns/Rows reference for 5x9 grid&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Columns/Rows reference for 5x9 grid&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;By using the row/column reference of each canton, we can translate this mock up into an object mimicing hrbrmstr data structure (adding the names in each national languages).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;canton_coords &amp;lt;- structure(
  list(abbrev = c(&amp;quot;AG&amp;quot;, &amp;quot;AI&amp;quot;, &amp;quot;AR&amp;quot;, &amp;quot;BE&amp;quot;, &amp;quot;BL&amp;quot;, &amp;quot;BS&amp;quot;, &amp;quot;FR&amp;quot;,
                  &amp;quot;GE&amp;quot;, &amp;quot;GL&amp;quot;, &amp;quot;GR&amp;quot;, &amp;quot;JU&amp;quot;, &amp;quot;LU&amp;quot;, &amp;quot;NE&amp;quot;, &amp;quot;NW&amp;quot;,
                  &amp;quot;OW&amp;quot;, &amp;quot;SG&amp;quot;, &amp;quot;SH&amp;quot;, &amp;quot;SO&amp;quot;, &amp;quot;SZ&amp;quot;, &amp;quot;TG&amp;quot;, &amp;quot;TI&amp;quot;,
                  &amp;quot;UR&amp;quot;, &amp;quot;VD&amp;quot;, &amp;quot;VS&amp;quot;, &amp;quot;ZG&amp;quot;, &amp;quot;ZH&amp;quot;),
       fr_name = c(&amp;quot;Argovie&amp;quot;, &amp;quot;Appenzell Rhodes-Intérieures&amp;quot;,
                   &amp;quot;Appenzell Rhodes-Extérieures&amp;quot;, &amp;quot;Berne&amp;quot;,
                   &amp;quot;Bâle-Campagne&amp;quot;, &amp;quot;Bâle-Ville&amp;quot;, &amp;quot;Fribourg&amp;quot;,
                   &amp;quot;Genève&amp;quot;, &amp;quot;Glaris&amp;quot;, &amp;quot;Grisons&amp;quot;, &amp;quot;Jura&amp;quot;,
                   &amp;quot;Lucerne&amp;quot;, &amp;quot;Neuchâtel&amp;quot;, &amp;quot;Nidwald&amp;quot;, &amp;quot;Obwald&amp;quot;,
                   &amp;quot;Saint-Gall&amp;quot;, &amp;quot;Schaffhouse&amp;quot;, &amp;quot;Soleure&amp;quot;, &amp;quot;Schwytz&amp;quot;,
                   &amp;quot;Thurgovie&amp;quot;, &amp;quot;Tessin&amp;quot;, &amp;quot;Uri&amp;quot;, &amp;quot;Vaud&amp;quot;,
                   &amp;quot;Valais&amp;quot;, &amp;quot;Zoug&amp;quot;, &amp;quot;Zurich&amp;quot;),
       de_name = c(&amp;quot;Aargau&amp;quot;, &amp;quot;Appenzell Innerrhoden&amp;quot;,
                   &amp;quot;Appenzell Ausserrhoden&amp;quot;, &amp;quot;Bern&amp;quot;, 
                   &amp;quot;Basel-Landschaft&amp;quot;, &amp;quot;Basel-Stadt&amp;quot;,
                   &amp;quot;Freiburg&amp;quot;, &amp;quot;Genf&amp;quot;, &amp;quot;Glarus&amp;quot;,
                   &amp;quot;Graubünden&amp;quot;, &amp;quot;Jura&amp;quot;, &amp;quot;Luzern&amp;quot;,
                   &amp;quot;Neuenburg&amp;quot;, &amp;quot;Nidwalden&amp;quot;, &amp;quot;Obwalden&amp;quot;,
                   &amp;quot;St. Gallen&amp;quot;, &amp;quot;Schaffhausen&amp;quot;, &amp;quot;Solothurn&amp;quot;,
                   &amp;quot;Schwyz&amp;quot;, &amp;quot;Thurgau&amp;quot;, &amp;quot;Tessin&amp;quot;, &amp;quot;Uri&amp;quot;,
                   &amp;quot;Waadt&amp;quot;, &amp;quot;Wallis&amp;quot;, &amp;quot;Zug&amp;quot;, &amp;quot;Zürich&amp;quot;),
       it_name = c(&amp;quot;Argovia&amp;quot;, &amp;quot;Appenzello Interno&amp;quot;,
                   &amp;quot;Appenzello Esterno&amp;quot;, &amp;quot;Berna&amp;quot;,
                   &amp;quot;Basilea Campagna&amp;quot;, &amp;quot;Basilea Città&amp;quot;,
                   &amp;quot;Friburgo&amp;quot;, &amp;quot;Ginevra&amp;quot;, &amp;quot;Glarona&amp;quot;,
                   &amp;quot;Grigioni&amp;quot;, &amp;quot;Giura&amp;quot;, &amp;quot;Lucerna&amp;quot;, &amp;quot;Neuchâtel&amp;quot;,
                   &amp;quot;Nidvaldo&amp;quot;, &amp;quot;Obvaldo&amp;quot;, &amp;quot;San Gallo&amp;quot;,
                   &amp;quot;Sciaffusa&amp;quot;, &amp;quot;Soletta&amp;quot;, &amp;quot;Svitto&amp;quot;, &amp;quot;Turgovia&amp;quot;,
                   &amp;quot;Ticino&amp;quot;, &amp;quot;Uri&amp;quot;, &amp;quot;Vaud&amp;quot;, &amp;quot;Vallese&amp;quot;,
                   &amp;quot;Zugo&amp;quot;, &amp;quot;Zurigo&amp;quot;), 
       ru_name = c(&amp;quot;Argovia&amp;quot;, &amp;quot;Appenzell Dadens&amp;quot;,
                   &amp;quot;Appenzell Dadora&amp;quot;, &amp;quot;Berna&amp;quot;,
                   &amp;quot;Basilea-Champagna&amp;quot;, &amp;quot;Basilea-Citad&amp;quot;,
                   &amp;quot;Friburg&amp;quot;, &amp;quot;Genevra&amp;quot;, &amp;quot;Glaruna&amp;quot;,
                   &amp;quot;Grischun&amp;quot;, &amp;quot;Giura&amp;quot;, &amp;quot;Lucerna&amp;quot;, &amp;quot;Neuchâtel&amp;quot;,
                   &amp;quot;Sutsilvania&amp;quot;, &amp;quot;Sursilvania&amp;quot;, &amp;quot;Son Gagl&amp;quot;,
                   &amp;quot;Schaffusa&amp;quot;, &amp;quot;Soloturn&amp;quot;, &amp;quot;Sviz&amp;quot;, &amp;quot;Turgovia&amp;quot;,
                   &amp;quot;Tessin&amp;quot;, &amp;quot;Uri&amp;quot;, &amp;quot;Vad&amp;quot;, &amp;quot;Vallais&amp;quot;,
                   &amp;quot;Zug&amp;quot;, &amp;quot;Turitg&amp;quot;),
       col = c(5L,8L,8L,4L,4L,4L,3L,1L,8L,9L,3L,5L,3L,
               6L,5L,7L,6L,4L,7L,7L,7L,7L,2L,4L,6L,6L),
       row = c(2L,3L,2L,4L,2L,1L,4L,5L,4L,4L,2L,3L,3L,
               4L,4L,2L,1L,3L,3L,1L,5L,4L,4L,5L,3L,2L)),
  .Names = c(&amp;quot;abbrev&amp;quot;, &amp;quot;fr_name&amp;quot;, &amp;quot;de_name&amp;quot;,
             &amp;quot;it_name&amp;quot;, &amp;quot;ru_name&amp;quot;, &amp;quot;col&amp;quot;, &amp;quot;row&amp;quot;),
  class = &amp;quot;data.frame&amp;quot;,
  row.names = c(NA, -26L)
)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Using the same data structure as the one designed for &lt;a href=&#34;https://github.com/hrbrmstr/statebins&#34;&gt;statebin&lt;/a&gt;, it is easy to reuse the same ggplot code and only apply slight modifications (like a theme from the same &lt;a href=&#34;https://github.com/hrbrmstr/hrbrthemes&#34;&gt;hrbrmstr&lt;/a&gt;).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(ggplot2))
suppressMessages(library(RColorBrewer))
suppressMessages(library(hrbrthemes))

cantonbins &amp;lt;- function(canton_data, canton_col=&amp;quot;abbrev&amp;quot;, value_col=&amp;quot;value&amp;quot;,
                     text_color=&amp;quot;black&amp;quot;, font_size=3,
                     canton_border_col=&amp;quot;white&amp;quot;, labels=1:5,
                     brewer_pal=&amp;quot;PuBu&amp;quot;, plot_title=&amp;quot;&amp;quot;,
                     plot_subtitle=&amp;quot;&amp;quot;, plot_caption=&amp;quot;&amp;quot;) {

  # Reformat canton_data into a data frame without factors
  # and merge with canton_coords on abbrev key
  canton_data &amp;lt;- data.frame(canton_data, stringsAsFactors=FALSE)
  merge.x &amp;lt;- &amp;quot;abbrev&amp;quot;
  ct.dat &amp;lt;- merge(canton_coords, canton_data,
                  by.x=merge.x, by.y=canton_col, all.y=TRUE)

  # Create tile plot
  gg &amp;lt;- ggplot(ct.dat, aes_string(x=&amp;quot;col&amp;quot;, y=&amp;quot;row&amp;quot;, label=&amp;quot;abbrev&amp;quot;))
  gg &amp;lt;- gg + geom_tile(aes_string(fill=value_col))
  gg &amp;lt;- gg + geom_tile(color=canton_border_col, aes_string(fill=value_col),
                       size=2, show.legend =FALSE)
  gg &amp;lt;- gg + geom_text(color=text_color, size=font_size)
  
  # Add title
  gg &amp;lt;- gg + labs(title=plot_title, subtitle=plot_subtitle,
                  caption=plot_caption)
  
  # Set scales and coordinates system
  gg &amp;lt;- gg + scale_y_reverse()
  gg &amp;lt;- gg + scale_fill_gradientn(colours = brewer.pal(6, brewer_pal))
  gg &amp;lt;- gg + coord_equal()
  
  # Set minimal theme and remove axis titles, border, grid, 
  # background, axis ticks and axis text
  gg &amp;lt;- gg + theme_ipsum_rc()
  gg &amp;lt;- gg + labs(x=NULL, y=NULL)
  gg &amp;lt;- gg + theme(panel.border=element_blank())
  gg &amp;lt;- gg + theme(panel.grid=element_blank())
  gg &amp;lt;- gg + theme(panel.background=element_blank())
  gg &amp;lt;- gg + theme(axis.ticks=element_blank())
  gg &amp;lt;- gg + theme(axis.text=element_blank())

  return(gg)
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To test the function, let’s scrape a table from wikipedia containing the population per cantons. By inspecting the wikipedia code, you can see that the table has the &lt;code&gt;class&lt;/code&gt;: &lt;code&gt;wikitable&lt;/code&gt;. It can be extracted (with the help of &lt;code&gt;rvest&lt;/code&gt;) and converted into a usable dataframe (using &lt;code&gt;dplyr&lt;/code&gt;). The only modification are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;renaming the &lt;code&gt;Population[Note 2]&lt;/code&gt; column to something simpler&lt;/li&gt;
&lt;li&gt;converting the numbers stored as strings to numeric after removing their thousands “,”&lt;/li&gt;
&lt;li&gt;remove the total row for Switzerland (&lt;code&gt;Code != &amp;quot;CH&amp;quot;&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;selecting the columns of interest&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(rvest))
suppressMessages(library(dplyr))
suppressMessages(library(stringr))
suppressMessages(library(DT))

url &amp;lt;- &amp;quot;https://en.wikipedia.org/wiki/Cantons_of_Switzerland&amp;quot;
density &amp;lt;- url %&amp;gt;%
  read_html() %&amp;gt;%
  html_node(xpath=&amp;#39;//table[contains(@class,&amp;quot;wikitable&amp;quot;)]&amp;#39;) %&amp;gt;%
  html_table() %&amp;gt;%
  rename(Population=`Population[Note 2]`) %&amp;gt;%
  # Remove comma and notes reference (digit between brackets)
  mutate(Population=as.numeric(
    stringr::str_replace_all(
      Population, &amp;quot;(,|(\\[[:digit:]*\\]))&amp;quot;, &amp;quot;&amp;quot;))) %&amp;gt;%
  filter(Code != &amp;quot;CH&amp;quot;) %&amp;gt;%
  select(Code, Canton, Population)

DT::datatable(
  density,
  options = list(pageLength = 5, dom = &amp;#39;tpi&amp;#39;),
  rownames = FALSE,
  caption = &amp;quot;Table 1 : Subset of wikipedia data for cantons.&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;htmlwidget-1&#34; style=&#34;width:100%;height:auto;&#34; class=&#34;datatables html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-1&#34;&gt;{&#34;x&#34;:{&#34;filter&#34;:&#34;none&#34;,&#34;caption&#34;:&#34;&lt;caption&gt;Table 1 : Subset of wikipedia data for cantons.&lt;\/caption&gt;&#34;,&#34;data&#34;:[[&#34;ZH&#34;,&#34;BE&#34;,&#34;LU&#34;,&#34;UR&#34;,&#34;SZ&#34;,&#34;OW&#34;,&#34;NW&#34;,&#34;GL&#34;,&#34;ZG&#34;,&#34;FR&#34;,&#34;SO&#34;,&#34;BS&#34;,&#34;BL&#34;,&#34;SH&#34;,&#34;AR&#34;,&#34;AI&#34;,&#34;SG&#34;,&#34;GR&#34;,&#34;AG&#34;,&#34;TG&#34;,&#34;TI&#34;,&#34;VD&#34;,&#34;VS&#34;,&#34;NE&#34;,&#34;GE&#34;,&#34;JU&#34;],[&#34;Zürich&#34;,&#34;Bern&#34;,&#34;Luzern&#34;,&#34;Uri&#34;,&#34;Schwyz&#34;,&#34;Obwalden&#34;,&#34;Nidwalden&#34;,&#34;Glarus&#34;,&#34;Zug&#34;,&#34;Fribourg&#34;,&#34;Solothurn&#34;,&#34;Basel-Stadt&#34;,&#34;Basel-Landschaft&#34;,&#34;Schaffhausen&#34;,&#34;Appenzell Ausserrhoden&#34;,&#34;Appenzell Innerrhoden&#34;,&#34;St. Gallen&#34;,&#34;Graubünden&#34;,&#34;Aargau&#34;,&#34;Thurgau&#34;,&#34;Ticino&#34;,&#34;Vaud&#34;,&#34;Valais&#34;,&#34;Neuchâtel&#34;,&#34;Geneva&#34;,&#34;Jura&#34;],[1487969,1026513,403397,36145,155863,37378,42556,40147,123948,311914,269441,198249,286848,80769,54954,16003,502552,197550,663462,270709,354375,784822,339176,178567,489524,73122]],&#34;container&#34;:&#34;&lt;table class=\&#34;display\&#34;&gt;\n  &lt;thead&gt;\n    &lt;tr&gt;\n      &lt;th&gt;Code&lt;\/th&gt;\n      &lt;th&gt;Canton&lt;\/th&gt;\n      &lt;th&gt;Population&lt;\/th&gt;\n    &lt;\/tr&gt;\n  &lt;\/thead&gt;\n&lt;\/table&gt;&#34;,&#34;options&#34;:{&#34;pageLength&#34;:5,&#34;dom&#34;:&#34;tpi&#34;,&#34;columnDefs&#34;:[{&#34;className&#34;:&#34;dt-right&#34;,&#34;targets&#34;:2}],&#34;order&#34;:[],&#34;autoWidth&#34;:false,&#34;orderClasses&#34;:false,&#34;lengthMenu&#34;:[5,10,25,50,100]}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;
&lt;p&gt;We can now try the &lt;code&gt;cantonbins&lt;/code&gt; function.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;cantonbins(density, canton_col=&amp;quot;Code&amp;quot;, value_col=&amp;quot;Population&amp;quot;,
           plot_title=&amp;quot;Population size in Swiss Cantons&amp;quot;,
           plot_subtitle = paste0(&amp;quot;Source: &amp;quot;, url))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/1705081-cantonbins_files/figure-html/unnamed-chunk-5-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;There is a lot more we can do with Cartograms and, in a future post, I hope to release a full fork of &lt;a href=&#34;https://github.com/hrbrmstr/statebins&#34;&gt;statebin&lt;/a&gt; so that you can easily install it from Github.&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Scrape linked webpages using rvest and purrr</title>
      <link>/2017/04/16/scrape-linked-webpages-using-rvest-and-purrr/</link>
      <pubDate>Sun, 16 Apr 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/04/16/scrape-linked-webpages-using-rvest-and-purrr/</guid>
      <description>&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The offers on real estate websites aren’t always in an easy-to-use format, especially if you want to compare offers from multiple agencies.&lt;/p&gt;
&lt;p&gt;In a &lt;a href=&#34;https://xvrdm.github.io/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/&#34;&gt;previous post&lt;/a&gt;, we saw how to scrape a listing of apartments on a single page with R. However, listings usually do not include all the details about the items. They usually only list a condensed version of the information and a url to a “detail” page, which contains the rest of the fields. For example, we could not add any insight about “Floors” to our dataset as “Floor” is only detailled on each apartement details page. In this post, we will see how to:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;find the URL for each apartment&lt;/li&gt;
&lt;li&gt;scrape details found on each details page&lt;/li&gt;
&lt;li&gt;combine these details into a single dataframe&lt;/li&gt;
&lt;li&gt;merge this detail dataframe with our original dataframe&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div id=&#34;scraping-the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Scraping the data&lt;/h2&gt;
&lt;div id=&#34;getting-the-urls-for-each-apartment&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Getting the URLs for each apartment&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Load needed packages
suppressMessages(library(xml2))
suppressMessages(library(rvest))&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Create an html document
listing_url &amp;lt;- &amp;quot;https://www.moservernet.ch/en/apartments-for-rent/&amp;quot;
listing_html &amp;lt;- xml2::read_html(listing_url)

# Find all the nodes with class &amp;quot;offer&amp;quot; in id &amp;quot;offers&amp;quot;
offers &amp;lt;- listing_html %&amp;gt;%
  html_nodes(&amp;quot;#offers .offer&amp;quot;)

# Extract the first target url of each first link in each node
offers_urls &amp;lt;- offers %&amp;gt;%
  html_node(&amp;quot;a&amp;quot;) %&amp;gt;%
  html_attr(&amp;quot;href&amp;quot;)

head(offers_urls)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;/en/apartments-for-rent/cornavin-1-5-rooms--0570.42.0030&amp;quot;       
## [2] &amp;quot;/en/apartments-for-rent/grand-pre-1-5-rooms--7259.40.0010&amp;quot;      
## [3] &amp;quot;/en/apartments-for-rent/chene-bougeries-1-5-rooms--2652.41.0010&amp;quot;
## [4] &amp;quot;/en/apartments-for-rent/paquis-2-rooms--0630.40.0010&amp;quot;           
## [5] &amp;quot;/en/apartments-for-rent/servette-2-5-rooms--2078.31.0010&amp;quot;       
## [6] &amp;quot;/en/apartments-for-rent/grand-saconnex-3-rooms--2018.44.0040&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;using-one-example-to-map-our-scraping&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Using one example to map our scraping&lt;/h3&gt;
&lt;p&gt;Using the first link as an example, we can explore how the data should be scraped.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;offer_url &amp;lt;- offers_urls[1]
offer_url&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;/en/apartments-for-rent/cornavin-1-5-rooms--0570.42.0030&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The id of each offer is actually available directly in the URL.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;id &amp;lt;- offer_url %&amp;gt;%
  sub(&amp;quot;.*([0-9]{4}\\.[0-9]{2}\\.[0-9]{4}).*&amp;quot;,
      &amp;quot;\\1&amp;quot;, .)
id&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;0570.42.0030&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next we need to scrape the data contained at this URL. As links are relative, we start by rebuilding the full link, which we use with &lt;code&gt;xml2::read_html()&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Create full URL for offer
BASE_URL &amp;lt;- &amp;quot;https://www.moservernet.ch&amp;quot;
offer_full_url &amp;lt;- paste0(BASE_URL, offer_url)

# Scrape HTML for offer
offer_html &amp;lt;- xml2::read_html(offer_full_url)&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1704161-scrsh-msrvrn-apartment-source.png&#34; alt=&#34;Screenshot of source code for apartment detail webpage&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Screenshot of source code for apartment detail webpage&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Looking at the source code, we can see that the attributes we are after (“Floor” and “Surface area”) are located in the same node: a &lt;code&gt;h2&lt;/code&gt; tag contained in a &lt;code&gt;td&lt;/code&gt; tag with &lt;code&gt;itemprop=itemOffered&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;offer_attr &amp;lt;- offer_html %&amp;gt;%
  html_node(&amp;quot;[itemprop=itemOffered]&amp;quot;) %&amp;gt;%
  html_text() %&amp;gt;%
  stringr::str_trim() %&amp;gt;%
  stringr::str_split(&amp;quot; - &amp;quot;, simplify = T) %&amp;gt;%
  as.vector()
offer_attr&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;1.5 rooms&amp;quot; &amp;quot;36m²&amp;quot;      &amp;quot;Floor 2&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;With a bit more parsing, we can get clean numbers.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Find floor data by finding the vector element
# containing text &amp;quot;Floor&amp;quot; and isolating the
# number next to it.
floor &amp;lt;- grep(&amp;quot;Floor&amp;quot;, offer_attr, value = T) %&amp;gt;%
  stringr::str_replace(&amp;quot;Floor&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_trim()
floor&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;2&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Find surface area data by finding the vector 
# element containing text &amp;quot;m²&amp;quot; and isolating the
# number next to it.
surface &amp;lt;- grep(&amp;quot;m²&amp;quot;, offer_attr, value = T) %&amp;gt;%
  stringr::str_replace(&amp;quot;m²&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_trim()
surface&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;36&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;However, if we look closely at the list of urls, there seem to be two types of URLs.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;table(sub(&amp;quot;(/.*/.*/).*&amp;quot;,&amp;quot;\\1&amp;quot;,offers_urls)) %&amp;gt;%
  tibble::as_tibble() %&amp;gt;%
  setNames(c(&amp;quot;URL start with:&amp;quot;,&amp;quot;n&amp;quot;)) &lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 2 x 2
##                    `URL start with:`     n
##                                &amp;lt;chr&amp;gt; &amp;lt;int&amp;gt;
## 1           /en/apartments-for-rent/    15
## 2 /en/residential-property-for-rent/     7&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Most URLs follow the pattern &lt;code&gt;/en/apartments-for-rent/&amp;lt;address&amp;gt;--&amp;lt;id&amp;gt;&lt;/code&gt; but a few look like &lt;code&gt;/en/residential-property-for-rent/&amp;lt;address&amp;gt;--&amp;lt;id&amp;gt;&lt;/code&gt;. If we open one, we can see that the page layout is different.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1704161-scrsh-msrvrn-property-source.png&#34; alt=&#34;Screenshot of source code for residential detail webpage&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Screenshot of source code for residential detail webpage&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;The surface area is still available in a node with &lt;code&gt;[itemprop=itemOffered]&lt;/code&gt;, but the floor is in another node, which seem to be the first node with class &lt;code&gt;price&lt;/code&gt;. With a bit of rewriting on the floor code, we can adapt to the 2 different layouts:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# The code below can find the floor on both layout types,
# which are identified by a pattern in their url.
floor &amp;lt;- ifelse(
    grepl(&amp;quot;apartments&amp;quot;, offer_url),
    grep(&amp;quot;Floor&amp;quot;, offer_attr, value = T),
    offer_html %&amp;gt;% 
      html_node(&amp;quot;.price&amp;quot;) %&amp;gt;%
      html_text()) %&amp;gt;%
  stringr::str_replace(&amp;quot;Floor[:]{0,1}&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_trim() %&amp;gt;%
  as.numeric()&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;scraping-all-links-with-reusable-code&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Scraping all links with reusable code&lt;/h3&gt;
&lt;p&gt;We can now put all our code together in a function and use it on each link. Note that the &lt;code&gt;slow_scrape_extra_info&lt;/code&gt; wrapper just make sure we wait for a little while between each request.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;scrape_extra_info &amp;lt;- function(offer_url) {
  BASE_URL &amp;lt;- &amp;quot;https://www.moservernet.ch&amp;quot;
  offer_full_url &amp;lt;- paste0(BASE_URL, offer_url)
  offer_html &amp;lt;- xml2::read_html(offer_full_url)
  
  offer_attr &amp;lt;- offer_html %&amp;gt;%
    html_node(&amp;quot;[itemprop=itemOffered]&amp;quot;) %&amp;gt;%
    html_text() %&amp;gt;%
    stringr::str_trim() %&amp;gt;%
    stringr::str_split(&amp;quot; - &amp;quot;, simplify = T) %&amp;gt;%
    as.vector()

  list(
    id = offer_url %&amp;gt;%
      sub(&amp;quot;.*([0-9]{4}\\.[0-9]{2}\\.[0-9]{4}).*&amp;quot;,
        &amp;quot;\\1&amp;quot;, .),
    
     floor = ifelse(
         grepl(&amp;quot;apartments&amp;quot;, offer_url),
         grep(&amp;quot;Floor&amp;quot;, offer_attr, value = T),
         offer_html %&amp;gt;% 
           html_node(&amp;quot;.price&amp;quot;) %&amp;gt;%
           html_text()) %&amp;gt;%
       stringr::str_replace(&amp;quot;Floor[:]{0,1}&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
       stringr::str_trim() %&amp;gt;%
       as.numeric(),
  
     surface = grep(&amp;quot;m²&amp;quot;, offer_attr, value = T) %&amp;gt;%
       stringr::str_replace(&amp;quot;m²&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
       stringr::str_trim() %&amp;gt;%
       as.numeric()
  )
}

slow_scrape_extra_info &amp;lt;- function(offer_url) {
  Sys.sleep(sample(1:15/10,1))
  scrape_extra_info(offer_url)
}

# Apply the function to each url that contains an offer id
# and store the results into a single dataframe
extra_info &amp;lt;- grep(&amp;quot;.*([0-9]{4}\\.[0-9]{2}\\.[0-9]{4}).*&amp;quot;,
                   offers_urls, value = T) %&amp;gt;%
  purrr::map(slow_scrape_extra_info) %&amp;gt;%
  dplyr::bind_rows() %&amp;gt;%
  na.omit()

knitr::kable(head(extra_info))&lt;/code&gt;&lt;/pre&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;left&#34;&gt;id&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;floor&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;surface&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2454.44.0030&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;4&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;24&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2040.41.0020&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;44&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2066.41.0010&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;48&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;0510.45.0030&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;5&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;55&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2457.41.0020&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;50&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2018.48.0020&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;8&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;58&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Thanks to the common &lt;code&gt;id&lt;/code&gt; field, we can &lt;a href=&#34;http://dplyr.tidyverse.org/reference/join.html&#34;&gt;join&lt;/a&gt; this dataframe with the one obtained in the &lt;a href=&#34;https://xvrdm.github.io/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/&#34;&gt;previous post&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Scrape a list of rental offers using rvest and purrr</title>
      <link>/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/</link>
      <pubDate>Fri, 31 Mar 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/</guid>
      <description>&lt;script src=&#34;../rmarkdown-libs/htmlwidgets/htmlwidgets.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../rmarkdown-libs/jquery/jquery.min.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../rmarkdown-libs/datatables-binding/datatables.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../rmarkdown-libs/dt-core/css/jquery.dataTables.min.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;link href=&#34;../rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../rmarkdown-libs/dt-core/js/jquery.dataTables.min.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../rmarkdown-libs/leaflet/leaflet.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../rmarkdown-libs/leaflet/leaflet.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../rmarkdown-libs/leafletfix/leafletfix.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;link href=&#34;../rmarkdown-libs/leaflet-label/leaflet.label.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../rmarkdown-libs/leaflet-label/leaflet.label.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../rmarkdown-libs/Proj4Leaflet/proj4-compressed.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../rmarkdown-libs/Proj4Leaflet/proj4leaflet.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../rmarkdown-libs/leaflet-binding/leaflet.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../rmarkdown-libs/leaflet-providers/leaflet-providers.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../rmarkdown-libs/leaflet-providers-plugin/leaflet-providers-plugin.js&#34;&gt;&lt;/script&gt;


&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The offers on real estate websites aren’t always in an easy-to-use format, especially if you want to compare offers from multiple agencies.&lt;/p&gt;
&lt;p&gt;In this post, we will see how to use R to scrape the details about the apartments listed on a single page on a real estate website.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;scraping-the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Scraping the data&lt;/h2&gt;
&lt;div id=&#34;getting-to-know-the-site&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Getting to know the site&lt;/h3&gt;
&lt;p&gt;We start by looking at the real estate agent website. The section containing apartment rental offers can be found at this &lt;a href=&#34;https://www.moservernet.ch/en/apartments-for-rent/&#34;&gt;URL&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1703311-scrsh-website-msrvrn.png&#34; alt=&#34;Apartment Rental section on website&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Apartment Rental section on website&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Each flat seem to be displayed in its own little box, which should derive from code not to hard to parse. But it would be even easier if the data was grabed from some kind of API.&lt;/p&gt;
&lt;p&gt;Looking at the network tab of the inspector, it doesn’t look like we can easily identify an API.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../img/1703311-scrsh-network-msrvrn.png&#34; alt=&#34;Network tab from inspector tool on Apartment Rental section website&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Network tab from inspector tool on Apartment Rental section website&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;We will need to fall back on scraping.&lt;/p&gt;
&lt;p&gt;Looking at the page source, we can see that all the information seem to be present so we won’t need to rely on a headless browser to execute Javascript. The data seems neatly organised.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../img/1703311-scrsh-source-msrvrn.png&#34; alt=&#34;Source code from Apartment Rental section on website&#34; /&gt; On the screenshot above, we can see that all the apartments are in a &lt;code&gt;div&lt;/code&gt; with the &lt;code&gt;id=offers&lt;/code&gt; (blue rectangle). Then each apartment is contained in its own &lt;code&gt;div&lt;/code&gt; with the &lt;code&gt;class=offer&lt;/code&gt; (red rectangles). We can also see that the different attributes of each flat are in separated &lt;code&gt;div&lt;/code&gt; or &lt;code&gt;h&lt;/code&gt; tags, usually with meaningful &lt;code&gt;class&lt;/code&gt; like &lt;code&gt;price-offer&lt;/code&gt;, &lt;code&gt;charge-offer&lt;/code&gt;, &lt;code&gt;size-offer&lt;/code&gt;… Very conveniently, and probably because they have a google map applet, the latitude and longitude are already available with the classes &lt;code&gt;info-obj-address-lat&lt;/code&gt; and &lt;code&gt;info-obj-address-lng&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;getting-the-page-source-into-r&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Getting the page source into R&lt;/h3&gt;
&lt;p&gt;Using the &lt;code&gt;rvest&lt;/code&gt; library, we can grab the code of the site.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Load needed packages
suppressMessages(library(dplyr))
suppressMessages(library(xml2))
suppressMessages(library(rvest))&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Create an html document
listing_url &amp;lt;- &amp;quot;https://www.moservernet.ch/en/apartments-for-rent/&amp;quot;
listing_html &amp;lt;- xml2::read_html(listing_url)
listing_html&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## {xml_document}
## &amp;lt;html&amp;gt;
## [1] &amp;lt;head&amp;gt;\n&amp;lt;meta http-equiv=&amp;quot;Content-Type&amp;quot; content=&amp;quot;text/html;charset=u ...
## [2] &amp;lt;body&amp;gt;\n\t\t&amp;lt;div id=&amp;quot;main&amp;quot;&amp;gt;\t\n\t\t\t&amp;lt;div class=&amp;quot;container&amp;quot; style=&amp;quot;h ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;isolate-the-html-for-the-offers&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Isolate the html for the offers&lt;/h3&gt;
&lt;p&gt;Then we isolate the nodes with &lt;code&gt;class=offer&lt;/code&gt; contained in the &lt;code&gt;div&lt;/code&gt; with &lt;code&gt;id=offers&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;listing_offers &amp;lt;- listing_html %&amp;gt;%
  rvest::html_nodes(&amp;quot;#offers .offer&amp;quot;)
head(listing_offers)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## {xml_nodeset (6)}
## [1] &amp;lt;div class=&amp;quot;offer cat1 cat2 2&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-f ...
## [2] &amp;lt;div class=&amp;quot;offer cat1 cat2 2&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-f ...
## [3] &amp;lt;div class=&amp;quot;offer cat1 cat2 1&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-f ...
## [4] &amp;lt;div class=&amp;quot;offer cat2 2&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-for-re ...
## [5] &amp;lt;div class=&amp;quot;offer cat2 cat3 2&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-f ...
## [6] &amp;lt;div class=&amp;quot;offer cat3 3&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-for-re ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;parsing-the-offers&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Parsing the offers&lt;/h3&gt;
&lt;p&gt;Now that we have a list of offers, we need to find a way to extract the data of interest from each offer and store it in a usable format. There are at least two way to proceed: a “field centric” way and an “offer centric” way.&lt;/p&gt;
&lt;div id=&#34;parsing-with-the-field-centric-way&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Parsing with the “field centric” way&lt;/h4&gt;
&lt;p&gt;In the “field centric” way, we grab one field of interest (&lt;code&gt;rent&lt;/code&gt;, &lt;code&gt;rooms&lt;/code&gt;, &lt;code&gt;address&lt;/code&gt;…) at a time for all the offers. We end up with vectors containing the value of the field for each offer. These vector can then be combined into a dataframe. The “field centric” way is described in the lego movie example on &lt;a href=&#34;http://web.archive.org/web/20160113072819/https://github.com/hadley/rvest&#34;&gt;&lt;code&gt;rvest&lt;/code&gt;’s github repo&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;id&lt;/code&gt; and &lt;code&gt;address&lt;/code&gt; can be stored as text and only need a bit of cleanup.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;id &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.ref&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  stringr::str_replace(&amp;quot;Ref. &amp;quot;,&amp;quot;&amp;quot;)

address &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.location-offer&amp;quot;) %&amp;gt;%
  rvest::html_text()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;rooms&lt;/code&gt;, &lt;code&gt;latitude&lt;/code&gt;, &lt;code&gt;longitude&lt;/code&gt;, &lt;code&gt;rent&lt;/code&gt; and &lt;code&gt;charges&lt;/code&gt; are better saved as numeric after removal of prefix/suffix like currencies. Note that &lt;code&gt;stringr&lt;/code&gt;’s &lt;code&gt;str_replace&lt;/code&gt; can search for regular expressions pattern, which let us do things like removing &lt;code&gt;room&lt;/code&gt; and &lt;code&gt;rooms&lt;/code&gt; in one call.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;rooms &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.ref-offer&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  stringr::str_replace(&amp;quot; room[s]*&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  as.numeric()

latitude &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.infos-objet-address-lat&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  as.numeric()

longitude &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.infos-objet-address-lng&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  as.numeric()

rent &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.price-offer&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  stringr::str_replace(&amp;quot;CHF &amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_replace_all(&amp;quot;[.]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_replace(&amp;quot;[-]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  as.numeric()

charges &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.charge-offer&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  stringr::str_replace(&amp;quot;Charges: CHF &amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_replace_all(&amp;quot;[.]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_replace(&amp;quot;[-]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  as.numeric()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;All these vectors can then be combined in a dataframe, which is nicely displayed in an interactive datatable.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;offers &amp;lt;- data.frame(id, 
                     rooms, 
                     address, 
                     latitude, 
                     longitude, 
                     rent, 
                     charges)

library(DT)
DT::datatable(
  offers,
  options = list(pageLength = 5, dom = &amp;#39;tpi&amp;#39;),
  rownames = FALSE,
  caption = &amp;quot;Table 1 : Offers scraped using the field centric way&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;htmlwidget-1&#34; style=&#34;width:100%;height:auto;&#34; class=&#34;datatables html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-1&#34;&gt;{&#34;x&#34;:{&#34;filter&#34;:&#34;none&#34;,&#34;caption&#34;:&#34;&lt;caption&gt;Table 1 : Offers scraped using the field centric way&lt;\/caption&gt;&#34;,&#34;data&#34;:[[&#34;0570.42.0030&#34;,&#34;7259.40.0010&#34;,&#34;2652.41.0010&#34;,&#34;0630.40.0010&#34;,&#34;2078.31.0010&#34;,&#34;2018.44.0040&#34;,&#34;0675.42.0250&#34;,&#34;2040.41.0010&#34;,&#34;0110.43.0020&#34;,&#34;0575.44.0020&#34;,&#34;0159.43.0020&#34;,&#34;0198.46.0020&#34;,&#34;0158.46.0020&#34;,&#34;2341.45.0010&#34;,&#34;0022.40.0010&#34;,&#34;0082.44.0030&#34;,&#34;2233.39.9030&#34;,&#34;0615.45.0010&#34;,&#34;2027.46.0060&#34;,&#34;0082.44.0010&#34;,&#34;0082.43.0010&#34;],[1.5,1.5,1.5,2,2.5,3,3.5,3.5,6,4.5,4,5.5,5.5,4.5,4.5,3,6,6,6,6,9],[&#34;Rue de la Faucille 12&#34;,&#34;Rue du Vidollet 18&#34;,&#34;Rue de Chêne-Bougeries 40&#34;,&#34;42, rue de Zürich&#34;,&#34;Avenue De-Luserna 36&#34;,&#34;Chemin Taverney 6&#34;,&#34;Rue du Belvédère 8&#34;,&#34;Rue Henri-ChristinÃ© 6&#34;,&#34;Rue de GenÃ¨ve 123 A&#34;,&#34;Grand-Montfleury 30&#34;,&#34;Place de l&#39;Octroi 13&#34;,&#34;Rue de ChÃªne-Bougeries 29&#34;,&#34;Chemin des Palettes 29&#34;,&#34;Rue Cavour 9&#34;,&#34;Avenue Giuseppe-Motta 16&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Maurice-Braillard 16&#34;,&#34;Route de ChÃªne 53&#34;,&#34;Rue Charles-Giron 1&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Saint-LÃ©ger 8&#34;],[46.2110823,46.2172471,46.1956311,46.2123577,46.2139829,46.2299972,46.2049398,46.1945565,46.1929323,46.2936297,46.1874919,46.1964161,46.1754533,46.2068797,46.2167452,46.1976599,46.220471,46.2001689,46.2061894,46.1976599,46.1976599],[6.1399174,6.1377483,6.191422,6.1452134,6.1246849,6.1177381,6.1315508,6.1424891,6.2037003,6.1646624,6.1405418,6.190808,6.11947,6.1320354,6.1316818,6.1462625,6.1325586,6.1723494,6.1306914,6.1462625,6.1462625],[1150,1200,1300,1390,1400,1600,1990,1990,2200,2230,2350,2450,2700,2780,2950,2950,3900,4500,4900,10900,13900],[90,60,100,80,100,90,140,130,200,165,200,210,170,220,200,175,365,350,350,445,325]],&#34;container&#34;:&#34;&lt;table class=\&#34;display\&#34;&gt;\n  &lt;thead&gt;\n    &lt;tr&gt;\n      &lt;th&gt;id&lt;\/th&gt;\n      &lt;th&gt;rooms&lt;\/th&gt;\n      &lt;th&gt;address&lt;\/th&gt;\n      &lt;th&gt;latitude&lt;\/th&gt;\n      &lt;th&gt;longitude&lt;\/th&gt;\n      &lt;th&gt;rent&lt;\/th&gt;\n      &lt;th&gt;charges&lt;\/th&gt;\n    &lt;\/tr&gt;\n  &lt;\/thead&gt;\n&lt;\/table&gt;&#34;,&#34;options&#34;:{&#34;pageLength&#34;:5,&#34;dom&#34;:&#34;tpi&#34;,&#34;columnDefs&#34;:[{&#34;className&#34;:&#34;dt-right&#34;,&#34;targets&#34;:[1,3,4,5,6]}],&#34;order&#34;:[],&#34;autoWidth&#34;:false,&#34;orderClasses&#34;:false,&#34;lengthMenu&#34;:[5,10,25,50,100]}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;
&lt;/div&gt;
&lt;div id=&#34;parsing-with-the-offer-centric-way&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Parsing with the “offer centric” way&lt;/h4&gt;
&lt;p&gt;In the “offer centric” way, we parse one offer at a time, extract all the fields of interest and store it into a list. We end up with a list of lists, where each list contain all the fields for one offer.&lt;/p&gt;
&lt;p&gt;To parse each offer, we are going to create a function &lt;code&gt;parse_offer&lt;/code&gt; that works well on one offer and apply it to each offer with the help of the &lt;code&gt;purrr&lt;/code&gt; package.&lt;/p&gt;
&lt;p&gt;Note that we are searching only for one value, so we use &lt;code&gt;html_node&lt;/code&gt; and not &lt;code&gt;html_nodes&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;parse_offer &amp;lt;- function(offer) {
  list(
    id = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.ref&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      stringr::str_replace(&amp;quot;Ref. &amp;quot;,&amp;quot;&amp;quot;),
    
    address = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.location-offer&amp;quot;) %&amp;gt;%
      rvest::html_text(),
  
    room = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.ref-offer&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      stringr::str_replace(&amp;quot; room[s]*&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      as.numeric(),
    
    latitude = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.infos-objet-address-lat&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      as.numeric(),

    longitude = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.infos-objet-address-lng&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      as.numeric(),

    rent = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.price-offer&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      stringr::str_replace(&amp;quot;CHF &amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      stringr::str_replace_all(&amp;quot;[.]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      stringr::str_replace(&amp;quot;[-]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      as.numeric(),

    charges = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.charge-offer&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      stringr::str_replace(&amp;quot;Charges: CHF &amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      stringr::str_replace_all(&amp;quot;[.]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      stringr::str_replace(&amp;quot;[-]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      as.numeric()
  )
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;purrr::map&lt;/code&gt; will create a list of lists. Each list in the list of lists can be bound as a row in a dataframe, thanks to &lt;code&gt;dplyr::bind_rows()&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(purrr))

offers &amp;lt;- listing_offers %&amp;gt;%
  purrr::map(parse_offer) %&amp;gt;%
  dplyr::bind_rows() %&amp;gt;%
  na.omit()

DT::datatable(
  offers,
  options = list(pageLength = 5, dom = &amp;#39;tpi&amp;#39;),
  rownames = FALSE,
  caption = &amp;quot;Table 2 : Offers scraped using the offer centric way&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;htmlwidget-2&#34; style=&#34;width:100%;height:auto;&#34; class=&#34;datatables html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-2&#34;&gt;{&#34;x&#34;:{&#34;filter&#34;:&#34;none&#34;,&#34;caption&#34;:&#34;&lt;caption&gt;Table 2 : Offers scraped using the offer centric way&lt;\/caption&gt;&#34;,&#34;data&#34;:[[&#34;0570.42.0030&#34;,&#34;7259.40.0010&#34;,&#34;2652.41.0010&#34;,&#34;0630.40.0010&#34;,&#34;2078.31.0010&#34;,&#34;2018.44.0040&#34;,&#34;0675.42.0250&#34;,&#34;2040.41.0010&#34;,&#34;0110.43.0020&#34;,&#34;0575.44.0020&#34;,&#34;0159.43.0020&#34;,&#34;0198.46.0020&#34;,&#34;0158.46.0020&#34;,&#34;2341.45.0010&#34;,&#34;0022.40.0010&#34;,&#34;0082.44.0030&#34;,&#34;2233.39.9030&#34;,&#34;0615.45.0010&#34;,&#34;2027.46.0060&#34;,&#34;0082.44.0010&#34;,&#34;0082.43.0010&#34;],[&#34;Rue de la Faucille 12&#34;,&#34;Rue du Vidollet 18&#34;,&#34;Rue de Chêne-Bougeries 40&#34;,&#34;42, rue de Zürich&#34;,&#34;Avenue De-Luserna 36&#34;,&#34;Chemin Taverney 6&#34;,&#34;Rue du Belvédère 8&#34;,&#34;Rue Henri-ChristinÃ© 6&#34;,&#34;Rue de GenÃ¨ve 123 A&#34;,&#34;Grand-Montfleury 30&#34;,&#34;Place de l&#39;Octroi 13&#34;,&#34;Rue de ChÃªne-Bougeries 29&#34;,&#34;Chemin des Palettes 29&#34;,&#34;Rue Cavour 9&#34;,&#34;Avenue Giuseppe-Motta 16&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Maurice-Braillard 16&#34;,&#34;Route de ChÃªne 53&#34;,&#34;Rue Charles-Giron 1&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Saint-LÃ©ger 8&#34;],[1.5,1.5,1.5,2,2.5,3,3.5,3.5,6,4.5,4,5.5,5.5,4.5,4.5,3,6,6,6,6,9],[46.2110823,46.2172471,46.1956311,46.2123577,46.2139829,46.2299972,46.2049398,46.1945565,46.1929323,46.2936297,46.1874919,46.1964161,46.1754533,46.2068797,46.2167452,46.1976599,46.220471,46.2001689,46.2061894,46.1976599,46.1976599],[6.1399174,6.1377483,6.191422,6.1452134,6.1246849,6.1177381,6.1315508,6.1424891,6.2037003,6.1646624,6.1405418,6.190808,6.11947,6.1320354,6.1316818,6.1462625,6.1325586,6.1723494,6.1306914,6.1462625,6.1462625],[1150,1200,1300,1390,1400,1600,1990,1990,2200,2230,2350,2450,2700,2780,2950,2950,3900,4500,4900,10900,13900],[90,60,100,80,100,90,140,130,200,165,200,210,170,220,200,175,365,350,350,445,325]],&#34;container&#34;:&#34;&lt;table class=\&#34;display\&#34;&gt;\n  &lt;thead&gt;\n    &lt;tr&gt;\n      &lt;th&gt;id&lt;\/th&gt;\n      &lt;th&gt;address&lt;\/th&gt;\n      &lt;th&gt;room&lt;\/th&gt;\n      &lt;th&gt;latitude&lt;\/th&gt;\n      &lt;th&gt;longitude&lt;\/th&gt;\n      &lt;th&gt;rent&lt;\/th&gt;\n      &lt;th&gt;charges&lt;\/th&gt;\n    &lt;\/tr&gt;\n  &lt;\/thead&gt;\n&lt;\/table&gt;&#34;,&#34;options&#34;:{&#34;pageLength&#34;:5,&#34;dom&#34;:&#34;tpi&#34;,&#34;columnDefs&#34;:[{&#34;className&#34;:&#34;dt-right&#34;,&#34;targets&#34;:[2,3,4,5,6]}],&#34;order&#34;:[],&#34;autoWidth&#34;:false,&#34;orderClasses&#34;:false,&#34;lengthMenu&#34;:[5,10,25,50,100]}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;visualize-the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Visualize the data&lt;/h2&gt;
&lt;div id=&#34;looking-at-bivariate-relationship&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Looking at bivariate relationship&lt;/h3&gt;
&lt;p&gt;We can check if rent and charges seem to be correlated.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(ggplot2))
suppressMessages(library(hrbrthemes))

offers %&amp;gt;% ggplot(aes(x=rent, y=charges)) + 
  geom_jitter(alpha=0.5) +
  geom_smooth(method = &amp;quot;lm&amp;quot;, size=0.5, se = F, color=&amp;quot;black&amp;quot;) + 
  annotate(geom=&amp;quot;label&amp;quot;, x=max(offers$rent), y=min(offers$charges),
           label=paste(&amp;quot;r(rent, charge) =&amp;quot;, round(cor(offers$rent, offers$charges), 3)), 
           hjust=1, fill=&amp;quot;black&amp;quot;, alpha=&amp;quot;0.5&amp;quot;, color=&amp;quot;white&amp;quot;) +
  labs(title=stringr::str_to_title(&amp;quot;Do charges go up with rent?&amp;quot;),
       subtitle=&amp;quot;There seems to be a positive linear relationship between rent and charges.&amp;quot;) +
  theme_ipsum_rc()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../post/1703311-scrape-a-list-of-rental-offers-using-rvest-and-purrr_files/figure-html/unnamed-chunk-9-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;seeing-the-results-on-a-map&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Seeing the results on a map&lt;/h3&gt;
&lt;p&gt;Lastly, because latitude and longitude were so easily obtained, we can pin each flat on a leaflet map.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(leaflet))

m &amp;lt;- leaflet(offers) %&amp;gt;%
  addProviderTiles(&amp;quot;CartoDB.Positron&amp;quot;) %&amp;gt;%
  addMarkers(lng=~longitude,
             lat=~latitude,
             popup=offers$address)
m&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;htmlwidget-3&#34; style=&#34;width:672px;height:480px;&#34; class=&#34;leaflet html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-3&#34;&gt;{&#34;x&#34;:{&#34;options&#34;:{&#34;crs&#34;:{&#34;crsClass&#34;:&#34;L.CRS.EPSG3857&#34;,&#34;code&#34;:null,&#34;proj4def&#34;:null,&#34;projectedBounds&#34;:null,&#34;options&#34;:{}}},&#34;calls&#34;:[{&#34;method&#34;:&#34;addProviderTiles&#34;,&#34;args&#34;:[&#34;CartoDB.Positron&#34;,null,null,{&#34;errorTileUrl&#34;:&#34;&#34;,&#34;noWrap&#34;:false,&#34;zIndex&#34;:null,&#34;unloadInvisibleTiles&#34;:null,&#34;updateWhenIdle&#34;:null,&#34;detectRetina&#34;:false,&#34;reuseTiles&#34;:false}]},{&#34;method&#34;:&#34;addMarkers&#34;,&#34;args&#34;:[[46.2110823,46.2172471,46.1956311,46.2123577,46.2139829,46.2299972,46.2049398,46.1945565,46.1929323,46.2936297,46.1874919,46.1964161,46.1754533,46.2068797,46.2167452,46.1976599,46.220471,46.2001689,46.2061894,46.1976599,46.1976599],[6.1399174,6.1377483,6.191422,6.1452134,6.1246849,6.1177381,6.1315508,6.1424891,6.2037003,6.1646624,6.1405418,6.190808,6.11947,6.1320354,6.1316818,6.1462625,6.1325586,6.1723494,6.1306914,6.1462625,6.1462625],null,null,null,{&#34;clickable&#34;:true,&#34;draggable&#34;:false,&#34;keyboard&#34;:true,&#34;title&#34;:&#34;&#34;,&#34;alt&#34;:&#34;&#34;,&#34;zIndexOffset&#34;:0,&#34;opacity&#34;:1,&#34;riseOnHover&#34;:false,&#34;riseOffset&#34;:250},[&#34;Rue de la Faucille 12&#34;,&#34;Rue du Vidollet 18&#34;,&#34;Rue de Chêne-Bougeries 40&#34;,&#34;42, rue de Zürich&#34;,&#34;Avenue De-Luserna 36&#34;,&#34;Chemin Taverney 6&#34;,&#34;Rue du Belvédère 8&#34;,&#34;Rue Henri-ChristinÃ© 6&#34;,&#34;Rue de GenÃ¨ve 123 A&#34;,&#34;Grand-Montfleury 30&#34;,&#34;Place de l&#39;Octroi 13&#34;,&#34;Rue de ChÃªne-Bougeries 29&#34;,&#34;Chemin des Palettes 29&#34;,&#34;Rue Cavour 9&#34;,&#34;Avenue Giuseppe-Motta 16&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Maurice-Braillard 16&#34;,&#34;Route de ChÃªne 53&#34;,&#34;Rue Charles-Giron 1&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Saint-LÃ©ger 8&#34;],null,null,null,null,null,null]}],&#34;limits&#34;:{&#34;lat&#34;:[46.1754533,46.2936297],&#34;lng&#34;:[6.1177381,6.2037003]}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;ressources&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Ressources&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hadley/rvest&#34;&gt;Homepage for rvest repo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://stat4701.github.io/edav/2015/04/02/rvest_tutorial/&#34;&gt;Tutorial explaining rvest basics&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>