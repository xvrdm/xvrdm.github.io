<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Scraping on Invalid Input</title>
    <link>/tags/scraping/index.xml</link>
    <description>Recent content in Scraping on Invalid Input</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <atom:link href="/tags/scraping/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Scraping javascript generated content with splashr</title>
      <link>/2017/07/26/scraping-javascript-generated-content-with-splashr/</link>
      <pubDate>Wed, 26 Jul 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/07/26/scraping-javascript-generated-content-with-splashr/</guid>
      <description>&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;While scraping rental listings, it’s useful to verify that the scripts managed to grab all the offers. This is nice to have on simple &lt;a href=&#34;https://www.moservernet.ch/en/apartments-for-rent/&#34;&gt;fully loaded single page&lt;/a&gt;, but even nicer if the rental listings are set up as a &lt;a href=&#34;http://www.brolliet.ch/en/rent/&#34;&gt;infinite scroll page&lt;/a&gt;, which seem increasingly popular on real estate websites and require multiple calls from the scraper.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/1707263-scrsh-count-msrvrn.png&#34; alt=&#34;Count of offers on rental websites.&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Count of offers on rental websites.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Even when they don’t load all the results, the websites nearly always indicate the number of matched offers. This can be used to verify that our final dataset has the correct number of rows.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;scraping-the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Scraping the data&lt;/h2&gt;
&lt;div id=&#34;scraping-static-content&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Scraping static content&lt;/h3&gt;
&lt;p&gt;Using &lt;a href=&#34;https://xvrdm.github.io/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/&#34;&gt;our previous example&lt;/a&gt;, we can see that the number of matched offers is written on the page.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/1707261-scrsh-count-msrvrn.png&#34; alt=&#34;Count of offers can be found on the page.&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Count of offers can be found on the page.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Please keep in mind that I took the screenshot when I originally published the post and reran the code multiple times since. So the final scraped number might not match the screenshot.&lt;/p&gt;
&lt;p&gt;Inspect the html of the page to find the id/class of the number of results and store it in a variable. We can complete the code as below:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Load needed packages
suppressMessages(library(xml2))
suppressMessages(library(rvest))

# Create an html document
listing_url &amp;lt;- &amp;quot;https://www.moservernet.ch/en/apartments-for-rent/&amp;quot;
listing_html &amp;lt;- xml2::read_html(listing_url)

# Find the number of listed offers
listing_html %&amp;gt;%
  html_node(&amp;quot;#count-search&amp;quot;) %&amp;gt;%
  html_text()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;()&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Empty? It looks like the count is actually populated by a tiny bit of javascript, so it’s not available when we parse the page source.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/1707262-scrsh-js-msrvrn.png&#34; alt=&#34;The counter is updated by Javascript.&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;The counter is updated by Javascript.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;scraping-content-generated-by-javascript&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Scraping content generated by javascript&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;xml2::read_html&lt;/code&gt; by itself cannot inspect the content generated by javascript. For that we can use another library &lt;a href=&#34;https://github.com/hrbrmstr/splashr&#34;&gt;&lt;code&gt;splashr&lt;/code&gt;&lt;/a&gt;. In a nutshell, &lt;code&gt;splashr&lt;/code&gt; lets you spin and interact with a &lt;a href=&#34;https://splash.readthedocs.io/en/stable/&#34;&gt;splash&lt;/a&gt; headless browser in a &lt;a href=&#34;https://www.docker.com/&#34;&gt;docker&lt;/a&gt; container. If this sounds like jibberish, let’s try a translation:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;“spin and interact with a headless browser”: create a virtual browser (we won’t see it, it happens in the background) that will browse/render the page and give us back it’s content (including the javascript generated content). “Splash” is one these headless browsers, but you might have heard of another one named “phantomJS”.&lt;/li&gt;
&lt;li&gt;“in a docker container”: think of docker is a way to easily run lightweight virtual machines (called container). So rather than installing splash and all its python dependencies, we will run a virtual machine with splash installed in it and destroy it when we are done, leaving our main system untouched.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Installing docker is beyond the scope of this post, but there are tons of ressource online. At the time of this writing, to install &lt;a href=&#34;https://github.com/hrbrmstr/splashr&#34;&gt;&lt;code&gt;splashr&lt;/code&gt;&lt;/a&gt; and &lt;a href=&#34;https://github.com/bhaskarvk/docker&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the package that manages docker from R), you need to grab them from github.&lt;/p&gt;
&lt;p&gt;The github page of &lt;a href=&#34;https://github.com/bhaskarvk/docker&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the R package) explains how to install the python package &lt;a href=&#34;https://docker-py.readthedocs.io/en/stable/&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt;. Yes, you read that well: in order to use &lt;a href=&#34;http://splash.readthedocs.io&#34;&gt;&lt;code&gt;splash&lt;/code&gt;&lt;/a&gt; (the scrapping python lib), &lt;a href=&#34;https://github.com/hrbrmstr/%5Bsplashr&#34;&gt;&lt;code&gt;splashr&lt;/code&gt;&lt;/a&gt; uses:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/bhaskarvk/docker&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the R package),
&lt;ul&gt;
&lt;li&gt;which uses &lt;a href=&#34;https://docker-py.readthedocs.io/en/stable/&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the python lib installed in a virtualenv named &lt;code&gt;docker&lt;/code&gt;),
&lt;ul&gt;
&lt;li&gt;which uses &lt;a href=&#34;https://www.docker.com/&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the container engine).&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So proceed in steps:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Install &lt;a href=&#34;https://www.docker.com/&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the engine)&lt;/li&gt;
&lt;li&gt;Install &lt;a href=&#34;https://docker-py.readthedocs.io/en/stable/&#34;&gt;&lt;code&gt;docker&lt;/code&gt;&lt;/a&gt; (the python lib) in a virtualenv like explained &lt;a href=&#34;https://github.com/bhaskarvk/docker&#34;&gt;here&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Install the R packages&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;devtools::install_github(&amp;quot;bhaskarvk/docker&amp;quot;)
devtools::install_github(&amp;quot;hrbrmstr/splashr&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;ol start=&#34;4&#34; style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Let RStudio know that you want python commands to be run in this virtualenv&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Use the path where you installed the docker venv
library(reticulate)
use_virtualenv(&amp;quot;~/.virtualenv/docker&amp;quot;, required=T)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The very first time we run &lt;code&gt;splashr&lt;/code&gt;, it might be a bit slow: it will have to download the docker image (the template used to create container) that has &lt;code&gt;Splash&lt;/code&gt; installed in it. The image is documented &lt;a href=&#34;https://hub.docker.com/r/hrbrmstr/splashttpd/&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(splashr))
install_splash()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Pulling from scrapinghub/splash&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Digest: sha256:08c9b401fb812c9bf6591773c88c73b0c535336b97dd1ac04f9dbb988b2a7f76&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Status: Image is up to date for scrapinghub/splash:3.0&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can then use &lt;code&gt;splashr&lt;/code&gt; to create a &lt;code&gt;splash&lt;/code&gt; container and get the &lt;code&gt;html&lt;/code&gt;, this time with javascript generated content in it. The &lt;code&gt;xml2&lt;/code&gt; functions can still be used on the html returned by &lt;code&gt;splashr&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I added a wait time of two seconds between &lt;code&gt;start_splash&lt;/code&gt; and &lt;code&gt;render_html&lt;/code&gt; because I kept getting errors looking like &lt;code&gt;render_html&lt;/code&gt; was called before the container was fully operational.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;splash_container &amp;lt;- splashr::start_splash()
Sys.sleep(2)
listing_html_js &amp;lt;- splashr::render_html(url = listing_url)

count &amp;lt;- listing_html_js %&amp;gt;%
  html_node(&amp;quot;#count-search&amp;quot;) %&amp;gt;%
  html_text()
print(paste(&amp;quot;count value is:&amp;quot;, count))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;count value is: (21 results)&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The number is extracted with a little regular expression and the &lt;code&gt;stringr&lt;/code&gt; package:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;offer_number &amp;lt;- stringr::str_extract(count, &amp;quot;[0-9]+&amp;quot;) 
print(paste(&amp;quot;offer_number value is:&amp;quot;, offer_number))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;offer_number value is: 21&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Don’t forget to stop and delete your container.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;stop_splash(splash_container)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We now have the expected number of offers, which we can use to verify our final dataset (read &lt;a href=&#34;https://xvrdm.github.io/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/&#34;&gt;previous post&lt;/a&gt; to see how).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Create Swiss cantons cartogram with ggplot2</title>
      <link>/2017/05/08/create-swiss-cantons-cartogram-with-ggplot2/</link>
      <pubDate>Mon, 08 May 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/05/08/create-swiss-cantons-cartogram-with-ggplot2/</guid>
      <description>&lt;script src=&#34;../../rmarkdown-libs/htmlwidgets/htmlwidgets.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../../rmarkdown-libs/jquery/jquery.min.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../../rmarkdown-libs/datatables-binding/datatables.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../../rmarkdown-libs/dt-core/css/jquery.dataTables.min.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;link href=&#34;../../rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../../rmarkdown-libs/dt-core/js/jquery.dataTables.min.js&#34;&gt;&lt;/script&gt;


&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;While reading &lt;a href=&#34;www.rweekly.org&#34;&gt;rweekly&lt;/a&gt; past issues, I stumbbled upon a post from &lt;a href=&#34;http://maxhumber.com/2017/02/15/tile_canada.html&#34;&gt;Max Humber&lt;/a&gt;, explaining how he tried to design a tile grid map / state cartogram for Canada. I had never seen such design and thought that it would be a great fit for Swiss cantons. While browsing the excellent repositories of &lt;a href=&#34;https://github.com/hrbrmstr&#34;&gt;Bob Rudis&lt;/a&gt;, I realised that he had written &lt;a href=&#34;https://github.com/hrbrmstr/statebins&#34;&gt;statebin&lt;/a&gt;, a ggplot extension to easily create US state cartogram. This post is my attempt to convert his code to handle Swiss cantons.&lt;/p&gt;
&lt;p&gt;In hrbrmstr library, US states are on a 8x12 grid.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/1705081-cantonbins-scrsh-hrbrmstr-statesbin.png&#34; alt=&#34;US States mapped with statebins. Source: https://github.com/hrbrmstr/statebins&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;US States mapped with statebins. Source: &lt;a href=&#34;https://github.com/hrbrmstr/statebins&#34; class=&#34;uri&#34;&gt;https://github.com/hrbrmstr/statebins&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;These coordinates are saved with the full and abbreviated names in a dataframe. The &lt;code&gt;L&lt;/code&gt; suffix after the numbers is a &lt;a href=&#34;http://stackoverflow.com/questions/24350733/why-would-r-use-the-l-suffix-to-denote-an-integer&#34;&gt;way to specify integer&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Original code from hrbrmstr
# source: https://github.com/hrbrmstr/statebins/blob/master/R/statebins.R
state_coords &amp;lt;- structure(
  list(abbrev = c(&amp;quot;AL&amp;quot;, &amp;quot;AK&amp;quot;, &amp;quot;AZ&amp;quot;, &amp;quot;AR&amp;quot;, &amp;quot;CA&amp;quot;, &amp;quot;CO&amp;quot;,
                  &amp;quot;CT&amp;quot;, &amp;quot;DC&amp;quot;, &amp;quot;DE&amp;quot;, &amp;quot;FL&amp;quot;, &amp;quot;GA&amp;quot;, &amp;quot;HI&amp;quot;,
                  &amp;quot;ID&amp;quot;, &amp;quot;IL&amp;quot;, &amp;quot;IN&amp;quot;, &amp;quot;IA&amp;quot;, &amp;quot;KS&amp;quot;, &amp;quot;KY&amp;quot;, 
                  &amp;quot;LA&amp;quot;, &amp;quot;ME&amp;quot;, &amp;quot;MD&amp;quot;, &amp;quot;MA&amp;quot;, &amp;quot;MI&amp;quot;, &amp;quot;MN&amp;quot;,
                  &amp;quot;MS&amp;quot;, &amp;quot;MO&amp;quot;, &amp;quot;MT&amp;quot;, &amp;quot;NE&amp;quot;, &amp;quot;NV&amp;quot;, &amp;quot;NH&amp;quot;, 
                  &amp;quot;NJ&amp;quot;, &amp;quot;NM&amp;quot;, &amp;quot;NY&amp;quot;, &amp;quot;NC&amp;quot;, &amp;quot;ND&amp;quot;, &amp;quot;OH&amp;quot;, 
                  &amp;quot;OK&amp;quot;, &amp;quot;OR&amp;quot;, &amp;quot;PA&amp;quot;, &amp;quot;RI&amp;quot;, &amp;quot;SC&amp;quot;, &amp;quot;SD&amp;quot;, 
                  &amp;quot;TN&amp;quot;, &amp;quot;TX&amp;quot;, &amp;quot;UT&amp;quot;, &amp;quot;VT&amp;quot;, &amp;quot;VA&amp;quot;, &amp;quot;WA&amp;quot;, 
                  &amp;quot;WV&amp;quot;, &amp;quot;WI&amp;quot;, &amp;quot;WY&amp;quot;, &amp;quot;PR&amp;quot;),
       it = c(&amp;quot;Alabama&amp;quot;, &amp;quot;Alaska&amp;quot;, &amp;quot;Arizona&amp;quot;, &amp;quot;Arkansas&amp;quot;,
              &amp;quot;California&amp;quot;, &amp;quot;Colorado&amp;quot;, &amp;quot;Connecticut&amp;quot;, 
              &amp;quot;District of Columbia&amp;quot;, &amp;quot;Delaware&amp;quot;, &amp;quot;Florida&amp;quot;, 
              &amp;quot;Georgia&amp;quot;, &amp;quot;Hawaii&amp;quot;, &amp;quot;Idaho&amp;quot;, &amp;quot;Illinois&amp;quot;, 
              &amp;quot;Indiana&amp;quot;, &amp;quot;Iowa&amp;quot;, &amp;quot;Kansas&amp;quot;, &amp;quot;Kentucky&amp;quot;, 
              &amp;quot;Louisiana&amp;quot;, &amp;quot;Maine&amp;quot;, &amp;quot;Maryland&amp;quot;, 
              &amp;quot;Massachusetts&amp;quot;, &amp;quot;Michigan&amp;quot;, &amp;quot;Minnesota&amp;quot;, 
              &amp;quot;Mississippi&amp;quot;, &amp;quot;Missouri&amp;quot;, &amp;quot;Montana&amp;quot;, 
              &amp;quot;Nebraska&amp;quot;, &amp;quot;Nevada&amp;quot;, &amp;quot;New Hampshire&amp;quot;,
              &amp;quot;New Jersey&amp;quot;, &amp;quot;New Mexico&amp;quot;, &amp;quot;New York&amp;quot;,
              &amp;quot;North Carolina&amp;quot;, &amp;quot;North Dakota&amp;quot;, &amp;quot;Ohio&amp;quot;,
              &amp;quot;Oklahoma&amp;quot;, &amp;quot;Oregon&amp;quot;, &amp;quot;Pennsylvania&amp;quot;,
              &amp;quot;Rhode Island&amp;quot;, &amp;quot;South Carolina&amp;quot;,
              &amp;quot;South Dakota&amp;quot;, &amp;quot;Tennessee&amp;quot;, &amp;quot;Texas&amp;quot;, &amp;quot;Utah&amp;quot;,
              &amp;quot;Vermont&amp;quot;, &amp;quot;Virginia&amp;quot;, &amp;quot;Washington&amp;quot;,
              &amp;quot;West Virginia&amp;quot;, &amp;quot;Wisconsin&amp;quot;, &amp;quot;Wyoming&amp;quot;,
              &amp;quot;Puerto Rico&amp;quot;),
       col = c(8L, 1L, 3L, 6L, 2L, 4L, 11L, 10L, 11L, 10L,
               9L, 1L, 3L, 7L, 7L, 6L, 5L, 7L, 6L, 12L,
               10L, 11L, 8L, 6L, 7L, 6L, 4L, 5L, 3L, 12L,
               10L, 4L, 10L, 8L, 5L, 8L, 5L, 2L, 9L, 12L,
               9L, 5L, 7L, 5L, 3L, 11L, 9L, 2L, 8L, 7L, 4L, 12L),
       row = c(7L, 7L, 6L, 6L, 5L, 5L, 4L, 6L, 5L, 8L, 7L,
               8L, 3L, 3L, 4L, 4L, 6L, 5L, 7L, 1L, 5L, 3L,
               3L, 3L, 7L, 5L, 3L, 5L, 4L, 2L, 4L, 6L, 3L, 
               6L, 3L, 4L, 7L, 4L, 4L, 4L, 6L, 4L, 6L, 8L,
               5L, 2L, 5L, 3L, 5L, 2L, 4L, 8L)),
  .Names = c(&amp;quot;abbrev&amp;quot;, &amp;quot;state&amp;quot;, &amp;quot;col&amp;quot;, &amp;quot;row&amp;quot;),
  class = &amp;quot;data.frame&amp;quot;, 
  row.names = c(NA, -52L)
)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To sketch the mockup of your tile grid, excel can come to rescue.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/1705081-cantonbins-scrsh-excel.png&#34; alt=&#34;Mock up of Swiss tile grid&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Mock up of Swiss tile grid&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;This shows that cantons could be represented on a 5x9 grid.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/1705081-cantonbins-scrsh-excel-2.png&#34; alt=&#34;Columns/Rows reference for 5x9 grid&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Columns/Rows reference for 5x9 grid&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;By using the row/column reference of each canton, we can translate this mock up into an object mimicing hrbrmstr data structure (adding the names in each national languages).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;canton_coords &amp;lt;- structure(
  list(abbrev = c(&amp;quot;AG&amp;quot;, &amp;quot;AI&amp;quot;, &amp;quot;AR&amp;quot;, &amp;quot;BE&amp;quot;, &amp;quot;BL&amp;quot;, &amp;quot;BS&amp;quot;, &amp;quot;FR&amp;quot;,
                  &amp;quot;GE&amp;quot;, &amp;quot;GL&amp;quot;, &amp;quot;GR&amp;quot;, &amp;quot;JU&amp;quot;, &amp;quot;LU&amp;quot;, &amp;quot;NE&amp;quot;, &amp;quot;NW&amp;quot;,
                  &amp;quot;OW&amp;quot;, &amp;quot;SG&amp;quot;, &amp;quot;SH&amp;quot;, &amp;quot;SO&amp;quot;, &amp;quot;SZ&amp;quot;, &amp;quot;TG&amp;quot;, &amp;quot;TI&amp;quot;,
                  &amp;quot;UR&amp;quot;, &amp;quot;VD&amp;quot;, &amp;quot;VS&amp;quot;, &amp;quot;ZG&amp;quot;, &amp;quot;ZH&amp;quot;),
       fr_name = c(&amp;quot;Argovie&amp;quot;, &amp;quot;Appenzell Rhodes-Intérieures&amp;quot;,
                   &amp;quot;Appenzell Rhodes-Extérieures&amp;quot;, &amp;quot;Berne&amp;quot;,
                   &amp;quot;Bâle-Campagne&amp;quot;, &amp;quot;Bâle-Ville&amp;quot;, &amp;quot;Fribourg&amp;quot;,
                   &amp;quot;Genève&amp;quot;, &amp;quot;Glaris&amp;quot;, &amp;quot;Grisons&amp;quot;, &amp;quot;Jura&amp;quot;,
                   &amp;quot;Lucerne&amp;quot;, &amp;quot;Neuchâtel&amp;quot;, &amp;quot;Nidwald&amp;quot;, &amp;quot;Obwald&amp;quot;,
                   &amp;quot;Saint-Gall&amp;quot;, &amp;quot;Schaffhouse&amp;quot;, &amp;quot;Soleure&amp;quot;, &amp;quot;Schwytz&amp;quot;,
                   &amp;quot;Thurgovie&amp;quot;, &amp;quot;Tessin&amp;quot;, &amp;quot;Uri&amp;quot;, &amp;quot;Vaud&amp;quot;,
                   &amp;quot;Valais&amp;quot;, &amp;quot;Zoug&amp;quot;, &amp;quot;Zurich&amp;quot;),
       de_name = c(&amp;quot;Aargau&amp;quot;, &amp;quot;Appenzell Innerrhoden&amp;quot;,
                   &amp;quot;Appenzell Ausserrhoden&amp;quot;, &amp;quot;Bern&amp;quot;, 
                   &amp;quot;Basel-Landschaft&amp;quot;, &amp;quot;Basel-Stadt&amp;quot;,
                   &amp;quot;Freiburg&amp;quot;, &amp;quot;Genf&amp;quot;, &amp;quot;Glarus&amp;quot;,
                   &amp;quot;Graubünden&amp;quot;, &amp;quot;Jura&amp;quot;, &amp;quot;Luzern&amp;quot;,
                   &amp;quot;Neuenburg&amp;quot;, &amp;quot;Nidwalden&amp;quot;, &amp;quot;Obwalden&amp;quot;,
                   &amp;quot;St. Gallen&amp;quot;, &amp;quot;Schaffhausen&amp;quot;, &amp;quot;Solothurn&amp;quot;,
                   &amp;quot;Schwyz&amp;quot;, &amp;quot;Thurgau&amp;quot;, &amp;quot;Tessin&amp;quot;, &amp;quot;Uri&amp;quot;,
                   &amp;quot;Waadt&amp;quot;, &amp;quot;Wallis&amp;quot;, &amp;quot;Zug&amp;quot;, &amp;quot;Zürich&amp;quot;),
       it_name = c(&amp;quot;Argovia&amp;quot;, &amp;quot;Appenzello Interno&amp;quot;,
                   &amp;quot;Appenzello Esterno&amp;quot;, &amp;quot;Berna&amp;quot;,
                   &amp;quot;Basilea Campagna&amp;quot;, &amp;quot;Basilea Città&amp;quot;,
                   &amp;quot;Friburgo&amp;quot;, &amp;quot;Ginevra&amp;quot;, &amp;quot;Glarona&amp;quot;,
                   &amp;quot;Grigioni&amp;quot;, &amp;quot;Giura&amp;quot;, &amp;quot;Lucerna&amp;quot;, &amp;quot;Neuchâtel&amp;quot;,
                   &amp;quot;Nidvaldo&amp;quot;, &amp;quot;Obvaldo&amp;quot;, &amp;quot;San Gallo&amp;quot;,
                   &amp;quot;Sciaffusa&amp;quot;, &amp;quot;Soletta&amp;quot;, &amp;quot;Svitto&amp;quot;, &amp;quot;Turgovia&amp;quot;,
                   &amp;quot;Ticino&amp;quot;, &amp;quot;Uri&amp;quot;, &amp;quot;Vaud&amp;quot;, &amp;quot;Vallese&amp;quot;,
                   &amp;quot;Zugo&amp;quot;, &amp;quot;Zurigo&amp;quot;), 
       ru_name = c(&amp;quot;Argovia&amp;quot;, &amp;quot;Appenzell Dadens&amp;quot;,
                   &amp;quot;Appenzell Dadora&amp;quot;, &amp;quot;Berna&amp;quot;,
                   &amp;quot;Basilea-Champagna&amp;quot;, &amp;quot;Basilea-Citad&amp;quot;,
                   &amp;quot;Friburg&amp;quot;, &amp;quot;Genevra&amp;quot;, &amp;quot;Glaruna&amp;quot;,
                   &amp;quot;Grischun&amp;quot;, &amp;quot;Giura&amp;quot;, &amp;quot;Lucerna&amp;quot;, &amp;quot;Neuchâtel&amp;quot;,
                   &amp;quot;Sutsilvania&amp;quot;, &amp;quot;Sursilvania&amp;quot;, &amp;quot;Son Gagl&amp;quot;,
                   &amp;quot;Schaffusa&amp;quot;, &amp;quot;Soloturn&amp;quot;, &amp;quot;Sviz&amp;quot;, &amp;quot;Turgovia&amp;quot;,
                   &amp;quot;Tessin&amp;quot;, &amp;quot;Uri&amp;quot;, &amp;quot;Vad&amp;quot;, &amp;quot;Vallais&amp;quot;,
                   &amp;quot;Zug&amp;quot;, &amp;quot;Turitg&amp;quot;),
       col = c(5L,8L,8L,4L,4L,4L,3L,1L,8L,9L,3L,5L,3L,
               6L,5L,7L,6L,4L,7L,7L,7L,7L,2L,4L,6L,6L),
       row = c(2L,3L,2L,4L,2L,1L,4L,5L,4L,4L,2L,3L,3L,
               4L,4L,2L,1L,3L,3L,1L,5L,4L,4L,5L,3L,2L)),
  .Names = c(&amp;quot;abbrev&amp;quot;, &amp;quot;fr_name&amp;quot;, &amp;quot;de_name&amp;quot;,
             &amp;quot;it_name&amp;quot;, &amp;quot;ru_name&amp;quot;, &amp;quot;col&amp;quot;, &amp;quot;row&amp;quot;),
  class = &amp;quot;data.frame&amp;quot;,
  row.names = c(NA, -26L)
)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Using the same data structure as the one designed for &lt;a href=&#34;https://github.com/hrbrmstr/statebins&#34;&gt;statebin&lt;/a&gt;, it is easy to reuse the same ggplot code and only apply slight modifications (like a theme from the same &lt;a href=&#34;https://github.com/hrbrmstr/hrbrthemes&#34;&gt;hrbrmstr&lt;/a&gt;).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(ggplot2))
suppressMessages(library(RColorBrewer))
suppressMessages(library(hrbrthemes))

cantonbins &amp;lt;- function(canton_data, canton_col=&amp;quot;abbrev&amp;quot;, value_col=&amp;quot;value&amp;quot;,
                     text_color=&amp;quot;black&amp;quot;, font_size=3,
                     canton_border_col=&amp;quot;white&amp;quot;, labels=1:5,
                     brewer_pal=&amp;quot;PuBu&amp;quot;, plot_title=&amp;quot;&amp;quot;,
                     plot_subtitle=&amp;quot;&amp;quot;, plot_caption=&amp;quot;&amp;quot;) {

  # Reformat canton_data into a data frame without factors
  # and merge with canton_coords on abbrev key
  canton_data &amp;lt;- data.frame(canton_data, stringsAsFactors=FALSE)
  merge.x &amp;lt;- &amp;quot;abbrev&amp;quot;
  ct.dat &amp;lt;- merge(canton_coords, canton_data,
                  by.x=merge.x, by.y=canton_col, all.y=TRUE)

  # Create tile plot
  gg &amp;lt;- ggplot(ct.dat, aes_string(x=&amp;quot;col&amp;quot;, y=&amp;quot;row&amp;quot;, label=&amp;quot;abbrev&amp;quot;))
  gg &amp;lt;- gg + geom_tile(aes_string(fill=value_col))
  gg &amp;lt;- gg + geom_tile(color=canton_border_col, aes_string(fill=value_col),
                       size=2, show.legend =FALSE)
  gg &amp;lt;- gg + geom_text(color=text_color, size=font_size)
  
  # Add title
  gg &amp;lt;- gg + labs(title=plot_title, subtitle=plot_subtitle,
                  caption=plot_caption)
  
  # Set scales and coordinates system
  gg &amp;lt;- gg + scale_y_reverse()
  gg &amp;lt;- gg + scale_fill_gradientn(colours = brewer.pal(6, brewer_pal))
  gg &amp;lt;- gg + coord_equal()
  
  # Set minimal theme and remove axis titles, border, grid, 
  # background, axis ticks and axis text
  gg &amp;lt;- gg + theme_ipsum_rc()
  gg &amp;lt;- gg + labs(x=NULL, y=NULL)
  gg &amp;lt;- gg + theme(panel.border=element_blank())
  gg &amp;lt;- gg + theme(panel.grid=element_blank())
  gg &amp;lt;- gg + theme(panel.background=element_blank())
  gg &amp;lt;- gg + theme(axis.ticks=element_blank())
  gg &amp;lt;- gg + theme(axis.text=element_blank())

  return(gg)
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To test the function, let’s scrape a table from wikipedia containing the population per cantons. By inspecting the wikipedia code, you can see that the table has the &lt;code&gt;class&lt;/code&gt;: &lt;code&gt;wikitable&lt;/code&gt;. It can be extracted (with the help of &lt;code&gt;rvest&lt;/code&gt;) and converted into a usable dataframe (using &lt;code&gt;dplyr&lt;/code&gt;). The only modification are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;renaming the &lt;code&gt;Population[Note 2]&lt;/code&gt; column to something simpler&lt;/li&gt;
&lt;li&gt;converting the numbers stored as strings to numeric after removing their thousands “,”&lt;/li&gt;
&lt;li&gt;remove the total row for Switzerland (&lt;code&gt;Code != &amp;quot;CH&amp;quot;&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;selecting the columns of interest&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(rvest))
suppressMessages(library(dplyr))
suppressMessages(library(stringr))
suppressMessages(library(DT))

url &amp;lt;- &amp;quot;https://en.wikipedia.org/wiki/Cantons_of_Switzerland&amp;quot;
density &amp;lt;- url %&amp;gt;%
  read_html() %&amp;gt;%
  html_node(xpath=&amp;#39;//table[contains(@class,&amp;quot;wikitable&amp;quot;)]&amp;#39;) %&amp;gt;%
  html_table() %&amp;gt;%
  rename(Population=`Population[Note 2]`) %&amp;gt;%
  # Remove comma and notes reference (digit between brackets)
  mutate(Population=as.numeric(
    stringr::str_replace_all(
      Population, &amp;quot;(,|(\\[[:digit:]*\\]))&amp;quot;, &amp;quot;&amp;quot;))) %&amp;gt;%
  filter(Code != &amp;quot;CH&amp;quot;) %&amp;gt;%
  select(Code, Canton, Population)

DT::datatable(
  density,
  options = list(pageLength = 5, dom = &amp;#39;tpi&amp;#39;),
  rownames = FALSE,
  caption = &amp;quot;Table 1 : Subset of wikipedia data for cantons.&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;htmlwidget-1&#34; style=&#34;width:100%;height:auto;&#34; class=&#34;datatables html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-1&#34;&gt;{&#34;x&#34;:{&#34;filter&#34;:&#34;none&#34;,&#34;caption&#34;:&#34;&lt;caption&gt;Table 1 : Subset of wikipedia data for cantons.&lt;\/caption&gt;&#34;,&#34;data&#34;:[[&#34;ZH&#34;,&#34;BE&#34;,&#34;LU&#34;,&#34;UR&#34;,&#34;SZ&#34;,&#34;OW&#34;,&#34;NW&#34;,&#34;GL&#34;,&#34;ZG&#34;,&#34;FR&#34;,&#34;SO&#34;,&#34;BS&#34;,&#34;BL&#34;,&#34;SH&#34;,&#34;AR&#34;,&#34;AI&#34;,&#34;SG&#34;,&#34;GR&#34;,&#34;AG&#34;,&#34;TG&#34;,&#34;TI&#34;,&#34;VD&#34;,&#34;VS&#34;,&#34;NE&#34;,&#34;GE&#34;,&#34;JU&#34;],[&#34;Zürich&#34;,&#34;Bern&#34;,&#34;Luzern&#34;,&#34;Uri&#34;,&#34;Schwyz&#34;,&#34;Obwalden&#34;,&#34;Nidwalden&#34;,&#34;Glarus&#34;,&#34;Zug&#34;,&#34;Fribourg&#34;,&#34;Solothurn&#34;,&#34;Basel-Stadt&#34;,&#34;Basel-Landschaft&#34;,&#34;Schaffhausen&#34;,&#34;Appenzell Ausserrhoden&#34;,&#34;Appenzell Innerrhoden&#34;,&#34;St. Gallen&#34;,&#34;Graubünden&#34;,&#34;Aargau&#34;,&#34;Thurgau&#34;,&#34;Ticino&#34;,&#34;Vaud&#34;,&#34;Valais&#34;,&#34;Neuchâtel&#34;,&#34;Geneva&#34;,&#34;Jura&#34;],[1487969,1026513,403397,36145,155863,37378,42556,40147,123948,311914,269441,198249,286848,80769,54954,16003,502552,197550,663462,270709,354375,784822,339176,178567,489524,73122]],&#34;container&#34;:&#34;&lt;table class=\&#34;display\&#34;&gt;\n  &lt;thead&gt;\n    &lt;tr&gt;\n      &lt;th&gt;Code&lt;\/th&gt;\n      &lt;th&gt;Canton&lt;\/th&gt;\n      &lt;th&gt;Population&lt;\/th&gt;\n    &lt;\/tr&gt;\n  &lt;\/thead&gt;\n&lt;\/table&gt;&#34;,&#34;options&#34;:{&#34;pageLength&#34;:5,&#34;dom&#34;:&#34;tpi&#34;,&#34;columnDefs&#34;:[{&#34;className&#34;:&#34;dt-right&#34;,&#34;targets&#34;:2}],&#34;order&#34;:[],&#34;autoWidth&#34;:false,&#34;orderClasses&#34;:false,&#34;lengthMenu&#34;:[5,10,25,50,100]}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;
&lt;p&gt;We can now try the &lt;code&gt;cantonbins&lt;/code&gt; function.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;cantonbins(density, canton_col=&amp;quot;Code&amp;quot;, value_col=&amp;quot;Population&amp;quot;,
           plot_title=&amp;quot;Population size in Swiss Cantons&amp;quot;,
           plot_subtitle = paste0(&amp;quot;Source: &amp;quot;, url))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/1705081-cantonbins_files/figure-html/unnamed-chunk-5-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;There is a lot more we can do with Cartograms and, in a future post, I hope to release a full fork of &lt;a href=&#34;https://github.com/hrbrmstr/statebins&#34;&gt;statebin&lt;/a&gt; so that you can easily install it from Github.&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Scrape linked webpages using rvest and purrr</title>
      <link>/2017/04/16/scrape-linked-webpages-using-rvest-and-purrr/</link>
      <pubDate>Sun, 16 Apr 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/04/16/scrape-linked-webpages-using-rvest-and-purrr/</guid>
      <description>&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The offers on real estate websites aren’t always in an easy-to-use format, especially if you want to compare offers from multiple agencies.&lt;/p&gt;
&lt;p&gt;In a &lt;a href=&#34;https://xvrdm.github.io/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/&#34;&gt;previous post&lt;/a&gt;, we saw how to scrape a listing of apartments on a single page with R. However, listings usually do not include all the details about the items. They usually only list a condensed version of the information and a url to a “detail” page, which contains the rest of the fields. For example, we could not add any insight about “Floors” to our dataset as “Floor” is only detailled on each apartement details page. In this post, we will see how to:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;find the URL for each apartment&lt;/li&gt;
&lt;li&gt;scrape details found on each details page&lt;/li&gt;
&lt;li&gt;combine these details into a single dataframe&lt;/li&gt;
&lt;li&gt;merge this detail dataframe with our original dataframe&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div id=&#34;scraping-the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Scraping the data&lt;/h2&gt;
&lt;div id=&#34;getting-the-urls-for-each-apartment&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Getting the URLs for each apartment&lt;/h3&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Load needed packages
suppressMessages(library(xml2))
suppressMessages(library(rvest))&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Create an html document
listing_url &amp;lt;- &amp;quot;https://www.moservernet.ch/en/apartments-for-rent/&amp;quot;
listing_html &amp;lt;- xml2::read_html(listing_url)

# Find all the nodes with class &amp;quot;offer&amp;quot; in id &amp;quot;offers&amp;quot;
offers &amp;lt;- listing_html %&amp;gt;%
  html_nodes(&amp;quot;#offers .offer&amp;quot;)

# Extract the first target url of each first link in each node
offers_urls &amp;lt;- offers %&amp;gt;%
  html_node(&amp;quot;a&amp;quot;) %&amp;gt;%
  html_attr(&amp;quot;href&amp;quot;)

head(offers_urls)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;/en/apartments-for-rent/cornavin-1-5-rooms--0570.42.0030&amp;quot;       
## [2] &amp;quot;/en/apartments-for-rent/grand-pre-1-5-rooms--7259.40.0010&amp;quot;      
## [3] &amp;quot;/en/apartments-for-rent/chene-bougeries-1-5-rooms--2652.41.0010&amp;quot;
## [4] &amp;quot;/en/apartments-for-rent/paquis-2-rooms--0630.40.0010&amp;quot;           
## [5] &amp;quot;/en/apartments-for-rent/servette-2-5-rooms--2078.31.0010&amp;quot;       
## [6] &amp;quot;/en/apartments-for-rent/grand-saconnex-3-rooms--2018.44.0040&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;using-one-example-to-map-our-scraping&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Using one example to map our scraping&lt;/h3&gt;
&lt;p&gt;Using the first link as an example, we can explore how the data should be scraped.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;offer_url &amp;lt;- offers_urls[1]
offer_url&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;/en/apartments-for-rent/cornavin-1-5-rooms--0570.42.0030&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The id of each offer is actually available directly in the URL.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;id &amp;lt;- offer_url %&amp;gt;%
  sub(&amp;quot;.*([0-9]{4}\\.[0-9]{2}\\.[0-9]{4}).*&amp;quot;,
      &amp;quot;\\1&amp;quot;, .)
id&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;0570.42.0030&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next we need to scrape the data contained at this URL. As links are relative, we start by rebuilding the full link, which we use with &lt;code&gt;xml2::read_html()&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Create full URL for offer
BASE_URL &amp;lt;- &amp;quot;https://www.moservernet.ch&amp;quot;
offer_full_url &amp;lt;- paste0(BASE_URL, offer_url)

# Scrape HTML for offer
offer_html &amp;lt;- xml2::read_html(offer_full_url)&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/1704161-scrsh-msrvrn-apartment-source.png&#34; alt=&#34;Screenshot of source code for apartment detail webpage&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Screenshot of source code for apartment detail webpage&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Looking at the source code, we can see that the attributes we are after (“Floor” and “Surface area”) are located in the same node: a &lt;code&gt;h2&lt;/code&gt; tag contained in a &lt;code&gt;td&lt;/code&gt; tag with &lt;code&gt;itemprop=itemOffered&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;offer_attr &amp;lt;- offer_html %&amp;gt;%
  html_node(&amp;quot;[itemprop=itemOffered]&amp;quot;) %&amp;gt;%
  html_text() %&amp;gt;%
  stringr::str_trim() %&amp;gt;%
  stringr::str_split(&amp;quot; - &amp;quot;, simplify = T) %&amp;gt;%
  as.vector()
offer_attr&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;1.5 rooms&amp;quot; &amp;quot;36m²&amp;quot;      &amp;quot;Floor 2&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;With a bit more parsing, we can get clean numbers.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Find floor data by finding the vector element
# containing text &amp;quot;Floor&amp;quot; and isolating the
# number next to it.
floor &amp;lt;- grep(&amp;quot;Floor&amp;quot;, offer_attr, value = T) %&amp;gt;%
  stringr::str_replace(&amp;quot;Floor&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_trim()
floor&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;2&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Find surface area data by finding the vector 
# element containing text &amp;quot;m²&amp;quot; and isolating the
# number next to it.
surface &amp;lt;- grep(&amp;quot;m²&amp;quot;, offer_attr, value = T) %&amp;gt;%
  stringr::str_replace(&amp;quot;m²&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_trim()
surface&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;36&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;However, if we look closely at the list of urls, there seem to be two types of URLs.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;table(sub(&amp;quot;(/.*/.*/).*&amp;quot;,&amp;quot;\\1&amp;quot;,offers_urls)) %&amp;gt;%
  tibble::as_tibble() %&amp;gt;%
  setNames(c(&amp;quot;URL start with:&amp;quot;,&amp;quot;n&amp;quot;)) &lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 2 x 2
##                    `URL start with:`     n
##                                &amp;lt;chr&amp;gt; &amp;lt;int&amp;gt;
## 1           /en/apartments-for-rent/    15
## 2 /en/residential-property-for-rent/     7&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Most URLs follow the pattern &lt;code&gt;/en/apartments-for-rent/&amp;lt;address&amp;gt;--&amp;lt;id&amp;gt;&lt;/code&gt; but a few look like &lt;code&gt;/en/residential-property-for-rent/&amp;lt;address&amp;gt;--&amp;lt;id&amp;gt;&lt;/code&gt;. If we open one, we can see that the page layout is different.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/1704161-scrsh-msrvrn-property-source.png&#34; alt=&#34;Screenshot of source code for residential detail webpage&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Screenshot of source code for residential detail webpage&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;The surface area is still available in a node with &lt;code&gt;[itemprop=itemOffered]&lt;/code&gt;, but the floor is in another node, which seem to be the first node with class &lt;code&gt;price&lt;/code&gt;. With a bit of rewriting on the floor code, we can adapt to the 2 different layouts:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# The code below can find the floor on both layout types,
# which are identified by a pattern in their url.
floor &amp;lt;- ifelse(
    grepl(&amp;quot;apartments&amp;quot;, offer_url),
    grep(&amp;quot;Floor&amp;quot;, offer_attr, value = T),
    offer_html %&amp;gt;% 
      html_node(&amp;quot;.price&amp;quot;) %&amp;gt;%
      html_text()) %&amp;gt;%
  stringr::str_replace(&amp;quot;Floor[:]{0,1}&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_trim() %&amp;gt;%
  as.numeric()&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;scraping-all-links-with-reusable-code&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Scraping all links with reusable code&lt;/h3&gt;
&lt;p&gt;We can now put all our code together in a function and use it on each link. Note that the &lt;code&gt;slow_scrape_extra_info&lt;/code&gt; wrapper just make sure we wait for a little while between each request.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;scrape_extra_info &amp;lt;- function(offer_url) {
  BASE_URL &amp;lt;- &amp;quot;https://www.moservernet.ch&amp;quot;
  offer_full_url &amp;lt;- paste0(BASE_URL, offer_url)
  offer_html &amp;lt;- xml2::read_html(offer_full_url)
  
  offer_attr &amp;lt;- offer_html %&amp;gt;%
    html_node(&amp;quot;[itemprop=itemOffered]&amp;quot;) %&amp;gt;%
    html_text() %&amp;gt;%
    stringr::str_trim() %&amp;gt;%
    stringr::str_split(&amp;quot; - &amp;quot;, simplify = T) %&amp;gt;%
    as.vector()

  list(
    id = offer_url %&amp;gt;%
      sub(&amp;quot;.*([0-9]{4}\\.[0-9]{2}\\.[0-9]{4}).*&amp;quot;,
        &amp;quot;\\1&amp;quot;, .),
    
     floor = ifelse(
         grepl(&amp;quot;apartments&amp;quot;, offer_url),
         grep(&amp;quot;Floor&amp;quot;, offer_attr, value = T),
         offer_html %&amp;gt;% 
           html_node(&amp;quot;.price&amp;quot;) %&amp;gt;%
           html_text()) %&amp;gt;%
       stringr::str_replace(&amp;quot;Floor[:]{0,1}&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
       stringr::str_trim() %&amp;gt;%
       as.numeric(),
  
     surface = grep(&amp;quot;m²&amp;quot;, offer_attr, value = T) %&amp;gt;%
       stringr::str_replace(&amp;quot;m²&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
       stringr::str_trim() %&amp;gt;%
       as.numeric()
  )
}

slow_scrape_extra_info &amp;lt;- function(offer_url) {
  Sys.sleep(sample(1:15/10,1))
  scrape_extra_info(offer_url)
}

# Apply the function to each url that contains an offer id
# and store the results into a single dataframe
extra_info &amp;lt;- grep(&amp;quot;.*([0-9]{4}\\.[0-9]{2}\\.[0-9]{4}).*&amp;quot;,
                   offers_urls, value = T) %&amp;gt;%
  purrr::map(slow_scrape_extra_info) %&amp;gt;%
  dplyr::bind_rows() %&amp;gt;%
  na.omit()

knitr::kable(head(extra_info))&lt;/code&gt;&lt;/pre&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;left&#34;&gt;id&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;floor&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;surface&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2454.44.0030&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;4&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;24&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2040.41.0020&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;44&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2066.41.0010&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;48&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;0510.45.0030&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;5&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;55&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2457.41.0020&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;50&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;2018.48.0020&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;8&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;58&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Thanks to the common &lt;code&gt;id&lt;/code&gt; field, we can &lt;a href=&#34;http://dplyr.tidyverse.org/reference/join.html&#34;&gt;join&lt;/a&gt; this dataframe with the one obtained in the &lt;a href=&#34;https://xvrdm.github.io/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/&#34;&gt;previous post&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Scrape a list of rental offers using rvest and purrr</title>
      <link>/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/</link>
      <pubDate>Fri, 31 Mar 2017 00:00:00 +0000</pubDate>
      
      <guid>/2017/03/31/scrape-a-list-of-rental-offers-using-rvest-and-purrr/</guid>
      <description>&lt;script src=&#34;../../rmarkdown-libs/htmlwidgets/htmlwidgets.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../../rmarkdown-libs/jquery/jquery.min.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../../rmarkdown-libs/datatables-binding/datatables.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../../rmarkdown-libs/dt-core/css/jquery.dataTables.min.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;link href=&#34;../../rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../../rmarkdown-libs/dt-core/js/jquery.dataTables.min.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../../rmarkdown-libs/leaflet/leaflet.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../../rmarkdown-libs/leaflet/leaflet.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../../rmarkdown-libs/leafletfix/leafletfix.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;link href=&#34;../../rmarkdown-libs/leaflet-label/leaflet.label.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../../rmarkdown-libs/leaflet-label/leaflet.label.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../../rmarkdown-libs/Proj4Leaflet/proj4-compressed.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../../rmarkdown-libs/Proj4Leaflet/proj4leaflet.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../../rmarkdown-libs/leaflet-binding/leaflet.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../../rmarkdown-libs/leaflet-providers/leaflet-providers.js&#34;&gt;&lt;/script&gt;
&lt;script src=&#34;../../rmarkdown-libs/leaflet-providers-plugin/leaflet-providers-plugin.js&#34;&gt;&lt;/script&gt;


&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The offers on real estate websites aren’t always in an easy-to-use format, especially if you want to compare offers from multiple agencies.&lt;/p&gt;
&lt;p&gt;In this post, we will see how to use R to scrape the details about the apartments listed on a single page on a real estate website.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;scraping-the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Scraping the data&lt;/h2&gt;
&lt;div id=&#34;getting-to-know-the-site&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Getting to know the site&lt;/h3&gt;
&lt;p&gt;We start by looking at the real estate agent website. The section containing apartment rental offers can be found at this &lt;a href=&#34;https://www.moservernet.ch/en/apartments-for-rent/&#34;&gt;URL&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/1703311-scrsh-website-msrvrn.png&#34; alt=&#34;Apartment Rental section on website&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Apartment Rental section on website&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Each flat seem to be displayed in its own little box, which should derive from code not to hard to parse. But it would be even easier if the data was grabed from some kind of API.&lt;/p&gt;
&lt;p&gt;Looking at the network tab of the inspector, it doesn’t look like we can easily identify an API.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/1703311-scrsh-network-msrvrn.png&#34; alt=&#34;Network tab from inspector tool on Apartment Rental section website&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;Network tab from inspector tool on Apartment Rental section website&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;We will need to fall back on scraping.&lt;/p&gt;
&lt;p&gt;Looking at the page source, we can see that all the information seem to be present so we won’t need to rely on a headless browser to execute Javascript. The data seems neatly organised.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../img/1703311-scrsh-source-msrvrn.png&#34; alt=&#34;Source code from Apartment Rental section on website&#34; /&gt; On the screenshot above, we can see that all the apartments are in a &lt;code&gt;div&lt;/code&gt; with the &lt;code&gt;id=offers&lt;/code&gt; (blue rectangle). Then each apartment is contained in its own &lt;code&gt;div&lt;/code&gt; with the &lt;code&gt;class=offer&lt;/code&gt; (red rectangles). We can also see that the different attributes of each flat are in separated &lt;code&gt;div&lt;/code&gt; or &lt;code&gt;h&lt;/code&gt; tags, usually with meaningful &lt;code&gt;class&lt;/code&gt; like &lt;code&gt;price-offer&lt;/code&gt;, &lt;code&gt;charge-offer&lt;/code&gt;, &lt;code&gt;size-offer&lt;/code&gt;… Very conveniently, and probably because they have a google map applet, the latitude and longitude are already available with the classes &lt;code&gt;info-obj-address-lat&lt;/code&gt; and &lt;code&gt;info-obj-address-lng&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;getting-the-page-source-into-r&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Getting the page source into R&lt;/h3&gt;
&lt;p&gt;Using the &lt;code&gt;rvest&lt;/code&gt; library, we can grab the code of the site.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Load needed packages
suppressMessages(library(dplyr))
suppressMessages(library(xml2))
suppressMessages(library(rvest))&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Create an html document
listing_url &amp;lt;- &amp;quot;https://www.moservernet.ch/en/apartments-for-rent/&amp;quot;
listing_html &amp;lt;- xml2::read_html(listing_url)
listing_html&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## {xml_document}
## &amp;lt;html&amp;gt;
## [1] &amp;lt;head&amp;gt;\n&amp;lt;meta http-equiv=&amp;quot;Content-Type&amp;quot; content=&amp;quot;text/html;charset=u ...
## [2] &amp;lt;body&amp;gt;\n\t\t&amp;lt;div id=&amp;quot;main&amp;quot;&amp;gt;\t\n\t\t\t&amp;lt;div class=&amp;quot;container&amp;quot; style=&amp;quot;h ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;isolate-the-html-for-the-offers&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Isolate the html for the offers&lt;/h3&gt;
&lt;p&gt;Then we isolate the nodes with &lt;code&gt;class=offer&lt;/code&gt; contained in the &lt;code&gt;div&lt;/code&gt; with &lt;code&gt;id=offers&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;listing_offers &amp;lt;- listing_html %&amp;gt;%
  rvest::html_nodes(&amp;quot;#offers .offer&amp;quot;)
head(listing_offers)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## {xml_nodeset (6)}
## [1] &amp;lt;div class=&amp;quot;offer cat1 cat2 2&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-f ...
## [2] &amp;lt;div class=&amp;quot;offer cat1 cat2 2&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-f ...
## [3] &amp;lt;div class=&amp;quot;offer cat1 cat2 1&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-f ...
## [4] &amp;lt;div class=&amp;quot;offer cat2 2&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-for-re ...
## [5] &amp;lt;div class=&amp;quot;offer cat2 cat3 2&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-f ...
## [6] &amp;lt;div class=&amp;quot;offer cat3 3&amp;quot;&amp;gt;\n\t\t\t\t\t&amp;lt;a href=&amp;quot;/en/apartments-for-re ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;parsing-the-offers&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Parsing the offers&lt;/h3&gt;
&lt;p&gt;Now that we have a list of offers, we need to find a way to extract the data of interest from each offer and store it in a usable format. There are at least two way to proceed: a “field centric” way and an “offer centric” way.&lt;/p&gt;
&lt;div id=&#34;parsing-with-the-field-centric-way&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Parsing with the “field centric” way&lt;/h4&gt;
&lt;p&gt;In the “field centric” way, we grab one field of interest (&lt;code&gt;rent&lt;/code&gt;, &lt;code&gt;rooms&lt;/code&gt;, &lt;code&gt;address&lt;/code&gt;…) at a time for all the offers. We end up with vectors containing the value of the field for each offer. These vector can then be combined into a dataframe. The “field centric” way is described in the lego movie example on &lt;a href=&#34;http://web.archive.org/web/20160113072819/https://github.com/hadley/rvest&#34;&gt;&lt;code&gt;rvest&lt;/code&gt;’s github repo&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;id&lt;/code&gt; and &lt;code&gt;address&lt;/code&gt; can be stored as text and only need a bit of cleanup.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;id &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.ref&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  stringr::str_replace(&amp;quot;Ref. &amp;quot;,&amp;quot;&amp;quot;)

address &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.location-offer&amp;quot;) %&amp;gt;%
  rvest::html_text()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;rooms&lt;/code&gt;, &lt;code&gt;latitude&lt;/code&gt;, &lt;code&gt;longitude&lt;/code&gt;, &lt;code&gt;rent&lt;/code&gt; and &lt;code&gt;charges&lt;/code&gt; are better saved as numeric after removal of prefix/suffix like currencies. Note that &lt;code&gt;stringr&lt;/code&gt;’s &lt;code&gt;str_replace&lt;/code&gt; can search for regular expressions pattern, which let us do things like removing &lt;code&gt;room&lt;/code&gt; and &lt;code&gt;rooms&lt;/code&gt; in one call.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;rooms &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.ref-offer&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  stringr::str_replace(&amp;quot; room[s]*&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  as.numeric()

latitude &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.infos-objet-address-lat&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  as.numeric()

longitude &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.infos-objet-address-lng&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  as.numeric()

rent &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.price-offer&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  stringr::str_replace(&amp;quot;CHF &amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_replace_all(&amp;quot;[.]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_replace(&amp;quot;[-]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  as.numeric()

charges &amp;lt;- listing_offers %&amp;gt;%
  rvest::html_nodes(&amp;quot;.charge-offer&amp;quot;) %&amp;gt;%
  rvest::html_text() %&amp;gt;%
  stringr::str_replace(&amp;quot;Charges: CHF &amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_replace_all(&amp;quot;[.]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  stringr::str_replace(&amp;quot;[-]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
  as.numeric()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;All these vectors can then be combined in a dataframe, which is nicely displayed in an interactive datatable.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;offers &amp;lt;- data.frame(id, 
                     rooms, 
                     address, 
                     latitude, 
                     longitude, 
                     rent, 
                     charges)

library(DT)
DT::datatable(
  offers,
  options = list(pageLength = 5, dom = &amp;#39;tpi&amp;#39;),
  rownames = FALSE,
  caption = &amp;quot;Table 1 : Offers scraped using the field centric way&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;htmlwidget-1&#34; style=&#34;width:100%;height:auto;&#34; class=&#34;datatables html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-1&#34;&gt;{&#34;x&#34;:{&#34;filter&#34;:&#34;none&#34;,&#34;caption&#34;:&#34;&lt;caption&gt;Table 1 : Offers scraped using the field centric way&lt;\/caption&gt;&#34;,&#34;data&#34;:[[&#34;0570.42.0030&#34;,&#34;7259.40.0010&#34;,&#34;2652.41.0010&#34;,&#34;0630.40.0010&#34;,&#34;2078.31.0010&#34;,&#34;2018.44.0040&#34;,&#34;0675.42.0250&#34;,&#34;2040.41.0010&#34;,&#34;0110.43.0020&#34;,&#34;0575.44.0020&#34;,&#34;0159.43.0020&#34;,&#34;0198.46.0020&#34;,&#34;0158.46.0020&#34;,&#34;2341.45.0010&#34;,&#34;0022.40.0010&#34;,&#34;0082.44.0030&#34;,&#34;2233.39.9030&#34;,&#34;0615.45.0010&#34;,&#34;2027.46.0060&#34;,&#34;0082.44.0010&#34;,&#34;0082.43.0010&#34;],[1.5,1.5,1.5,2,2.5,3,3.5,3.5,6,4.5,4,5.5,5.5,4.5,4.5,3,6,6,6,6,9],[&#34;Rue de la Faucille 12&#34;,&#34;Rue du Vidollet 18&#34;,&#34;Rue de Chêne-Bougeries 40&#34;,&#34;42, rue de Zürich&#34;,&#34;Avenue De-Luserna 36&#34;,&#34;Chemin Taverney 6&#34;,&#34;Rue du Belvédère 8&#34;,&#34;Rue Henri-ChristinÃ© 6&#34;,&#34;Rue de GenÃ¨ve 123 A&#34;,&#34;Grand-Montfleury 30&#34;,&#34;Place de l&#39;Octroi 13&#34;,&#34;Rue de ChÃªne-Bougeries 29&#34;,&#34;Chemin des Palettes 29&#34;,&#34;Rue Cavour 9&#34;,&#34;Avenue Giuseppe-Motta 16&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Maurice-Braillard 16&#34;,&#34;Route de ChÃªne 53&#34;,&#34;Rue Charles-Giron 1&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Saint-LÃ©ger 8&#34;],[46.2110823,46.2172471,46.1956311,46.2123577,46.2139829,46.2299972,46.2049398,46.1945565,46.1929323,46.2936297,46.1874919,46.1964161,46.1754533,46.2068797,46.2167452,46.1976599,46.220471,46.2001689,46.2061894,46.1976599,46.1976599],[6.1399174,6.1377483,6.191422,6.1452134,6.1246849,6.1177381,6.1315508,6.1424891,6.2037003,6.1646624,6.1405418,6.190808,6.11947,6.1320354,6.1316818,6.1462625,6.1325586,6.1723494,6.1306914,6.1462625,6.1462625],[1150,1200,1300,1390,1400,1600,1990,1990,2200,2230,2350,2450,2700,2780,2950,2950,3900,4500,4900,10900,13900],[90,60,100,80,100,90,140,130,200,165,200,210,170,220,200,175,365,350,350,445,325]],&#34;container&#34;:&#34;&lt;table class=\&#34;display\&#34;&gt;\n  &lt;thead&gt;\n    &lt;tr&gt;\n      &lt;th&gt;id&lt;\/th&gt;\n      &lt;th&gt;rooms&lt;\/th&gt;\n      &lt;th&gt;address&lt;\/th&gt;\n      &lt;th&gt;latitude&lt;\/th&gt;\n      &lt;th&gt;longitude&lt;\/th&gt;\n      &lt;th&gt;rent&lt;\/th&gt;\n      &lt;th&gt;charges&lt;\/th&gt;\n    &lt;\/tr&gt;\n  &lt;\/thead&gt;\n&lt;\/table&gt;&#34;,&#34;options&#34;:{&#34;pageLength&#34;:5,&#34;dom&#34;:&#34;tpi&#34;,&#34;columnDefs&#34;:[{&#34;className&#34;:&#34;dt-right&#34;,&#34;targets&#34;:[1,3,4,5,6]}],&#34;order&#34;:[],&#34;autoWidth&#34;:false,&#34;orderClasses&#34;:false,&#34;lengthMenu&#34;:[5,10,25,50,100]}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;
&lt;/div&gt;
&lt;div id=&#34;parsing-with-the-offer-centric-way&#34; class=&#34;section level4&#34;&gt;
&lt;h4&gt;Parsing with the “offer centric” way&lt;/h4&gt;
&lt;p&gt;In the “offer centric” way, we parse one offer at a time, extract all the fields of interest and store it into a list. We end up with a list of lists, where each list contain all the fields for one offer.&lt;/p&gt;
&lt;p&gt;To parse each offer, we are going to create a function &lt;code&gt;parse_offer&lt;/code&gt; that works well on one offer and apply it to each offer with the help of the &lt;code&gt;purrr&lt;/code&gt; package.&lt;/p&gt;
&lt;p&gt;Note that we are searching only for one value, so we use &lt;code&gt;html_node&lt;/code&gt; and not &lt;code&gt;html_nodes&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;parse_offer &amp;lt;- function(offer) {
  list(
    id = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.ref&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      stringr::str_replace(&amp;quot;Ref. &amp;quot;,&amp;quot;&amp;quot;),
    
    address = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.location-offer&amp;quot;) %&amp;gt;%
      rvest::html_text(),
  
    room = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.ref-offer&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      stringr::str_replace(&amp;quot; room[s]*&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      as.numeric(),
    
    latitude = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.infos-objet-address-lat&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      as.numeric(),

    longitude = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.infos-objet-address-lng&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      as.numeric(),

    rent = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.price-offer&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      stringr::str_replace(&amp;quot;CHF &amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      stringr::str_replace_all(&amp;quot;[.]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      stringr::str_replace(&amp;quot;[-]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      as.numeric(),

    charges = offer %&amp;gt;%
      rvest::html_node(&amp;quot;.charge-offer&amp;quot;) %&amp;gt;%
      rvest::html_text() %&amp;gt;%
      stringr::str_replace(&amp;quot;Charges: CHF &amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      stringr::str_replace_all(&amp;quot;[.]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      stringr::str_replace(&amp;quot;[-]&amp;quot;,&amp;quot;&amp;quot;) %&amp;gt;%
      as.numeric()
  )
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;purrr::map&lt;/code&gt; will create a list of lists. Each list in the list of lists can be bound as a row in a dataframe, thanks to &lt;code&gt;dplyr::bind_rows()&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(purrr))

offers &amp;lt;- listing_offers %&amp;gt;%
  purrr::map(parse_offer) %&amp;gt;%
  dplyr::bind_rows() %&amp;gt;%
  na.omit()

DT::datatable(
  offers,
  options = list(pageLength = 5, dom = &amp;#39;tpi&amp;#39;),
  rownames = FALSE,
  caption = &amp;quot;Table 2 : Offers scraped using the offer centric way&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;htmlwidget-2&#34; style=&#34;width:100%;height:auto;&#34; class=&#34;datatables html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-2&#34;&gt;{&#34;x&#34;:{&#34;filter&#34;:&#34;none&#34;,&#34;caption&#34;:&#34;&lt;caption&gt;Table 2 : Offers scraped using the offer centric way&lt;\/caption&gt;&#34;,&#34;data&#34;:[[&#34;0570.42.0030&#34;,&#34;7259.40.0010&#34;,&#34;2652.41.0010&#34;,&#34;0630.40.0010&#34;,&#34;2078.31.0010&#34;,&#34;2018.44.0040&#34;,&#34;0675.42.0250&#34;,&#34;2040.41.0010&#34;,&#34;0110.43.0020&#34;,&#34;0575.44.0020&#34;,&#34;0159.43.0020&#34;,&#34;0198.46.0020&#34;,&#34;0158.46.0020&#34;,&#34;2341.45.0010&#34;,&#34;0022.40.0010&#34;,&#34;0082.44.0030&#34;,&#34;2233.39.9030&#34;,&#34;0615.45.0010&#34;,&#34;2027.46.0060&#34;,&#34;0082.44.0010&#34;,&#34;0082.43.0010&#34;],[&#34;Rue de la Faucille 12&#34;,&#34;Rue du Vidollet 18&#34;,&#34;Rue de Chêne-Bougeries 40&#34;,&#34;42, rue de Zürich&#34;,&#34;Avenue De-Luserna 36&#34;,&#34;Chemin Taverney 6&#34;,&#34;Rue du Belvédère 8&#34;,&#34;Rue Henri-ChristinÃ© 6&#34;,&#34;Rue de GenÃ¨ve 123 A&#34;,&#34;Grand-Montfleury 30&#34;,&#34;Place de l&#39;Octroi 13&#34;,&#34;Rue de ChÃªne-Bougeries 29&#34;,&#34;Chemin des Palettes 29&#34;,&#34;Rue Cavour 9&#34;,&#34;Avenue Giuseppe-Motta 16&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Maurice-Braillard 16&#34;,&#34;Route de ChÃªne 53&#34;,&#34;Rue Charles-Giron 1&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Saint-LÃ©ger 8&#34;],[1.5,1.5,1.5,2,2.5,3,3.5,3.5,6,4.5,4,5.5,5.5,4.5,4.5,3,6,6,6,6,9],[46.2110823,46.2172471,46.1956311,46.2123577,46.2139829,46.2299972,46.2049398,46.1945565,46.1929323,46.2936297,46.1874919,46.1964161,46.1754533,46.2068797,46.2167452,46.1976599,46.220471,46.2001689,46.2061894,46.1976599,46.1976599],[6.1399174,6.1377483,6.191422,6.1452134,6.1246849,6.1177381,6.1315508,6.1424891,6.2037003,6.1646624,6.1405418,6.190808,6.11947,6.1320354,6.1316818,6.1462625,6.1325586,6.1723494,6.1306914,6.1462625,6.1462625],[1150,1200,1300,1390,1400,1600,1990,1990,2200,2230,2350,2450,2700,2780,2950,2950,3900,4500,4900,10900,13900],[90,60,100,80,100,90,140,130,200,165,200,210,170,220,200,175,365,350,350,445,325]],&#34;container&#34;:&#34;&lt;table class=\&#34;display\&#34;&gt;\n  &lt;thead&gt;\n    &lt;tr&gt;\n      &lt;th&gt;id&lt;\/th&gt;\n      &lt;th&gt;address&lt;\/th&gt;\n      &lt;th&gt;room&lt;\/th&gt;\n      &lt;th&gt;latitude&lt;\/th&gt;\n      &lt;th&gt;longitude&lt;\/th&gt;\n      &lt;th&gt;rent&lt;\/th&gt;\n      &lt;th&gt;charges&lt;\/th&gt;\n    &lt;\/tr&gt;\n  &lt;\/thead&gt;\n&lt;\/table&gt;&#34;,&#34;options&#34;:{&#34;pageLength&#34;:5,&#34;dom&#34;:&#34;tpi&#34;,&#34;columnDefs&#34;:[{&#34;className&#34;:&#34;dt-right&#34;,&#34;targets&#34;:[2,3,4,5,6]}],&#34;order&#34;:[],&#34;autoWidth&#34;:false,&#34;orderClasses&#34;:false,&#34;lengthMenu&#34;:[5,10,25,50,100]}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;visualize-the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Visualize the data&lt;/h2&gt;
&lt;div id=&#34;looking-at-bivariate-relationship&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Looking at bivariate relationship&lt;/h3&gt;
&lt;p&gt;We can check if rent and charges seem to be correlated.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(ggplot2))
suppressMessages(library(hrbrthemes))

offers %&amp;gt;% ggplot(aes(x=rent, y=charges)) + 
  geom_jitter(alpha=0.5) +
  geom_smooth(method = &amp;quot;lm&amp;quot;, size=0.5, se = F, color=&amp;quot;black&amp;quot;) + 
  annotate(geom=&amp;quot;label&amp;quot;, x=max(offers$rent), y=min(offers$charges),
           label=paste(&amp;quot;r(rent, charge) =&amp;quot;, round(cor(offers$rent, offers$charges), 3)), 
           hjust=1, fill=&amp;quot;black&amp;quot;, alpha=&amp;quot;0.5&amp;quot;, color=&amp;quot;white&amp;quot;) +
  labs(title=stringr::str_to_title(&amp;quot;Do charges go up with rent?&amp;quot;),
       subtitle=&amp;quot;There seems to be a positive linear relationship between rent and charges.&amp;quot;) +
  theme_ipsum_rc()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/1703311-scrape-a-list-of-rental-offers-using-rvest-and-purrr_files/figure-html/unnamed-chunk-9-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;seeing-the-results-on-a-map&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Seeing the results on a map&lt;/h3&gt;
&lt;p&gt;Lastly, because latitude and longitude were so easily obtained, we can pin each flat on a leaflet map.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;suppressMessages(library(leaflet))

m &amp;lt;- leaflet(offers) %&amp;gt;%
  addProviderTiles(&amp;quot;CartoDB.Positron&amp;quot;) %&amp;gt;%
  addMarkers(lng=~longitude,
             lat=~latitude,
             popup=offers$address)
m&lt;/code&gt;&lt;/pre&gt;
&lt;div id=&#34;htmlwidget-3&#34; style=&#34;width:672px;height:480px;&#34; class=&#34;leaflet html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-3&#34;&gt;{&#34;x&#34;:{&#34;options&#34;:{&#34;crs&#34;:{&#34;crsClass&#34;:&#34;L.CRS.EPSG3857&#34;,&#34;code&#34;:null,&#34;proj4def&#34;:null,&#34;projectedBounds&#34;:null,&#34;options&#34;:{}}},&#34;calls&#34;:[{&#34;method&#34;:&#34;addProviderTiles&#34;,&#34;args&#34;:[&#34;CartoDB.Positron&#34;,null,null,{&#34;errorTileUrl&#34;:&#34;&#34;,&#34;noWrap&#34;:false,&#34;zIndex&#34;:null,&#34;unloadInvisibleTiles&#34;:null,&#34;updateWhenIdle&#34;:null,&#34;detectRetina&#34;:false,&#34;reuseTiles&#34;:false}]},{&#34;method&#34;:&#34;addMarkers&#34;,&#34;args&#34;:[[46.2110823,46.2172471,46.1956311,46.2123577,46.2139829,46.2299972,46.2049398,46.1945565,46.1929323,46.2936297,46.1874919,46.1964161,46.1754533,46.2068797,46.2167452,46.1976599,46.220471,46.2001689,46.2061894,46.1976599,46.1976599],[6.1399174,6.1377483,6.191422,6.1452134,6.1246849,6.1177381,6.1315508,6.1424891,6.2037003,6.1646624,6.1405418,6.190808,6.11947,6.1320354,6.1316818,6.1462625,6.1325586,6.1723494,6.1306914,6.1462625,6.1462625],null,null,null,{&#34;clickable&#34;:true,&#34;draggable&#34;:false,&#34;keyboard&#34;:true,&#34;title&#34;:&#34;&#34;,&#34;alt&#34;:&#34;&#34;,&#34;zIndexOffset&#34;:0,&#34;opacity&#34;:1,&#34;riseOnHover&#34;:false,&#34;riseOffset&#34;:250},[&#34;Rue de la Faucille 12&#34;,&#34;Rue du Vidollet 18&#34;,&#34;Rue de Chêne-Bougeries 40&#34;,&#34;42, rue de Zürich&#34;,&#34;Avenue De-Luserna 36&#34;,&#34;Chemin Taverney 6&#34;,&#34;Rue du Belvédère 8&#34;,&#34;Rue Henri-ChristinÃ© 6&#34;,&#34;Rue de GenÃ¨ve 123 A&#34;,&#34;Grand-Montfleury 30&#34;,&#34;Place de l&#39;Octroi 13&#34;,&#34;Rue de ChÃªne-Bougeries 29&#34;,&#34;Chemin des Palettes 29&#34;,&#34;Rue Cavour 9&#34;,&#34;Avenue Giuseppe-Motta 16&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Maurice-Braillard 16&#34;,&#34;Route de ChÃªne 53&#34;,&#34;Rue Charles-Giron 1&#34;,&#34;Rue Saint-LÃ©ger 8&#34;,&#34;Rue Saint-LÃ©ger 8&#34;],null,null,null,null,null,null]}],&#34;limits&#34;:{&#34;lat&#34;:[46.1754533,46.2936297],&#34;lng&#34;:[6.1177381,6.2037003]}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;ressources&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Ressources&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hadley/rvest&#34;&gt;Homepage for rvest repo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://stat4701.github.io/edav/2015/04/02/rvest_tutorial/&#34;&gt;Tutorial explaining rvest basics&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>